<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>smart properties system ¬∑ details</title>

  <link rel="preconnect" href="https://script.google.com">
  <link rel="preconnect" href="https://lh3.googleusercontent.com">

  <style>
    :root{
      --bg:#a8bdd6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7c93;
      --radius:22px;
      --shadow: 0 12px 30px rgba(0,0,0,.12);
      --soft:#f3f6fb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Thai", sans-serif;
      background: radial-gradient(ellipse at top, rgba(255,255,255,.25), rgba(255,255,255,0) 55%) , var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:16px 14px 30px;}

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.18);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:44px; height:44px; border-radius:999px; background:rgba(255,255,255,.55);
      display:grid; place-items:center; font-weight:800;
    }
    .titles h1{margin:0; font-size:26px; line-height:1.1; font-weight:1000;}
    .titles .sub{color:rgba(15,23,42,.7); font-weight:700; margin-top:2px;}
    .backBtn{
      width:44px; height:44px; border-radius:999px;
      border:0; background: rgba(255,255,255,.55);
      cursor:pointer; font-size:18px; font-weight:900;
    }

    .card{
      margin-top:14px;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(255,255,255,.65);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Gallery */
    .gallery{
      position:relative;
      background:#dfe9f6;
    }
    .mainSlide{
      width:100%;
      aspect-ratio: 16/10;
      object-fit:cover;
      display:block;
    }
    .tagTopLeft, .tagTopRight, .tagBottomRight{
      position:absolute;
      padding:10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.78);
      font-weight:1000;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
      backdrop-filter: blur(8px);
    }
    .tagTopLeft{left:14px; top:14px;}
    .tagTopRight{right:14px; top:14px;}
    .tagBottomRight{right:14px; bottom:14px; font-size:20px;}

    .thumbStrip{
      background: rgba(255,255,255,.78);
      padding:10px;
      display:flex;
      gap:10px;
      overflow:auto;
      scroll-snap-type: x mandatory;
    }
    .thumb{
      width:92px; height:64px;
      flex:0 0 auto;
      border-radius: 16px;
      object-fit:cover;
      border:3px solid transparent;
      cursor:pointer;
      scroll-snap-align: start;
      background:#e8f0fb;
    }
    .thumb.active{border-color:#0f172a;}

    .content{padding:14px;}
    .headRow{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .hp{font-size:34px; font-weight:1100; letter-spacing:.3px;}
    .price{font-size:28px; font-weight:1100;}
    .gridInfo{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media(min-width:900px){
      .gridInfo{grid-template-columns: repeat(3, 1fr);}
    }
    .infoBox{
      background: rgba(15,23,42,.05);
      border:1px solid rgba(15,23,42,.06);
      border-radius: 18px;
      padding:12px 12px;
      display:flex; justify-content:space-between; gap:10px;
      font-weight:1000;
    }
    .k{color:rgba(15,23,42,.55); font-weight:900;}
    .v{color:rgba(15,23,42,.95); font-weight:1100; text-align:right;}

    .errorBox{
      margin-top:14px;
      padding:14px;
      border-radius: 18px;
      background: rgba(255,255,255,.7);
      border:1px solid rgba(255,255,255,.65);
      font-weight:1000;
      color:#8b1d1d;
      display:none;
    }
    .skeleton{
      background: linear-gradient(90deg, rgba(255,255,255,.55), rgba(255,255,255,.25), rgba(255,255,255,.55));
      background-size: 200% 100%;
      animation: shimmer 1.2s infinite linear;
    }
    @keyframes shimmer{
      0%{background-position: 200% 0;}
      100%{background-position: -200% 0;}
    }

    /* =========================================================
       ‚úÖ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: LOADING OVERLAY (‡∏î‡∏∏‡πä‡∏Å‡∏î‡∏¥‡πä‡∏Å) ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Index
       - background ‡πÄ‡∏î‡∏¥‡∏°
       - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Smart Properties System
       ========================================================= */
    .pageLoader{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(ellipse at top, rgba(255,255,255,.25), rgba(255,255,255,0) 55%) , var(--bg);
      z-index:99999;
    }
    .loaderInner{
      text-align:center;
      padding:18px 18px;
    }
    .loaderEmojis{
      display:flex;
      gap:18px;
      justify-content:center;
      align-items:center;
      font-size:52px;
      line-height:1;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.18));
    }
    .loaderEmojis span{
      display:inline-block;
      animation: bounce 0.9s ease-in-out infinite;
    }
    .loaderEmojis span:nth-child(2){ animation-delay: .12s; }
    .loaderEmojis span:nth-child(3){ animation-delay: .24s; }
    @keyframes bounce{
      0%,100%{ transform: translateY(0); opacity:.95; }
      50%{ transform: translateY(-12px); opacity:1; }
    }
    .loaderText{
      margin-top:14px;
      font-weight:1100;
      letter-spacing:1px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 10px 22px rgba(0,0,0,.22);
      font-size:28px;
      white-space:nowrap;
    }
    @media (max-width:420px){
      .loaderEmojis{font-size:44px}
      .loaderText{font-size:22px}
    }

    /* =========================================================
       ‚úÖ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á ‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤ ‡πÉ‡∏ô‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°‡∏£‡∏π‡∏õ
       ========================================================= */
    .navArrow{
      position:absolute;
      top:50%;
      transform: translateY(-50%);
      width:54px;
      height:54px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.55);
      background: rgba(255,255,255,.22);
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      z-index:5; /* ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏£‡∏π‡∏õ */
    }
    .navArrow:active{ transform: translateY(-50%) scale(.98); }
    .navArrow svg{
      width:24px;height:24px;
      stroke: rgba(255,255,255,.95);
      opacity:.95;
    }
    .navLeft{ left:14px; }
    .navRight{ right:14px; }
    /* ‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏°‡∏≤‡∏Å ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î */
    @media (max-width:420px){
      .navArrow{ width:48px;height:48px; }
      .navArrow svg{ width:22px;height:22px; }
    }
  </style>
</head>
<body>

  <!-- ‚úÖ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: Loading overlay -->
  <div class="pageLoader" id="pageLoader" aria-label="loading">
    <div class="loaderInner">
      <div class="loaderEmojis" aria-hidden="true">
        <span>üè†</span><span>‚ú®</span><span>üå¥</span>
      </div>
      <div class="loaderText">Smart Properties System</div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">SP</div>
        <div class="titles">
          <h1>smart properties system</h1>
          <div class="sub" id="subTitle">Details ¬∑ ...</div>
        </div>
      </div>
      <button class="backBtn" id="btnBack">‚Üê</button>
    </div>

    <div class="errorBox" id="errBox"></div>

    <div class="card" id="mainCard">
      <div class="gallery" id="gallery">
        <img class="mainSlide skeleton" id="mainImg" alt="main" />
        <div class="tagTopLeft" id="tagPlot">-</div>
        <div class="tagTopRight" id="tagStatus">-</div>
        <div class="tagBottomRight" id="tagCount">0 / 0</div>

        <!-- ‚úÖ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á -->
        <div class="navArrow navLeft" id="btnPrev" aria-label="previous">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 18l-6-6 6-6"></path>
          </svg>
        </div>
        <div class="navArrow navRight" id="btnNext" aria-label="next">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 6l6 6-6 6"></path>
          </svg>
        </div>
      </div>

      <div class="thumbStrip" id="thumbStrip"></div>

      <div class="content">
        <div class="headRow">
          <div class="hp" id="hpText">...</div>
          <div class="price" id="priceText">‡∏ø0</div>
        </div>

        <div class="gridInfo" id="infoGrid">
          <!-- info -->
        </div>
      </div>
    </div>
  </div>

<script>
/** =========================
 * CONFIG
 * ========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvzszMpjb1Dy3nQDhh64oPYu1-CgL-RSdRe52Df_pejfqkhq-g70z96npgaSyNAw2T/exec";
const qs = new URLSearchParams(location.search);
const hpId = qs.get("id") || qs.get("hpId") || "";
const project = qs.get("project") || "Project_0";

/** ‚úÖ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: loader helpers */
function showLoader(){
  const el = document.getElementById("pageLoader");
  if(el) el.style.display = "flex";
}
function hideLoader(){
  const el = document.getElementById("pageLoader");
  if(el) el.style.display = "none";
}

/** JSONP */
function jsonp(url, timeoutMs = 20000){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const script = document.createElement("script");
    const timer = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, timeoutMs);

    function cleanup(){
      clearTimeout(timer);
      if (script.parentNode) script.parentNode.removeChild(script);
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
    }
    window[cb] = (data) => { cleanup(); resolve(data); };

    const sep = url.includes("?") ? "&" : "?";
    script.src = url + sep + "callback=" + encodeURIComponent(cb);
    script.onerror = () => { cleanup(); reject(new Error("jsonp_error")); };
    document.body.appendChild(script);
  });
}

function showError(msg){
  const box = document.getElementById("errBox");
  box.style.display = "block";
  box.textContent = msg;
}
function hideError(){
  const box = document.getElementById("errBox");
  box.style.display = "none";
  box.textContent = "";
}

function toNumber(x){
  const s = String(x ?? "").replace(/,/g,"").trim();
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function moneyTHB(x){
  const n = toNumber(x);
  return "‡∏ø" + n.toLocaleString("en-US");
}
function cleanDriveImage(url){
  const u = String(url || "").trim();
  if(!u) return "";
  if (u.includes("lh3.googleusercontent.com/d/")) return u;

  let id = "";
  const m1 = u.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if (m1) id = m1[1];
  const m2 = u.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if (!id && m2) id = m2[1];
  const m3 = u.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
  if (!id && m3) id = m3[1];

  if (id) return "https://lh3.googleusercontent.com/d/" + id;
  return u;
}

document.getElementById("btnBack").addEventListener("click", () => {
  history.length > 1 ? history.back() : (location.href = "index.html");
});

let images = [];
let idx = 0;

function setMain(i){
  idx = Math.max(0, Math.min(i, images.length-1));
  const mainImg = document.getElementById("mainImg");
  mainImg.classList.remove("skeleton");
  mainImg.src = images[idx] || mainImg.src;

  document.getElementById("tagCount").textContent = `${idx+1} / ${images.length || 0}`;
  // active thumb
  document.querySelectorAll(".thumb").forEach((t, k)=>{
    t.classList.toggle("active", k===idx);
  });
}

function renderThumbs(){
  const strip = document.getElementById("thumbStrip");
  strip.innerHTML = "";
  images.forEach((src, i)=>{
    const im = document.createElement("img");
    im.className = "thumb" + (i===idx ? " active": "");
    im.src = src;
    im.loading = "lazy";
    im.decoding = "async";
    im.addEventListener("click", ()=>setMain(i));
    strip.appendChild(im);
  });
}

function enableSwipe(){
  const gallery = document.getElementById("gallery");
  let startX = 0, dx = 0;

  gallery.addEventListener("touchstart", (e)=>{
    startX = e.touches[0].clientX;
    dx = 0;
  }, {passive:true});

  gallery.addEventListener("touchmove", (e)=>{
    dx = e.touches[0].clientX - startX;
  }, {passive:true});

  gallery.addEventListener("touchend", ()=>{
    if(Math.abs(dx) < 35) return;
    if(dx < 0) setMain(idx+1);
    else setMain(idx-1);
  });
}

function renderInfo(detail){
  const grid = document.getElementById("infoGrid");
  const safe = (v)=> (v===undefined || v===null || String(v).trim()==="" ? "-" : String(v));

  const items = [
    ["Project", safe(detail.Project || detail.Project_Name || project)],
    ["HP_ID", safe(detail.HP_ID || hpId)],
    ["Plot", safe(detail.Plot)],
    ["Type", safe(detail.Type)],
    ["Bedrooms", safe(detail.Bedrooms)],
    ["Bathrooms", safe(detail.Bathrooms)],
    ["Living_Area_sq_m", safe(detail.Living_Area_sq_m)],
    ["Land_Area_sq_w", safe(detail.Land_Area_sq_w)],
    ["Status", safe(detail.Status)],
    ["Badge", safe(detail.Badge)],
    ["Address", safe(detail.Address)],
  ];

  grid.innerHTML = "";
  for(const [k,v] of items){
    const box = document.createElement("div");
    box.className = "infoBox";
    box.innerHTML = `<div class="k">${k}</div><div class="v">${v}</div>`;
    grid.appendChild(box);
  }
}

/** LOAD */
(async function init(){
  hideError();
  showLoader(); // ‚úÖ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏ä‡∏ß‡πå loader

  if(!hpId){
    showError("‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ‡πÑ‡∏°‡πà‡∏°‡∏µ id ‡πÄ‡∏ä‡πà‡∏ô details.html?id=HP-Z001");
    hideLoader();
    return;
  }

  document.getElementById("subTitle").textContent = `Details ¬∑ ${hpId}`;

  const url = `${SCRIPT_URL}?mode=getUnitDetail&project=${encodeURIComponent(project)}&hpId=${encodeURIComponent(hpId)}`;

  let detail;
  try{
    detail = await jsonp(url);
  }catch(err){
    showError("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à Deploy Apps Script ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Anyone ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ /exec)");
    hideLoader();
    return;
  }

  if(detail && detail.error){
    showError("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + detail.error);
    hideLoader();
    return;
  }

  // ‚úÖ ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å + ‡∏£‡∏π‡∏õ‡πÉ‡∏ô Image_List
  const thumb = cleanDriveImage(detail.Thumbnail_Image || "");
  const list = String(detail.Image_List || "")
    .split(",").map(s=>cleanDriveImage(s.trim()))
    .filter(Boolean);

  images = (thumb ? [thumb, ...list.filter(x=>x!==thumb)] : list);

  if(!images.length){
    images = ["data:image/svg+xml;charset=utf-8," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='800'><rect width='100%' height='100%' fill='#e6edf6'/><text x='50%' y='50%' text-anchor='middle' fill='#8aa0bb' font-size='40' font-family='Arial'>no image</text></svg>`)];
  }

  // header
  document.getElementById("hpText").textContent = detail.HP_ID || hpId;
  document.getElementById("priceText").textContent = moneyTHB(detail.Price || 0);
  document.getElementById("tagPlot").textContent = detail.Plot || "-";
  document.getElementById("tagStatus").textContent = detail.Status || "Available";

  // render gallery
  const mainImg = document.getElementById("mainImg");

  // ‚úÖ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: ‡∏ã‡πà‡∏≠‡∏ô loader ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏£‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à/‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á)
  mainImg.onload = () => { hideLoader(); };
  mainImg.onerror = () => { hideLoader(); };

  mainImg.src = images[0];
  mainImg.classList.remove("skeleton");

  renderThumbs();
  setMain(0);
  enableSwipe();

  // ‚úÖ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤
  document.getElementById("btnPrev").addEventListener("click", ()=> setMain(idx-1));
  document.getElementById("btnNext").addEventListener("click", ()=> setMain(idx+1));

  // preload next image for speed
  if(images[1]){
    const pre = new Image();
    pre.src = images[1];
  }

  renderInfo(detail);
})();
</script>
</body>
</html>
