<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PROPERTY DETAIL</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Kanit', sans-serif; background: #f8fafc; }
    .price-text { font-size: clamp(2.2rem, 6vw, 3.6rem); font-weight: 600; letter-spacing: -0.02em; line-height: 1.05; }
    .chip { font-size: 0.9rem; font-weight: 500; padding: .55rem .9rem; border-radius: 999px; }
    .feature { font-size: .95rem; font-weight: 500; padding: .65rem .85rem; border-radius: 1rem; }
  </style>
</head>

<body class="p-4 md:p-10">
  <div class="max-w-6xl mx-auto">

    <!-- TOP -->
    <div class="flex items-start justify-between gap-4 mb-6">
      <div class="min-w-0">
        <div id="titleLine" class="text-3xl md:text-5xl font-semibold italic text-slate-900 truncate">Loading...</div>
        <div id="subLine" class="text-slate-400 mt-2 text-sm md:text-base">‚Äî</div>
      </div>

      <div class="flex items-center gap-3 shrink-0">
        <a id="backBtn" href="index.html" class="w-14 h-14 rounded-2xl bg-white shadow flex items-center justify-center text-xl active:scale-95">‚Üê</a>
        <a id="homeBtn" href="index.html" class="w-14 h-14 rounded-2xl bg-slate-900 text-white shadow flex items-center justify-center text-xl active:scale-95">‚åÇ</a>
      </div>
    </div>

    <!-- LOADING -->
    <div id="loading" class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-100 p-10 text-center text-slate-300 font-bold animate-pulse uppercase">
      üîÑ Loading property detail...
    </div>

    <!-- CONTENT -->
    <div id="content" class="hidden space-y-6">

      <!-- HERO -->
      <div class="bg-white rounded-[2.7rem] shadow-2xl border border-slate-100 overflow-hidden">
        <div class="relative">
          <img id="heroImg" src="" class="w-full h-[22rem] md:h-[28rem] object-cover cursor-pointer" alt="hero">

          <!-- Plot -->
          <div id="plotPill" class="absolute top-4 left-4 bg-white/90 px-4 py-2 rounded-full font-semibold shadow">
            -
          </div>

          <!-- Status -->
          <div id="statusPill" class="absolute top-4 right-4 chip bg-emerald-100 text-emerald-700 shadow">
            Available
          </div>

          <!-- Count -->
          <div id="countPill" class="absolute bottom-4 right-4 bg-white/90 px-4 py-2 rounded-full font-semibold shadow">
            0 Photos
          </div>

          <!-- thumbnails strip -->
          <div class="bg-white/95 backdrop-blur border-t border-slate-100 p-4">
            <div id="thumbStrip" class="flex gap-3 overflow-x-auto pb-1"></div>
          </div>
        </div>

        <div class="p-6 md:p-8 space-y-5">
          <div class="flex flex-wrap gap-2 items-center">
            <div id="badgePill" class="chip bg-violet-100 text-violet-700">Badge: -</div>
            <div id="sysPill" class="chip bg-slate-100 text-slate-700">System: -</div>
            <div id="updatedPill" class="text-slate-400 font-semibold">Updated: -</div>
          </div>

          <div id="price" class="price-text text-slate-900">‡∏ø0</div>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div class="feature bg-slate-50 border border-slate-100">üõè <span id="bed">-</span></div>
            <div class="feature bg-slate-50 border border-slate-100">üõÅ <span id="bath">-</span></div>
            <div class="feature bg-slate-50 border border-slate-100">üìê <span id="land">-</span> sq.w</div>
            <div class="feature bg-slate-50 border border-slate-100">üè† <span id="living">-</span> sqm</div>
          </div>

          <div id="descBlock" class="bg-slate-50 border border-slate-100 rounded-[2rem] p-6 text-slate-700 leading-relaxed">
            ‚Äî
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <a id="mapBtn" class="hidden text-center bg-white border border-slate-200 rounded-2xl py-4 font-bold text-slate-800 hover:bg-slate-50">
              üìç OPEN MAP
            </a>
            <a id="vrBtn" class="hidden text-center bg-slate-900 text-white rounded-2xl py-4 font-bold hover:bg-slate-800">
              üåÄ VIRTUAL TOUR
            </a>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- LIGHTBOX -->
  <div id="lightbox" class="hidden fixed inset-0 z-50 bg-slate-950/80 backdrop-blur-sm">
    <div class="w-full h-full flex items-center justify-center p-4">
      <div class="relative w-full max-w-5xl">
        <button id="lbClose" class="absolute -top-4 right-0 md:right-2 w-12 h-12 rounded-2xl bg-white text-slate-900 shadow flex items-center justify-center text-xl active:scale-95">‚úï</button>

        <!-- image -->
        <div class="bg-white rounded-[2.5rem] overflow-hidden shadow-2xl border border-white/20">
          <div class="relative">
            <img id="lbImg" src="" class="w-full max-h-[78vh] object-contain bg-slate-900">

            <!-- arrows (‡πÄ‡∏Ç‡πâ‡∏≤‡∏ò‡∏µ‡∏°) -->
            <button id="lbPrev" class="absolute left-4 top-1/2 -translate-y-1/2 w-14 h-14 rounded-2xl bg-white/90 hover:bg-white text-slate-900 shadow flex items-center justify-center text-2xl active:scale-95">
              ‚Äπ
            </button>
            <button id="lbNext" class="absolute right-4 top-1/2 -translate-y-1/2 w-14 h-14 rounded-2xl bg-white/90 hover:bg-white text-slate-900 shadow flex items-center justify-center text-2xl active:scale-95">
              ‚Ä∫
            </button>

            <div id="lbCounter" class="absolute bottom-4 left-4 bg-white/90 px-4 py-2 rounded-full font-semibold shadow">
              1 / 1
            </div>
          </div>
        </div>

        <div class="mt-3 text-center text-white/80 text-sm">Swipe/Click arrows to navigate</div>
      </div>
    </div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwvCiaEKxvRI9rQCXMR_F4SHqmkJT4CnAuoVgEr6RYACmfgKerp7r06m-ltBMu4GFD4/exec";
  const qs = new URLSearchParams(location.search);
  const project = qs.get("project") || "Project_0";
  const id = qs.get("id") || qs.get("hpId") || "";

  // links
  document.getElementById("backBtn").href = `index.html?project=${encodeURIComponent(project)}`;
  document.getElementById("homeBtn").href = `index.html?project=${encodeURIComponent(project)}`;

  const priceFmt = v => {
    const n = Number(v);
    return (!n || n === 0) ? "‡∏ø0" : "‡∏ø" + n.toLocaleString();
  };

  const statusClass = s => {
    s = String(s || "").toLowerCase();
    if (s.includes("available")) return "bg-emerald-100 text-emerald-700";
    if (s.includes("under")) return "bg-sky-100 text-sky-700";
    if (s.includes("reserved")) return "bg-amber-100 text-amber-700";
    if (s.includes("sold")) return "bg-rose-100 text-rose-700";
    return "bg-slate-100 text-slate-700";
  };

  // gallery state
  let gallery = [];
  let currentIndex = 0;

  function setHero(i) {
    if (!gallery.length) return;
    currentIndex = (i + gallery.length) % gallery.length;
    document.getElementById("heroImg").src = gallery[currentIndex];
    document.getElementById("countPill").textContent = `${gallery.length} Photos`;
  }

  function renderThumbStrip() {
    const strip = document.getElementById("thumbStrip");
    if (!gallery.length) {
      strip.innerHTML = `<div class="text-slate-400 font-semibold">No gallery photos</div>`;
      return;
    }

    strip.innerHTML = gallery.map((url, idx) => `
      <button class="shrink-0 rounded-2xl overflow-hidden border ${idx===currentIndex ? "border-slate-900" : "border-slate-100"} bg-slate-50"
        onclick="window.__pick(${idx})"
        title="View">
        <img src="${url}" class="w-24 h-20 object-cover">
      </button>
    `).join("");
  }

  window.__pick = (idx) => {
    setHero(idx);
    renderThumbStrip();
  };

  // lightbox
  const lb = document.getElementById("lightbox");
  const lbImg = document.getElementById("lbImg");
  const lbCounter = document.getElementById("lbCounter");

  function openLightbox(idx) {
    if (!gallery.length) return;
    currentIndex = idx;
    lb.classList.remove("hidden");
    updateLightbox();
  }

  function closeLightbox() {
    lb.classList.add("hidden");
  }

  function updateLightbox() {
    lbImg.src = gallery[currentIndex];
    lbCounter.textContent = `${currentIndex + 1} / ${gallery.length}`;
  }

  function prev() {
    currentIndex = (currentIndex - 1 + gallery.length) % gallery.length;
    updateLightbox();
  }

  function next() {
    currentIndex = (currentIndex + 1) % gallery.length;
    updateLightbox();
  }

  document.getElementById("lbClose").addEventListener("click", closeLightbox);
  document.getElementById("lbPrev").addEventListener("click", prev);
  document.getElementById("lbNext").addEventListener("click", next);

  // click outside close
  lb.addEventListener("click", (e) => {
    if (e.target === lb) closeLightbox();
  });

  // hero click -> open lightbox
  document.getElementById("heroImg").addEventListener("click", () => openLightbox(currentIndex));

  // keyboard on desktop
  window.addEventListener("keydown", (e) => {
    if (lb.classList.contains("hidden")) return;
    if (e.key === "Escape") closeLightbox();
    if (e.key === "ArrowLeft") prev();
    if (e.key === "ArrowRight") next();
  });

  async function load() {
    if (!id) {
      document.getElementById("loading").textContent = "‚ö†Ô∏è Missing id";
      return;
    }

    const res = await fetch(`${API_URL}?mode=getUnitDetail&project=${encodeURIComponent(project)}&hpId=${encodeURIComponent(id)}&t=${Date.now()}`);
    const d = await res.json();

    if (d.error) {
      document.getElementById("loading").textContent = "‚ö†Ô∏è " + d.error;
      return;
    }

    // data
    const plot = d.Plot || "-";
    const status = d.Status || "-";
    const badge = d.Badge || "-";
    const sys = d.System_Status || "-";
    const updated = d.Last_Updated || "-";

    const thumb = d.Thumbnail_Image || "";
    const list = String(d.Image_List || "").split(",").map(s => s.trim()).filter(Boolean);

    gallery = (list.length ? list : (thumb ? [thumb] : []));

    // title
    document.getElementById("titleLine").textContent = `UNIT ${id} ‚Ä¢ ${plot}`;
    document.getElementById("subLine").textContent = `Project: ${project} ‚Ä¢ Unit: ${id}`;

    // pills
    document.getElementById("plotPill").textContent = plot;
    const st = document.getElementById("statusPill");
    st.className = `absolute top-4 right-4 chip shadow ${statusClass(status)}`;
    st.textContent = status;

    document.getElementById("badgePill").textContent = `Badge: ${badge}`;
    document.getElementById("sysPill").textContent = `System: ${sys}`;
    document.getElementById("updatedPill").textContent = `Updated: ${updated}`;

    // numbers
    document.getElementById("price").textContent = priceFmt(d.Price || d.Price_SQM || 0);
    document.getElementById("bed").textContent = d.Bedrooms || "-";
    document.getElementById("bath").textContent = d.Bathrooms || "-";
    document.getElementById("land").textContent = d.Land_Area_sq_w || "-";
    document.getElementById("living").textContent = d.Living_Area_sq_m || "-";

    // description
    document.getElementById("descBlock").textContent = d.Description || "‚Äî";

    // map / virtual
    const map = d.Map_Link || "";
    const vr = d.Virtual_Tour || "";
    if (map) {
      const a = document.getElementById("mapBtn");
      a.href = map;
      a.target = "_blank";
      a.rel = "noopener";
      a.classList.remove("hidden");
    }
    if (vr) {
      const a = document.getElementById("vrBtn");
      a.href = vr;
      a.target = "_blank";
      a.rel = "noopener";
      a.classList.remove("hidden");
    }

    // hero image
    document.getElementById("heroImg").src = gallery[0] || "https://via.placeholder.com/1200x800?text=No+Image";
    document.getElementById("countPill").textContent = `${gallery.length} Photos`;
    currentIndex = 0;
    renderThumbStrip();

    // show
    document.getElementById("loading").classList.add("hidden");
    document.getElementById("content").classList.remove("hidden");
  }

  load();
</script>
</body>
</html>
