<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>smart properties system ¬∑ details</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700;800&family=Noto+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --line-bg:#8fb2d9;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(15,23,42,.10);
      --shadow:0 10px 30px rgba(2,6,23,.08);
      --green:#06c755;
      --green-d:#05b24c;
      --pill:#eef2f7;
      --chip:#f1f5f9;
      --radius:22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Noto Sans Thai","Noto Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:var(--line-bg);
      overflow-x:hidden;
    }

    body::before{
      content:"";
      position:fixed; inset:0;
      background:
        radial-gradient(120px 70px at 12% 28%, rgba(255,255,255,.18) 0 60%, rgba(255,255,255,0) 61%),
        radial-gradient(140px 80px at 23% 30%, rgba(255,255,255,.18) 0 58%, rgba(255,255,255,0) 59%),
        radial-gradient(120px 70px at 32% 28%, rgba(255,255,255,.18) 0 60%, rgba(255,255,255,0) 61%),
        radial-gradient(140px 80px at 72% 58%, rgba(255,255,255,.14) 0 58%, rgba(255,255,255,0) 59%),
        radial-gradient(160px 90px at 82% 60%, rgba(255,255,255,.14) 0 58%, rgba(255,255,255,0) 59%),
        radial-gradient(140px 80px at 92% 58%, rgba(255,255,255,.14) 0 58%, rgba(255,255,255,0) 59%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,0) 55%);
      pointer-events:none;
      z-index:-1;
    }

    .topbar{
      position:sticky; top:0;
      padding:12px 14px calc(10px + env(safe-area-inset-top));
      display:flex; align-items:center; gap:10px;
      background:rgba(15,23,42,.18);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.18);
    }
    .iconbtn{
      width:40px; height:40px; border-radius:14px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.70);
      display:grid; place-items:center;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.10);
      user-select:none;
      flex:0 0 auto;
    }
    .iconbtn:active{transform:translateY(1px)}
    .iconbtn svg{width:20px;height:20px;opacity:.85}

    .titlewrap{flex:1; min-width:0}
    .title{
      font-size:16px; font-weight:900; line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      text-transform:lowercase;
      color:white;
    }
    .subtitle{
      font-size:12px; font-weight:800;
      color:rgba(255,255,255,.85);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .wrap{max-width:1200px; margin:0 auto; padding:14px 14px 26px}

    /* ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 3: ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå / ‡∏Ñ‡∏≠‡∏° 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
    .layout{
      display:grid;
      grid-template-columns:1fr;
      gap:14px;
    }
    @media (min-width:1024px){
      .layout{grid-template-columns: 1.2fr .8fr;}
    }

    .panel{
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.55);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .hero{
      position:relative;
      background:#e5e7eb;
      aspect-ratio: 16/9;
      width:100%;
      overflow:hidden;
    }
    .hero img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .heroBadge{
      position:absolute; left:12px; top:12px;
      background:rgba(255,255,255,.88);
      border:1px solid rgba(15,23,42,.10);
      padding:6px 10px;
      border-radius:999px;
      font-weight:950; font-size:12px;
      backdrop-filter: blur(8px);
    }

    .thumbs{
      display:flex;
      gap:10px;
      padding:12px;
      overflow:auto;
      border-top:1px solid rgba(15,23,42,.06);
      background:rgba(255,255,255,.70);
    }
    .thumbBtn{
      width:88px; height:56px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      overflow:hidden;
      flex:0 0 auto;
      padding:0;
      background:#e5e7eb;
      cursor:pointer;
    }
    .thumbBtn img{width:100%; height:100%; object-fit:cover; display:block}

    .pad{padding:14px}
    .h1{font-size:20px; font-weight:950; margin:0}
    .price{font-size:22px; font-weight:950; margin:6px 0 0}
    .muted{color:var(--muted); font-weight:800}

    .chips{margin-top:10px; display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      background:var(--chip);
      border:1px solid var(--border);
      border-radius:999px;
      padding:7px 10px;
      font-weight:900;
      font-size:13px;
      display:inline-flex; align-items:center; gap:6px;
    }

    .sectionTitle{margin:14px 0 8px; font-weight:950}
    .kv{display:grid; grid-template-columns: 1fr; gap:10px}
    .kv .row{
      display:flex; justify-content:space-between; gap:10px;
      padding:10px 12px;
      background:rgba(15,23,42,.04);
      border:1px solid rgba(15,23,42,.08);
      border-radius:16px;
      font-weight:800;
    }
    .kv .k{color:var(--muted)}
    .kv .v{text-align:right; color:var(--text)}

    .btnRow{display:flex; gap:10px; margin-top:14px}
    .btn{
      flex:1;
      border:none;
      border-radius:16px;
      padding:12px 14px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btnGreen{background:var(--green); color:white}
    .btnGreen:hover{background:var(--green-d)}
    .btnSoft{background:rgba(15,23,42,.06); color:var(--text); border:1px solid rgba(15,23,42,.10)}

    .loading{
      padding:14px;
      text-align:center;
      color:rgba(255,255,255,.92);
      font-weight:800;
    }
    .spinner{
      width:22px;height:22px;border-radius:50%;
      border:3px solid rgba(255,255,255,.35);
      border-top-color:rgba(255,255,255,.95);
      margin:0 auto 10px;
      animation:spin .9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body>
  <header class="topbar">
    <button class="iconbtn" id="btnBack" title="‡∏Å‡∏•‡∏±‡∏ö">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M15 18l-6-6 6-6"></path>
      </svg>
    </button>

    <div class="titlewrap">
      <div class="title">smart properties system</div>
      <div class="subtitle" id="subTitle">Details</div>
    </div>

    <!-- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1 -->
    <button class="iconbtn" id="btnGateway" title="Gateway">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 21a8 8 0 0 0-16 0"></path>
        <circle cx="12" cy="8" r="4"></circle>
      </svg>
    </button>
    <button class="iconbtn" id="btnEdit" title="Edit">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 20h9"></path>
        <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
      </svg>
    </button>
  </header>

  <main class="wrap">
    <div class="loading" id="loading">
      <div class="spinner"></div>
      ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...
    </div>

    <section class="layout" id="layout" style="display:none;">
      <article class="panel">
        <div class="hero" id="hero">
          <div class="heroBadge" id="heroBadge" style="display:none;"></div>
          <img id="heroImg" alt="main" />
        </div>
        <div class="thumbs" id="thumbs"></div>
      </article>

      <aside class="panel">
        <div class="pad">
          <h1 class="h1" id="unitTitle">-</h1>
          <div class="price" id="unitPrice">-</div>
          <div class="muted" id="unitStatus" style="margin-top:6px;">-</div>

          <div class="chips" id="chips"></div>

          <div class="sectionTitle">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</div>
          <div class="kv" id="kv"></div>

          <div class="btnRow">
            <button class="btn btnGreen" id="btnCopyLink">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
            <button class="btn btnSoft" id="btnShare">‡πÅ‡∏ä‡∏£‡πå</button>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwvCiaEKxvRI9rQCXMR_F4SHqmkJT4CnAuoVgEr6RYACmfgKerp7r06m-ltBMu4GFD4/exec";
    const PROJECT = "Project_0";
    const CACHE_TTL_MS = 5 * 60 * 1000; // ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 4: cache details 5 ‡∏ô‡∏≤‡∏ó‡∏µ

    const $ = (id) => document.getElementById(id);

    function qs(name){
      return new URLSearchParams(location.search).get(name) || "";
    }
    const hpId = qs("id");

    function safeText(v){ return String(v ?? "").replace(/[<>]/g, ""); }

    const fmtPrice = (v) => {
      const n = Number(String(v).replace(/[^0-9.]/g,""));
      if (!isFinite(n)) return v || "";
      return "‡∏ø" + n.toLocaleString("en-US");
    };

    function getCache(key){
      try{
        const raw = sessionStorage.getItem(key);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj || !obj.t || !obj.data) return null;
        if(Date.now() - obj.t > CACHE_TTL_MS) return null;
        return obj.data;
      }catch{ return null; }
    }
    function setCache(key, data){
      try{ sessionStorage.setItem(key, JSON.stringify({ t: Date.now(), data })); }catch{}
    }

    async function fetchDetail(){
      const url = `${GAS_URL}?mode=getUnitDetail&project=${encodeURIComponent(PROJECT)}&hpId=${encodeURIComponent(hpId)}&_=${Date.now()}`;
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error("Fetch failed");
      return await res.json();
    }

    function setHero(src){
      const img = $("heroImg");
      img.src = src || "";
      img.onerror = () => { img.removeAttribute("src"); img.alt = "no image"; };
    }

    function buildThumbs(images){
      const wrap = $("thumbs");
      wrap.innerHTML = "";
      (images || []).forEach((src, idx) => {
        if(!src) return;
        const b = document.createElement("button");
        b.className = "thumbBtn";
        b.type = "button";
        b.innerHTML = `<img loading="lazy" decoding="async" src="${src}" alt="thumb ${idx+1}" />`;
        b.addEventListener("click", ()=> setHero(src));
        wrap.appendChild(b);
      });
    }

    function render(data){
      const id = safeText(data.id || hpId);
      const plot = safeText(data.plot || "");
      const status = safeText(data.status || "");
      const badge = safeText(data.badge || "");
      const price = fmtPrice(data.price);

      $("subTitle").textContent = plot ? `${id} ¬∑ ${plot}` : id;
      $("unitTitle").textContent = plot ? `${id} ¬∑ ${plot}` : id;
      $("unitPrice").textContent = price || "-";
      $("unitStatus").textContent = status || "";

      if(badge){
        $("heroBadge").style.display = "inline-block";
        $("heroBadge").textContent = badge;
      }else{
        $("heroBadge").style.display = "none";
      }

      const chips = [];
      if(data.bedrooms) chips.push(`üõèÔ∏è ${safeText(data.bedrooms)}`);
      if(data.bathrooms) chips.push(`üõÅ ${safeText(data.bathrooms)}`);
      if(data.landSqw) chips.push(`üìê ${safeText(data.landSqw)} sq.w`);
      if(data.livingSqm) chips.push(`üè† ${safeText(data.livingSqm)} sqm`);
      $("chips").innerHTML = chips.map(t => `<span class="chip">${t}</span>`).join("");

      const rows = [
        ["Project", PROJECT],
        ["HP_ID", id],
        ["Plot", plot],
        ["Status", status],
        ["Price", price],
      ].filter(r => r[1]);

      $("kv").innerHTML = rows.map(([k,v]) => `
        <div class="row"><div class="k">${safeText(k)}</div><div class="v">${safeText(v)}</div></div>
      `).join("");

      const images = Array.isArray(data.images) ? data.images : [];
      const main = data.mainImage || images[0] || data.thumbnail || "";
      setHero(main);
      buildThumbs(images.length ? images : (main ? [main] : []));

      $("loading").style.display = "none";
      $("layout").style.display = "grid";

      localStorage.setItem("lastSelectedId", id);
    }

    async function init(){
      if(!hpId){
        $("loading").innerHTML = "‡πÑ‡∏°‡πà‡∏û‡∏ö id ‡πÉ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô details.html?id=HP-0001)";
        return;
      }

      const cacheKey = `unitDetail_${hpId}`;
      const cached = getCache(cacheKey);
      if(cached) {
        render(cached);
        try{
          const fresh = await fetchDetail();
          setCache(cacheKey, fresh);
          render(fresh);
        }catch{}
        return;
      }

      try{
        const data = await fetchDetail();
        setCache(cacheKey, data);
        render(data);
      }catch(e){
        console.warn(e);
        $("loading").innerHTML = "‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
      }
    }

    $("btnBack").addEventListener("click", () => history.length > 1 ? history.back() : location.href="index.html");
    $("btnGateway").addEventListener("click", () => location.href="gateway.html");
    $("btnEdit").addEventListener("click", () => location.href=`edit.html?id=${encodeURIComponent(hpId)}&project=${encodeURIComponent(PROJECT)}`);

    $("btnCopyLink").addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(location.href);
        alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß");
      }catch{
        alert(location.href);
      }
    });

    $("btnShare").addEventListener("click", async () => {
      try{
        if(navigator.share){
          await navigator.share({ title: "Unit " + hpId, url: location.href });
        }else{
          await navigator.clipboard.writeText(location.href);
          alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß");
        }
      }catch{}
    });

    init();
  </script>
</body>
</html>
