<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DIRECT HUB - DETAILS</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Kanit', sans-serif; }
    .price-text { font-size: clamp(2.2rem, 6vw, 3.6rem); font-weight: 600; letter-spacing: -0.02em; line-height: 1.05; }
    .chip { font-size: 0.9rem; font-weight: 500; padding: .55rem .9rem; border-radius: 999px; }
    .feature { font-size: .95rem; font-weight: 500; padding: .65rem .85rem; border-radius: 1rem; }
    .btn:active { transform: scale(.98); }
    .no-select { user-select: none; -webkit-user-select: none; }
    .thumb { width: 92px; height: 64px; object-fit: cover; border-radius: 1rem; cursor: pointer; }
    .thumb-active { outline: 3px solid #0f172a; outline-offset: 2px; }
  </style>
</head>

<body class="bg-slate-50">
  <div class="max-w-6xl mx-auto px-4 py-6 md:py-10">

    <!-- Header -->
    <div class="flex items-start justify-between gap-4 mb-6">
      <div class="min-w-0">
        <div id="titleLine" class="text-3xl md:text-5xl font-semibold italic text-slate-900 truncate">Loading...</div>
        <div id="subLine" class="text-slate-400 mt-2 text-sm md:text-base">â€”</div>
      </div>

      <div class="flex items-center gap-3 shrink-0">
        <a id="backBtn" href="index.html" class="w-14 h-14 rounded-2xl bg-white shadow flex items-center justify-center text-xl btn">â†</a>
        <a id="homeBtn" href="index.html" class="w-14 h-14 rounded-2xl bg-slate-900 text-white shadow flex items-center justify-center text-xl btn">âŒ‚</a>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="bg-white rounded-[2.5rem] shadow-xl border border-slate-100 p-10 text-center text-slate-300 font-bold animate-pulse uppercase">
      ğŸ”„ Loading property details...
    </div>

    <!-- Content -->
    <div id="content" class="hidden space-y-6">

      <!-- Card -->
      <div class="bg-white rounded-[2.7rem] shadow-2xl border border-slate-100 overflow-hidden">

        <!-- HERO -->
        <div class="relative">
          <img id="heroImg" src="" class="w-full h-[22rem] md:h-[28rem] object-cover cursor-pointer no-select" alt="hero">

          <div id="plotPill" class="absolute top-4 left-4 bg-white/90 px-4 py-2 rounded-full font-semibold shadow">-</div>
          <div id="statusPill" class="absolute top-4 right-4 chip bg-emerald-100 text-emerald-700 shadow">-</div>
          <div id="countPill" class="absolute bottom-4 right-4 bg-white/90 px-4 py-2 rounded-full font-semibold shadow">0 Photos</div>

          <!-- âœ… à¸¥à¸¹à¸à¸¨à¸£à¸šà¸™à¸£à¸¹à¸›à¹ƒà¸«à¸à¹ˆ -->
          <button id="heroPrev"
            class="absolute left-4 top-1/2 -translate-y-1/2 w-14 h-14 rounded-2xl bg-white/90 hover:bg-white text-slate-900 shadow flex items-center justify-center text-3xl btn"
            aria-label="Previous photo" title="Previous">â€¹</button>

          <button id="heroNext"
            class="absolute right-4 top-1/2 -translate-y-1/2 w-14 h-14 rounded-2xl bg-white/90 hover:bg-white text-slate-900 shadow flex items-center justify-center text-3xl btn"
            aria-label="Next photo" title="Next">â€º</button>

          <!-- âœ… à¸£à¸¹à¸›à¹€à¸¥à¹‡à¸ (à¸„à¸‡à¹„à¸§à¹‰à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸”à¸´à¸¡) -->
          <div class="bg-white/95 backdrop-blur border-t border-slate-100 p-4">
            <div id="thumbStrip" class="flex gap-3 overflow-x-auto pb-1"></div>
          </div>
        </div>

        <!-- INFO -->
        <div class="p-6 md:p-8 space-y-5">
          <div class="flex flex-wrap gap-2 items-center">
            <div id="badgePill" class="chip bg-violet-100 text-violet-700">Badge: -</div>
            <div id="sysPill" class="chip bg-slate-100 text-slate-700">System: -</div>
            <div id="updatedPill" class="text-slate-400 font-semibold">Updated: -</div>
          </div>

          <div id="price" class="price-text text-slate-900">à¸¿0</div>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div class="feature bg-slate-50 border border-slate-100">ğŸ› <span id="bed">-</span></div>
            <div class="feature bg-slate-50 border border-slate-100">ğŸ› <span id="bath">-</span></div>
            <div class="feature bg-slate-50 border border-slate-100">ğŸ“ <span id="land">-</span> sq.w</div>
            <div class="feature bg-slate-50 border border-slate-100">ğŸ  <span id="living">-</span> sqm</div>
          </div>

          <div id="descBlock" class="bg-slate-50 border border-slate-100 rounded-[2rem] p-6 text-slate-700 leading-relaxed">
            â€”
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <a id="mapBtn" class="hidden text-center bg-white border border-slate-200 rounded-2xl py-4 font-bold text-slate-800 hover:bg-slate-50 btn">
              ğŸ“ OPEN MAP
            </a>
            <a id="vrBtn" class="hidden text-center bg-slate-900 text-white rounded-2xl py-4 font-bold hover:bg-slate-800 btn">
              ğŸŒ€ VIRTUAL TOUR
            </a>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="hidden fixed inset-0 z-50 bg-slate-950/80 backdrop-blur-sm">
    <div class="w-full h-full flex items-center justify-center p-4">
      <div class="relative w-full max-w-5xl">
        <button id="lbClose" class="absolute -top-4 right-0 md:right-2 w-12 h-12 rounded-2xl bg-white text-slate-900 shadow flex items-center justify-center text-xl btn">âœ•</button>

        <div class="bg-white rounded-[2.5rem] overflow-hidden shadow-2xl border border-white/20">
          <div class="relative">
            <img id="lbImg" src="" class="w-full max-h-[78vh] object-contain bg-slate-900 no-select">

            <button id="lbPrev" class="absolute left-4 top-1/2 -translate-y-1/2 w-14 h-14 rounded-2xl bg-white/90 hover:bg-white text-slate-900 shadow flex items-center justify-center text-3xl btn"
              aria-label="Previous photo">â€¹</button>

            <button id="lbNext" class="absolute right-4 top-1/2 -translate-y-1/2 w-14 h-14 rounded-2xl bg-white/90 hover:bg-white text-slate-900 shadow flex items-center justify-center text-3xl btn"
              aria-label="Next photo">â€º</button>

            <div id="lbCount" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-white/90 px-4 py-2 rounded-full font-semibold shadow">
              1 / 1
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwvCiaEKxvRI9rQCXMR_F4SHqmkJT4CnAuoVgEr6RYACmfgKerp7r06m-ltBMu4GFD4/exec";

  const qs = new URLSearchParams(location.search);
  const HP_ID = qs.get("id") || qs.get("hpId") || "";          // à¸£à¸­à¸‡à¸£à¸±à¸š id à¸«à¸£à¸·à¸­ hpId
  const PROJECT = qs.get("project") || "Project_0";

  // à¸•à¸±à¹‰à¸‡ back/home à¹ƒà¸«à¹‰à¸à¸¥à¸±à¸šà¹„à¸› index à¸à¸£à¹‰à¸­à¸¡ project
  document.getElementById("backBtn").href = `index.html?project=${encodeURIComponent(PROJECT)}`;
  document.getElementById("homeBtn").href = `index.html?project=${encodeURIComponent(PROJECT)}`;

  const priceFmt = v => {
    const n = Number(String(v).replace(/,/g,""));
    return (!n || n === 0) ? "à¸¿0" : "à¸¿" + n.toLocaleString();
  };

  const statusClass = s => {
    s = String(s || "").toLowerCase();
    if (s.includes("available")) return ["bg-emerald-100","text-emerald-700"];
    if (s.includes("under")) return ["bg-sky-100","text-sky-700"];
    if (s.includes("reserved")) return ["bg-amber-100","text-amber-700"];
    if (s.includes("sold")) return ["bg-rose-100","text-rose-700"];
    return ["bg-slate-100","text-slate-700"];
  };

  // gallery state
  let images = [];
  let activeIndex = 0;

  const heroImg = document.getElementById("heroImg");
  const thumbStrip = document.getElementById("thumbStrip");
  const countPill = document.getElementById("countPill");

  function setHeroByIndex(i) {
    if (!images.length) return;

    activeIndex = (i + images.length) % images.length;
    heroImg.src = images[activeIndex];

    // highlight thumb
    [...thumbStrip.querySelectorAll("img[data-idx]")].forEach(el => {
      el.classList.toggle("thumb-active", Number(el.dataset.idx) === activeIndex);
    });

    // update count
    countPill.textContent = `${images.length} Photos`;
  }

  function buildThumbs() {
    thumbStrip.innerHTML = images.map((url, idx) => `
      <img src="${url}" class="thumb ${idx===0 ? "thumb-active" : ""}" data-idx="${idx}" alt="thumb-${idx}">
    `).join("");

    thumbStrip.querySelectorAll("img[data-idx]").forEach(img => {
      img.addEventListener("click", () => setHeroByIndex(Number(img.dataset.idx)));
    });
  }

  // hero arrow buttons
  document.getElementById("heroPrev").addEventListener("click", (e) => {
    e.stopPropagation();
    setHeroByIndex(activeIndex - 1);
  });
  document.getElementById("heroNext").addEventListener("click", (e) => {
    e.stopPropagation();
    setHeroByIndex(activeIndex + 1);
  });

  // swipe on hero (mobile)
  let sx = 0, sy = 0;
  heroImg.addEventListener("touchstart", (e) => {
    sx = e.touches[0].clientX;
    sy = e.touches[0].clientY;
  }, {passive:true});

  heroImg.addEventListener("touchend", (e) => {
    const dx = e.changedTouches[0].clientX - sx;
    const dy = e.changedTouches[0].clientY - sy;
    if (Math.abs(dx) > 35 && Math.abs(dx) > Math.abs(dy)) {
      if (dx < 0) setHeroByIndex(activeIndex + 1);
      else setHeroByIndex(activeIndex - 1);
    }
  }, {passive:true});

  // lightbox
  const lightbox = document.getElementById("lightbox");
  const lbImg = document.getElementById("lbImg");
  const lbCount = document.getElementById("lbCount");

  function openLB() {
    if (!images.length) return;
    lightbox.classList.remove("hidden");
    lbImg.src = images[activeIndex];
    lbCount.textContent = `${activeIndex+1} / ${images.length}`;
  }
  function closeLB() {
    lightbox.classList.add("hidden");
  }
  function lbSet(i) {
    if (!images.length) return;
    activeIndex = (i + images.length) % images.length;
    lbImg.src = images[activeIndex];
    lbCount.textContent = `${activeIndex+1} / ${images.length}`;
    // sync hero too
    heroImg.src = images[activeIndex];
    [...thumbStrip.querySelectorAll("img[data-idx]")].forEach(el => {
      el.classList.toggle("thumb-active", Number(el.dataset.idx) === activeIndex);
    });
  }

  heroImg.addEventListener("click", openLB);
  document.getElementById("lbClose").addEventListener("click", closeLB);
  lightbox.addEventListener("click", (e) => { if (e.target === lightbox) closeLB(); });

  document.getElementById("lbPrev").addEventListener("click", (e) => { e.stopPropagation(); lbSet(activeIndex - 1); });
  document.getElementById("lbNext").addEventListener("click", (e) => { e.stopPropagation(); lbSet(activeIndex + 1); });

  // keyboard (desktop)
  document.addEventListener("keydown", (e) => {
    const lbOpen = !lightbox.classList.contains("hidden");
    if (e.key === "Escape" && lbOpen) closeLB();
    if (e.key === "ArrowLeft") {
      if (lbOpen) lbSet(activeIndex - 1); else setHeroByIndex(activeIndex - 1);
    }
    if (e.key === "ArrowRight") {
      if (lbOpen) lbSet(activeIndex + 1); else setHeroByIndex(activeIndex + 1);
    }
  });

  // swipe on lightbox
  let lbsx = 0, lbsy = 0;
  lbImg.addEventListener("touchstart", (e) => {
    lbsx = e.touches[0].clientX;
    lbsy = e.touches[0].clientY;
  }, {passive:true});
  lbImg.addEventListener("touchend", (e) => {
    const dx = e.changedTouches[0].clientX - lbsx;
    const dy = e.changedTouches[0].clientY - lbsy;
    if (Math.abs(dx) > 35 && Math.abs(dx) > Math.abs(dy)) {
      if (dx < 0) lbSet(activeIndex + 1);
      else lbSet(activeIndex - 1);
    }
  }, {passive:true});

  async function loadDetail() {
    if (!HP_ID) {
      document.getElementById("loading").textContent = "Missing id (HP_ID). Example: details.html?id=HP-Z001&project=Project_0";
      return;
    }

    const url = `${API_URL}?mode=getUnitDetail&project=${encodeURIComponent(PROJECT)}&hpId=${encodeURIComponent(HP_ID)}&t=${Date.now()}`;
    const res = await fetch(url);
    const d = await res.json();

    if (d.error) {
      document.getElementById("loading").textContent = d.error;
      return;
    }

    // show UI
    document.getElementById("loading").classList.add("hidden");
    document.getElementById("content").classList.remove("hidden");

    const plot = d.Plot || d.plot || "-";
    const status = d.Status || d.status || "-";
    const badge = d.Badge || d.badge || "-";
    const sys = d.System_Status || d.sysStatus || "-";
    const updated = d.Last_Updated || d.lastUpdated || "-";

    // title / subtitle
    document.getElementById("titleLine").textContent = `UNIT ${HP_ID} â€¢ ${plot}`;
    document.getElementById("subLine").textContent = `Project: ${PROJECT} â€¢ Unit: ${HP_ID}`;

    // pills
    document.getElementById("plotPill").textContent = plot;

    const [bgc, txc] = statusClass(status);
    const sp = document.getElementById("statusPill");
    sp.className = `absolute top-4 right-4 chip shadow ${bgc} ${txc}`;
    sp.textContent = status;

    document.getElementById("badgePill").textContent = `Badge: ${badge}`;
    document.getElementById("sysPill").textContent = `System: ${sys}`;
    document.getElementById("updatedPill").textContent = `Updated: ${updated}`;

    // price & features
    document.getElementById("price").textContent = priceFmt(d.Price || d.price || 0);
    document.getElementById("bed").textContent = d.Bedrooms || d.bedrooms || "-";
    document.getElementById("bath").textContent = d.Bathrooms || d.bathrooms || "-";
    document.getElementById("land").textContent = d.Land_Area_sq_w || d.landSqw || "-";
    document.getElementById("living").textContent = d.Living_Area_sq_m || d.livingSqm || "-";

    // description
    document.getElementById("descBlock").textContent = d.Description || d.description || "â€”";

    // map / vr
    const map = d.Map_Link || d.map_link || d.Map || "";
    const vr = d.Virtual_Tour || d.virtual_tour || "";

    const mapBtn = document.getElementById("mapBtn");
    if (map) { mapBtn.href = map; mapBtn.target = "_blank"; mapBtn.classList.remove("hidden"); }

    const vrBtn = document.getElementById("vrBtn");
    if (vr) { vrBtn.href = vr; vrBtn.target = "_blank"; vrBtn.classList.remove("hidden"); }

    // images
    const thumb = d.Thumbnail_Image || d.thumbnail || "";
    const list = d.Image_List || d.image_list || "";
    const arr = String(list || "").split(",").map(s => s.trim()).filter(Boolean);

    // à¹ƒà¸«à¹‰ thumbnail à¸­à¸¢à¸¹à¹ˆà¸«à¸™à¹‰à¸²à¹à¸£à¸à¹€à¸ªà¸¡à¸­ à¸–à¹‰à¸²à¸¡à¸µ
    images = [];
    if (thumb) images.push(thumb);
    arr.forEach(u => { if (u && !images.includes(u)) images.push(u); });

    // fallback: à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸¹à¸›à¹€à¸¥à¸¢
    if (!images.length) {
      images = ["https://via.placeholder.com/1600x900?text=No+Image"];
    }

    // build thumbs + set hero
    buildThumbs();
    setHeroByIndex(0);
  }

  loadDetail();
</script>
</body>
</html>
