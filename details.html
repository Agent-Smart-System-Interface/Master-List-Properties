<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UNIT DETAILS</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Kanit', sans-serif; }
    .price-text { font-size: clamp(2.2rem, 5vw, 3.3rem); font-weight: 700; letter-spacing: -0.03em; line-height: 1.05; }
    .muted { color:#94a3b8; }
    .pill { padding:.55rem 1rem; border-radius:999px; font-weight:600; font-size:.95rem; }
    .soft-card { border-radius: 2.2rem; overflow:hidden; box-shadow: 0 10px 30px rgba(2,6,23,.10); }
    .thumb { border-radius: 1.25rem; overflow:hidden; border: 2px solid transparent; }
    .thumb.active { border-color:#0f172a; }
    .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
    img { -webkit-user-drag: none; }

    /* ✅ Arrow buttons: subtle, no white background */
    .nav-btn{
      position:absolute;
      top:50%;
      transform: translateY(-50%);
      width:56px; height:56px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      background: transparent;
      border: none;
      color: rgba(255,255,255,.85);
      font-size: 44px;
      line-height: 1;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      text-shadow: 0 6px 18px rgba(0,0,0,.40);
      transition: transform .12s ease, opacity .12s ease;
      opacity: .85;
    }
    .nav-btn:hover{ opacity: 1; transform: translateY(-50%) scale(1.04); }
    .nav-btn:active{ transform: translateY(-50%) scale(.96); }
    .nav-left{ left: 14px; }
    .nav-right{ right: 14px; }

    @media (max-width: 640px){
      .nav-btn{ width:46px; height:46px; font-size:38px; }
      .nav-left{ left: 10px; }
      .nav-right{ right: 10px; }
    }

    /* ✅ Skeleton shimmer */
    .shimmer {
      background: linear-gradient(90deg, #eef2f7 25%, #f8fafc 37%, #eef2f7 63%);
      background-size: 400% 100%;
      animation: shimmer 1.25s ease infinite;
    }
    @keyframes shimmer {
      0% { background-position: 100% 0; }
      100% { background-position: 0 0; }
    }

    /* ✅ Photo loading overlay */
    .photo-overlay {
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.28), rgba(0,0,0,.18));
      backdrop-filter: blur(6px);
      color: rgba(255,255,255,.95);
      font-weight:700;
      letter-spacing:.04em;
    }
    .photo-overlay.hidden{ display:none; }

    /* ✅ Page loading overlay (clean, not "broken") */
    .page-loading {
      position: fixed; inset:0;
      background: #f8fafc;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 9999;
      padding: 16px;
    }
    .page-loading.hidden{ display:none; }
  </style>
</head>

<body class="bg-slate-50">

  <!-- ✅ FULL PAGE LOADING (shows first, looks clean) -->
  <div id="pageLoading" class="page-loading">
    <div class="w-full max-w-3xl">
      <div class="flex items-start justify-between mb-6">
        <div class="w-1/2">
          <div class="h-10 w-48 rounded-2xl shimmer"></div>
          <div class="h-5 w-64 mt-3 rounded-xl shimmer"></div>
        </div>
        <div class="flex gap-3">
          <div class="w-12 h-12 rounded-2xl shimmer"></div>
          <div class="w-12 h-12 rounded-2xl shimmer"></div>
        </div>
      </div>

      <div class="soft-card bg-white">
        <div class="h-[320px] sm:h-[420px] md:h-[520px] shimmer"></div>
        <div class="p-6">
          <div class="h-6 w-40 rounded-xl shimmer mb-3"></div>
          <div class="h-6 w-56 rounded-xl shimmer"></div>
        </div>
      </div>

      <div class="mt-6 soft-card bg-white p-6">
        <div class="h-12 w-56 rounded-2xl shimmer mb-4"></div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="h-20 rounded-2xl shimmer"></div>
          <div class="h-20 rounded-2xl shimmer"></div>
          <div class="h-20 rounded-2xl shimmer"></div>
          <div class="h-20 rounded-2xl shimmer"></div>
        </div>
      </div>

      <div class="text-center muted mt-6 font-semibold">Loading data & photos…</div>
    </div>
  </div>

  <!-- ✅ MAIN CONTENT (hidden until ready) -->
  <div id="app" class="opacity-0 transition-opacity duration-200">
    <div class="max-w-6xl mx-auto px-4 py-6 md:py-10">

      <!-- Header -->
      <div class="flex items-start justify-between gap-4 mb-6">
        <div class="min-w-0">
          <h1 id="title" class="text-3xl md:text-5xl font-extrabold italic text-slate-900 truncate">UNIT</h1>
          <div id="subtitle" class="mt-2 text-base md:text-lg muted">Project: - • Unit: -</div>
        </div>

        <div class="flex gap-3 shrink-0">
          <button onclick="history.back()"
            class="w-12 h-12 md:w-14 md:h-14 rounded-2xl bg-white shadow flex items-center justify-center text-xl"
            title="Back">←</button>

          <a id="homeBtn" href="index.html"
            class="w-12 h-12 md:w-14 md:h-14 rounded-2xl bg-slate-900 text-white shadow flex items-center justify-center text-xl"
            title="Home">⌂</a>
        </div>
      </div>

      <!-- Error card (if missing id) -->
      <div id="errBox" class="hidden bg-white soft-card p-6 md:p-8">
        <div class="text-2xl font-extrabold text-slate-900 mb-2">Missing Unit ID</div>
        <div class="muted mb-4">กรุณาเปิดลิงก์แบบนี้: <b>details.html?id=HP-Z001&project=Project_0</b></div>
        <a href="index.html" class="inline-block px-5 py-3 rounded-2xl bg-slate-900 text-white font-semibold">Back to Index</a>
      </div>

      <!-- Main gallery card -->
      <div id="galleryCard" class="soft-card bg-white">
        <div class="relative">
          <img id="mainImg" src="" alt="Property photo"
               class="w-full h-[320px] sm:h-[420px] md:h-[520px] object-cover"
               decoding="async" loading="eager">

          <!-- ✅ overlay while photo loads (prevents "broken" feeling) -->
          <div id="photoLoading" class="photo-overlay">
            Loading photo…
          </div>

          <div id="plotPill" class="absolute top-4 left-4 bg-white/90 px-4 py-2 rounded-full font-semibold">-</div>
          <div id="statusPill" class="absolute top-4 right-4 px-4 py-2 rounded-full font-semibold">-</div>

          <button id="prevBtn" class="nav-btn nav-left" aria-label="Previous photo" title="Previous">‹</button>
          <button id="nextBtn" class="nav-btn nav-right" aria-label="Next photo" title="Next">›</button>

          <div id="counter" class="absolute bottom-4 right-4 bg-white/90 px-4 py-2 rounded-full font-semibold">1 / 1</div>
        </div>

        <div class="p-4 md:p-6">
          <div id="thumbRow" class="flex gap-3 overflow-x-auto pb-2"></div>
        </div>
      </div>

      <!-- Info card -->
      <div class="mt-6 bg-white soft-card p-6 md:p-8">
        <div class="flex flex-wrap gap-3 mb-5">
          <div id="badgePill" class="pill bg-violet-100 text-violet-700">Badge: -</div>
          <div id="sysPill" class="pill bg-slate-100 text-slate-700">System: -</div>
          <div id="updated" class="w-full muted font-semibold">Updated: -</div>
        </div>

        <div class="price-text text-slate-900" id="price">฿0</div>

        <div class="mt-5 grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
          <div class="bg-slate-100 rounded-2xl p-4"><div class="muted">Bedrooms</div><div id="bed" class="text-lg font-semibold">-</div></div>
          <div class="bg-slate-100 rounded-2xl p-4"><div class="muted">Bathrooms</div><div id="bath" class="text-lg font-semibold">-</div></div>
          <div class="bg-slate-100 rounded-2xl p-4"><div class="muted">Land (sq.w)</div><div id="landSqw" class="text-lg font-semibold">-</div></div>
          <div class="bg-slate-100 rounded-2xl p-4"><div class="muted">Living (sqm)</div><div id="livingSqm" class="text-lg font-semibold">-</div></div>
        </div>

        <div class="mt-6">
          <div class="text-sm muted font-semibold mb-2">Description</div>
          <div id="desc" class="text-slate-800 leading-relaxed">-</div>
        </div>

        <div class="mt-6 flex flex-wrap gap-3">
          <a id="mapBtn" href="#" target="_blank"
             class="px-5 py-3 rounded-2xl bg-slate-900 text-white font-semibold">OPEN MAP</a>
          <a id="fbBtn" href="#" target="_blank"
             class="px-5 py-3 rounded-2xl bg-blue-600 text-white font-semibold">FACEBOOK / LISTING</a>
        </div>
      </div>

      <div id="loadingText" class="text-center text-slate-400 py-10 hidden">Loading...</div>
    </div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwvCiaEKxvRI9rQCXMR_F4SHqmkJT4CnAuoVgEr6RYACmfgKerp7r06m-ltBMu4GFD4/exec";

  const qs = new URLSearchParams(location.search);
  const PROJECT = qs.get("project") || "Project_0";
  const ID = qs.get("id") || qs.get("hpId") || "";

  document.getElementById("homeBtn").href = `index.html?project=${encodeURIComponent(PROJECT)}`;

  const pageLoading = document.getElementById("pageLoading");
  const app = document.getElementById("app");
  const errBox = document.getElementById("errBox");
  const galleryCard = document.getElementById("galleryCard");
  const photoLoading = document.getElementById("photoLoading");

  const priceFmt = v => {
    const n = Number(v);
    return (!n || n === 0) ? "฿0" : "฿" + n.toLocaleString();
  };

  const statusClass = s => {
    s = String(s || "").toLowerCase();
    if (s.includes("available")) return "bg-emerald-100 text-emerald-700";
    if (s.includes("under")) return "bg-sky-100 text-sky-700";
    if (s.includes("reserved")) return "bg-amber-100 text-amber-700";
    if (s.includes("sold")) return "bg-rose-100 text-rose-700";
    return "bg-slate-100 text-slate-700";
  };

  let images = [];
  let current = 0;

  function cleanUrl(u){ return String(u||"").trim(); }

  function showApp(){
    pageLoading.classList.add("hidden");
    app.classList.remove("opacity-0");
  }

  function waitImageLoad(imgEl, src){
    return new Promise((resolve) => {
      let done = false;
      const timer = setTimeout(() => { if(!done){ done = true; resolve(false); } }, 12000);

      imgEl.onload = () => { if(done) return; done = true; clearTimeout(timer); resolve(true); };
      imgEl.onerror = () => { if(done) return; done = true; clearTimeout(timer); resolve(false); };

      imgEl.src = src;
    });
  }

  function setMain(i){
    if(!images.length) return;
    current = (i + images.length) % images.length;

    // show photo overlay until loaded
    photoLoading.classList.remove("hidden");
    const mainImg = document.getElementById("mainImg");
    waitImageLoad(mainImg, images[current]).then(() => {
      photoLoading.classList.add("hidden");
    });

    document.getElementById("counter").textContent = `${current+1} / ${images.length}`;

    const thumbs = document.querySelectorAll("[data-thumb]");
    thumbs.forEach((t, idx) => idx === current ? t.classList.add("active") : t.classList.remove("active"));
  }

  function renderThumbs(){
    const row = document.getElementById("thumbRow");
    row.innerHTML = images.map((src, idx) => `
      <button data-thumb class="thumb ${idx===0 ? "active" : ""} shrink-0 w-[92px] h-[64px] md:w-[120px] md:h-[78px] bg-slate-200"
              title="Photo ${idx+1}">
        <img src="${src}" alt="thumb ${idx+1}" loading="lazy" decoding="async">
      </button>
    `).join("");

    row.querySelectorAll("[data-thumb]").forEach((btn, idx) => {
      btn.addEventListener("click", () => setMain(idx));
    });
  }

  function enableSwipe(){
    const img = document.getElementById("mainImg");
    let x0 = null;

    img.addEventListener("touchstart", (e) => { x0 = e.touches[0].clientX; }, {passive:true});
    img.addEventListener("touchend", (e) => {
      if(x0 === null) return;
      const x1 = e.changedTouches[0].clientX;
      const dx = x1 - x0;
      x0 = null;
      if(Math.abs(dx) < 40) return;
      if(dx > 0) setMain(current - 1);
      else setMain(current + 1);
    }, {passive:true});
  }

  async function load(){
    // ✅ if missing id, show clean error page
    if(!ID){
      galleryCard.classList.add("hidden");
      errBox.classList.remove("hidden");
      showApp();
      return;
    }

    try{
      const res = await fetch(`${API_URL}?mode=getUnitDetail&project=${encodeURIComponent(PROJECT)}&hpId=${encodeURIComponent(ID)}&t=${Date.now()}`);
      const d = await res.json();

      if(d.error){
        galleryCard.classList.add("hidden");
        errBox.classList.remove("hidden");
        showApp();
        return;
      }

      const plot = d.Plot || d.plot || "-";
      document.getElementById("title").textContent = `UNIT ${ID} • ${plot}`;
      document.getElementById("subtitle").textContent = `Project: ${PROJECT} • Unit: ${ID}`;

      document.getElementById("plotPill").textContent = plot;

      const status = d.Status || d.status || "-";
      const statusPill = document.getElementById("statusPill");
      statusPill.className = `absolute top-4 right-4 px-4 py-2 rounded-full font-semibold ${statusClass(status)}`;
      statusPill.textContent = status;

      document.getElementById("badgePill").textContent = `Badge: ${d.Badge || d.badge || "-"}`;
      document.getElementById("sysPill").textContent = `System: ${d.System_Status || d.sysStatus || "-"}`;
      document.getElementById("updated").textContent = `Updated: ${d.Last_Updated || d.lastUpdated || "-"}`;

      document.getElementById("price").textContent = priceFmt(d.Price || d.price || 0);
      document.getElementById("bed").textContent = d.Bedrooms || d.bedrooms || "-";
      document.getElementById("bath").textContent = d.Bathrooms || d.bathrooms || "-";
      document.getElementById("landSqw").textContent = d.Land_Area_sq_w || d.landSqw || "-";
      document.getElementById("livingSqm").textContent = d.Living_Area_sq_m || d.livingSqm || "-";
      document.getElementById("desc").textContent = d.Description || d.description || "-";

      const map = d.Map_Link || "";
      const fb  = d.FBLink || "";
      const mapBtn = document.getElementById("mapBtn");
      const fbBtn  = document.getElementById("fbBtn");
      mapBtn.href = map ? map : "#";
      fbBtn.href  = fb ? fb : "#";
      if(!map) mapBtn.classList.add("opacity-40","pointer-events-none");
      if(!fb)  fbBtn.classList.add("opacity-40","pointer-events-none");

      // Images
      const thumb = cleanUrl(d.Thumbnail_Image || d.thumbnail || "");
      const listRaw = cleanUrl(d.Image_List || d.image_list || "");
      const list = listRaw ? listRaw.split(",").map(s => cleanUrl(s)).filter(Boolean) : [];

      const seen = new Set();
      images = [];
      [thumb, ...list].forEach(u => {
        if(u && !seen.has(u)){
          seen.add(u);
          images.push(u);
        }
      });

      if(!images.length){
        images = ["https://via.placeholder.com/1200x700?text=No+Image"];
      }

      renderThumbs();
      enableSwipe();

      // ✅ show app immediately (not broken), but keep photo overlay until first image loads
      showApp();

      // First image
      setMain(0);

      // Arrows
      document.getElementById("prevBtn").addEventListener("click", () => setMain(current - 1));
      document.getElementById("nextBtn").addEventListener("click", () => setMain(current + 1));

      // Keyboard (desktop)
      window.addEventListener("keydown", (e) => {
        if(e.key === "ArrowLeft") setMain(current - 1);
        if(e.key === "ArrowRight") setMain(current + 1);
      });

    }catch(err){
      galleryCard.classList.add("hidden");
      errBox.classList.remove("hidden");
      showApp();
    }
  }

  load();
</script>
</body>
</html>
