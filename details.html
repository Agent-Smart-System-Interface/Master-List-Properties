<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>smart properties system ¬∑ details</title>
  <meta name="theme-color" content="#6f86a6" />
  <style>
    :root{
      --bg1:#9fb6d6; --bg2:#8aa5c7; --cloud:rgba(255,255,255,.28);
      --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --shadow:0 16px 40px rgba(15,23,42,.12);
      --radius:22px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--ink);
      background:
        radial-gradient(120px 60px at 20% 30%, var(--cloud) 0 60%, transparent 62%),
        radial-gradient(180px 90px at 78% 36%, var(--cloud) 0 60%, transparent 62%),
        radial-gradient(220px 100px at 30% 72%, rgba(255,255,255,.22) 0 60%, transparent 62%),
        radial-gradient(200px 90px at 78% 78%, rgba(255,255,255,.20) 0 60%, transparent 62%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      min-height:100%;
      padding:16px;
    }
    .wrap{max-width:1200px;margin:0 auto}
    .topbar{display:flex;align-items:center;gap:12px;padding:10px 6px 18px}
    .avatar{width:46px;height:46px;border-radius:50%;display:grid;place-items:center;background:rgba(255,255,255,.7);
      box-shadow:0 10px 22px rgba(15,23,42,.10);font-weight:900}
    .titleblock{flex:1;min-width:0}
    .title{margin:0;font-size:24px;font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .subtitle{margin:2px 0 0;color:rgba(15,23,42,.6);font-size:14px;font-weight:700;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .iconBtn{width:46px;height:46px;border-radius:18px;border:0;cursor:pointer;background:rgba(255,255,255,.75);
      box-shadow:0 10px 22px rgba(15,23,42,.10);display:grid;place-items:center}
    .iconBtn:active{transform:scale(.98)}
    @media (min-width: 980px){ body{padding:22px} .title{font-size:28px} }

    .layout{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width: 980px){ .layout{grid-template-columns:repeat(3, minmax(0, 1fr));gap:18px} }

    .card{background:rgba(255,255,255,.92);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.65);
      overflow:hidden;backdrop-filter: blur(6px)}
    .pad{padding:16px}
    .heroImg{width:100%;aspect-ratio:16/9;object-fit:cover;background:#e5e7eb;display:block}
    .h1{font-size:34px;margin:0;font-weight:1100;letter-spacing:.2px}
    .price{font-size:44px;margin:8px 0 0;font-weight:1200}
    .meta{margin:14px 0 0;display:flex;gap:10px;flex-wrap:wrap}
    .chip{padding:10px 12px;border-radius:999px;background:rgba(15,23,42,.06);font-weight:1000}
    .sectionTitle{margin:0 0 10px;font-size:18px;font-weight:1100}
    .kv{display:grid;gap:10px}
    .kvRow{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-radius:18px;background:rgba(15,23,42,.05)}
    .kvRow span{font-weight:900;color:rgba(15,23,42,.55)}
    .kvRow b{font-weight:1100}
    .btn{width:100%;border:0;border-radius:18px;padding:14px 16px;font-weight:1100;font-size:18px;cursor:pointer}
    .btnGhost{background:rgba(15,23,42,.06)}
    .btn:active{transform:scale(.99)}

    .gallery{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:10px}
    @media (min-width: 980px){ .gallery{grid-template-columns:repeat(4, minmax(0,1fr))} }
    .gImg{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:16px;background:#e5e7eb;display:block;cursor:pointer}
    .error{margin:14px 6px;color:#b91c1c;font-weight:1000}
    .skeleton{animation:pulse 1.2s ease-in-out infinite}
    @keyframes pulse{0%,100%{opacity:.55}50%{opacity:1}}

    /* lightbox */
    .lbBack{position:fixed;inset:0;background:rgba(15,23,42,.75);display:none;place-items:center;z-index:70;padding:14px}
    .lb{width:min(980px, 100%);max-height:86vh;background:#0b1220;border-radius:18px;overflow:hidden;display:grid}
    .lb img{width:100%;height:86vh;object-fit:contain;background:#0b1220}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="avatar">SP</div>
      <div class="titleblock">
        <h1 class="title">smart properties system</h1>
        <div class="subtitle">
          <span>Details ¬∑ feel LINE</span>
          <span style="width:6px;height:6px;border-radius:999px;background:rgba(255,255,255,.95);display:inline-block"></span>
          <b id="hpMini">HP-</b>
        </div>
      </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö -->
      <button class="iconBtn" id="btnBack" aria-label="Back" title="Back">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M15 18l-6-6 6-6" stroke="rgba(15,23,42,.75)" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <!-- ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠: ‡πÄ‡∏≠‡∏≤‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ñ‡∏ô + ‡∏î‡∏¥‡∏ô‡∏™‡∏≠ ‡∏≠‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ) -->
    </div>

    <div id="error" class="error" style="display:none"></div>

    <div class="layout">
      <!-- column 1 -->
      <div class="card">
        <img id="heroImg" class="heroImg skeleton" alt="cover" />
      </div>

      <!-- column 2 -->
      <div class="card">
        <div class="pad">
          <div class="h1" id="hpTitle">HP-</div>
          <div class="price" id="priceText">‡∏ø0</div>
          <div class="meta" id="meta"></div>
        </div>
      </div>

      <!-- column 3 -->
      <div class="card">
        <div class="pad">
          <div class="sectionTitle">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</div>
          <div class="kv" id="kv"></div>
          <div style="height:12px"></div>
          <button class="btn btnGhost" id="btnMap">Google Map</button>
          <div style="height:10px"></div>
          <button class="btn btnGhost" id="btnFb">Facebook</button>
        </div>
      </div>

      <!-- full width gallery -->
      <div class="card" style="grid-column: 1 / -1">
        <div class="pad">
          <div class="sectionTitle">Project Gallery Final</div>
          <div id="galleryNote" class="muted" style="font-weight:900;margin-bottom:10px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°‚Ä¶</div>
          <div class="gallery" id="gallery"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="lbBack" id="lbBack" role="dialog" aria-modal="true">
    <div class="lb"><img id="lbImg" alt="preview" /></div>
  </div>

<script>
(() => {
  const API_URL = "https://script.google.com/macros/s/AKfycbwvCiaEKxvRI9rQCXMR_F4SHqmkJT4CnAuoVgEr6RYACmfgKerp7r06m-ltBMu4GFD4/exec";
  const PROJECT = "Project_0";
  const GALLERY_FOLDER_ID = "1kdgsHds6H_KHXiFAw_IzOoLMdMDPyJr0";

  const qs = new URLSearchParams(location.search);
  const HP_ID = (qs.get("id") || qs.get("hpId") || "").trim();

  const elError = document.getElementById("error");
  const elHpMini = document.getElementById("hpMini");
  const elHpTitle = document.getElementById("hpTitle");
  const elPrice = document.getElementById("priceText");
  const elMeta = document.getElementById("meta");
  const elKv = document.getElementById("kv");
  const elHero = document.getElementById("heroImg");
  const elGallery = document.getElementById("gallery");
  const elGalleryNote = document.getElementById("galleryNote");

  const btnBack = document.getElementById("btnBack");
  const btnMap = document.getElementById("btnMap");
  const btnFb = document.getElementById("btnFb");

  const lbBack = document.getElementById("lbBack");
  const lbImg = document.getElementById("lbImg");
  lbBack.addEventListener("click", (e) => { if(e.target === lbBack) lbBack.style.display="none"; });

  btnBack.addEventListener("click", () => {
    if (history.length > 1) history.back();
    else location.href = "index.html";
  });

  if(!HP_ID){
    elError.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå id (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: details.html?id=HP-Z001)";
    elError.style.display = "block";
    return;
  }

  elHpMini.textContent = HP_ID;
  elHpTitle.textContent = HP_ID;

  function parsePrice(v){
    if (v == null) return 0;
    const n = String(v).replace(/[^\d.]/g, "");
    return Number(n || 0);
  }

  function safeUrl(s){
    if(!s) return "";
    const t = String(s).trim();
    if(!t) return "";
    return t;
  }

  function splitImageList(v){
    if(!v) return [];
    if(Array.isArray(v)) return v.filter(Boolean);
    const s = String(v).trim();
    if(!s) return [];
    return s.split(/\s*[,|\n]\s*/g).map(x => x.trim()).filter(Boolean);
  }

  async function fetchJson(url, timeoutMs=18000){
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), timeoutMs);
    try{
      const res = await fetch(url, {signal: ctrl.signal, cache:"no-store"});
      const txt = await res.text();
      try { return JSON.parse(txt); } catch(_e) {
        const cleaned = txt.replace(/^\)\]\}'\n?/, "");
        return JSON.parse(cleaned);
      }
    } finally {
      clearTimeout(timer);
    }
  }

  // ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 4: ‡πÄ‡∏£‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏î‡πâ‡∏ß‡∏¢ cache
  const cacheKey = `unitDetail::${PROJECT}::${HP_ID}`;
  const cacheTtlMs = 3 * 60 * 1000;

  function saveCache(obj){
    try{ sessionStorage.setItem(cacheKey, JSON.stringify({ts:Date.now(), data:obj})); }catch(_e){}
  }
  function loadCache(){
    try{
      const raw = sessionStorage.getItem(cacheKey);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj?.ts || !obj?.data) return null;
      if(Date.now() - obj.ts > cacheTtlMs) return null;
      return obj.data;
    }catch(_e){ return null; }
  }

  function setCover(url){
    const u = safeUrl(url);
    elHero.classList.remove("skeleton");
    if(!u){
      elHero.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='675'%3E%3Crect width='100%25' height='100%25' fill='%23e5e7eb'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' font-family='Arial' font-size='44' fill='%2394a3b8'%3Eno image%3C/text%3E%3C/svg%3E";
      return;
    }
    elHero.src = u;
  }

  function renderMeta(row){
    const beds = row.Bed || row.Bedrooms || row.Bedroom || row.bed || "-";
    const baths = row.Bath || row.Bathrooms || row.Bathroom || row.bath || "-";
    const land = row.Land_sq_w || row.Land || row.LandSize || row.land || "-";
    const area = row.Area_sqm || row.Area || row.Usable || row.usable || "";
    elMeta.innerHTML = "";
    const items = [
      ["üõèÔ∏è", beds],
      ["üõÅ", baths],
      ["üìê", land],
      area ? ["üè°", area] : null
    ].filter(Boolean);
    items.forEach(([icon,val]) => {
      const d = document.createElement("div");
      d.className="chip";
      d.textContent = `${icon} ${val}`;
      elMeta.appendChild(d);
    });
  }

  function renderKV(row){
    const pairs = [
      ["Project", row.Project || row.project || PROJECT],
      ["HP_ID", row.HP_ID || row.hpId || HP_ID],
      ["Plot", row.Plot || row.Plot_No || row.PlotName || row.Unit || ""],
      ["Badge", row.Badge || row.badge || ""],
      ["Status", row.Status || row.system || row.System || ""],
      ["Updated", row.Updated || row.updated || ""],
    ].filter(p => p[1] !== "");
    elKv.innerHTML = "";
    pairs.forEach(([k,v]) => {
      const r = document.createElement("div");
      r.className="kvRow";
      r.innerHTML = `<span>${k}</span><b>${String(v)}</b>`;
      elKv.appendChild(r);
    });
  }

  function wireButtons(row){
    const mapUrl = safeUrl(row.Google_Map || row.GoogleMap || row.Map || row.map || "");
    const fbUrl  = safeUrl(row.Facebook || row.FB || row.fb || "");
    btnMap.disabled = !mapUrl;
    btnFb.disabled = !fbUrl;
    btnMap.onclick = () => { if(mapUrl) window.open(mapUrl, "_blank", "noopener"); };
    btnFb.onclick  = () => { if(fbUrl) window.open(fbUrl, "_blank", "noopener"); };
  }

  function renderGallery(urls){
    elGallery.innerHTML = "";
    if(!urls.length){
      elGalleryNote.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏° (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Project_Gallery_Final ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏´‡∏°‡∏î API)";
      return;
    }
    elGalleryNote.textContent = `${urls.length} ‡∏£‡∏π‡∏õ`;
    urls.forEach((u, idx) => {
      const img = document.createElement("img");
      img.className = "gImg";
      img.loading = "lazy";
      img.decoding = "async";
      img.src = u;
      img.alt = `gallery-${idx+1}`;
      img.addEventListener("click", () => {
        lbImg.src = u;
        lbBack.style.display = "grid";
      });
      elGallery.appendChild(img);
    });
  }

  async function getDetail(){
    const cached = loadCache();
    if(cached) return cached;

    const tries = [
      `${API_URL}?mode=getUnitDetail&project=${encodeURIComponent(PROJECT)}&hpId=${encodeURIComponent(HP_ID)}`,
      `${API_URL}?mode=getUnitDetail&project=${encodeURIComponent(PROJECT)}&id=${encodeURIComponent(HP_ID)}`,
      `${API_URL}?action=getUnitDetail&project=${encodeURIComponent(PROJECT)}&hpId=${encodeURIComponent(HP_ID)}`,
      `${API_URL}?action=getUnitDetail&project=${encodeURIComponent(PROJECT)}&id=${encodeURIComponent(HP_ID)}`,
      `${API_URL}?mode=getProperty&id=${encodeURIComponent(HP_ID)}`,
      `${API_URL}?action=getProperty&id=${encodeURIComponent(HP_ID)}`
    ];

    let lastErr=null;
    for(const u of tries){
      try{
        const out = await fetchJson(u);
        const row = Array.isArray(out) ? out[0] : (out?.data || out?.item || out);
        if(row && typeof row === "object" && (row.HP_ID || row.hpId || row.id || out?.ok)){
          saveCache(row);
          return row;
        }
        if(out?.error) lastErr = new Error(out.error);
      }catch(e){ lastErr=e; }
    }
    throw lastErr || new Error("Cannot load detail");
  }

  async function getGalleryFallback(row){
    const fromSheet = splitImageList(row.Image_List || row.Gallery || row.Images || row.gallery || "");
    if(fromSheet.length) return fromSheet;

    const folderId = row.Project_Gallery_Final || row.Gallery_Folder || row.FolderId || row.folderId || "";
    const useFolderId = (folderId && String(folderId).length > 10) ? String(folderId) : GALLERY_FOLDER_ID;

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Drive (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏°‡∏î)
    const tries = [
      `${API_URL}?mode=getGalleryFinal&folderId=${encodeURIComponent(useFolderId)}&hpId=${encodeURIComponent(HP_ID)}`,
      `${API_URL}?action=getGalleryFinal&folderId=${encodeURIComponent(useFolderId)}&hpId=${encodeURIComponent(HP_ID)}`,
      `${API_URL}?mode=listGallery&folderId=${encodeURIComponent(useFolderId)}&hpId=${encodeURIComponent(HP_ID)}`,
      `${API_URL}?action=listGallery&folderId=${encodeURIComponent(useFolderId)}&hpId=${encodeURIComponent(HP_ID)}`,
      `${API_URL}?mode=getImages&folderId=${encodeURIComponent(useFolderId)}&hpId=${encodeURIComponent(HP_ID)}`,
      `${API_URL}?action=getImages&folderId=${encodeURIComponent(useFolderId)}&hpId=${encodeURIComponent(HP_ID)}`,
      `${API_URL}?mode=getGallery&folderId=${encodeURIComponent(useFolderId)}&hpId=${encodeURIComponent(HP_ID)}`,
      `${API_URL}?action=getGallery&folderId=${encodeURIComponent(useFolderId)}&hpId=${encodeURIComponent(HP_ID)}`
    ];

    for(const u of tries){
      try{
        const out = await fetchJson(u);
        const urls =
          (Array.isArray(out) ? out :
          Array.isArray(out?.data) ? out.data :
          Array.isArray(out?.items) ? out.items :
          Array.isArray(out?.urls) ? out.urls : null);
        if(urls && urls.length) return urls.filter(Boolean);
      }catch(_e){}
    }
    return [];
  }

  function setPrice(row){
    const price = parsePrice(row.Price || row.Sale_Price || row.price || 0);
    elPrice.textContent = `‡∏ø${price.toLocaleString("en-US")}`;
  }

  async function main(){
    try{
      const row = await getDetail();

      const cover = safeUrl(row.Thumbnail_Image || row.Cover || row.Cover_Image || row.Image || "");
      setCover(cover);

      setPrice(row);
      renderMeta(row);
      renderKV(row);
      wireButtons(row);

      elGalleryNote.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°‚Ä¶";
      const urls = await getGalleryFallback(row);

      if(!cover && urls.length) setCover(urls[0]);
      renderGallery(urls);

    }catch(err){
      elError.textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏°‡∏î API / ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Web App / HP_ID";
      elError.style.display = "block";
      console.error(err);
      elGalleryNote.textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      setCover("");
    }
  }

  main();
})();
</script>
</body>
</html>
