<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>smart properties system ¬∑ details</title>

  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#e8eef6;
      --card:#ffffff;
      --text:#0b1320;
      --muted:#6b7a90;
      --radius:22px;
      --shadow:0 12px 30px rgba(0,0,0,.12);
      --line:rgba(15,23,42,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Kanit,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Thai",sans-serif;
      background: linear-gradient(180deg, #dde7f3, #eef4fb);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px 14px 44px}
    .topbar{
      display:flex;align-items:center;gap:12px;
      padding:12px 12px;
      background: rgba(255,255,255,.75);
      border:1px solid var(--line);
      border-radius: 26px;
      backdrop-filter: blur(8px);
      position:sticky; top:10px; z-index:10;
    }
    .backBtn{
      width:44px;height:44px;border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .titlebox{flex:1;min-width:0}
    .title{margin:0;font-weight:900;font-size:18px;line-height:1.15;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .subtitle{margin-top:4px;font-size:12px;color:rgba(11,19,32,.65);font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .grid{
      margin-top:12px;
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media(min-width: 980px){
      .grid{grid-template-columns: 1.2fr .8fr;}
    }

    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.75);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
    }

    /* Gallery */
    .hero{
      position:relative;
      aspect-ratio: 16/10;
      background:#e9eef5;
      overflow:hidden;
    }
    .hero img{
      width:100%;height:100%;object-fit:cover;display:block;
    }
    .skeleton{
      background: linear-gradient(90deg, #e9eef5 0%, #f4f7fb 40%, #e9eef5 80%);
      background-size: 200% 100%;
      animation: shimmer 1.2s linear infinite;
    }
    @keyframes shimmer{0%{background-position:0 0}100%{background-position:200% 0}}

    .tagCount{
      position:absolute;left:12px;bottom:12px;
      padding:8px 12px;border-radius:999px;
      background: rgba(255,255,255,.82);
      border:1px solid rgba(255,255,255,.7);
      font-weight:900;
      font-size:12px;
      color:rgba(11,19,32,.75);
    }

    .navBtn{
      position:absolute;top:50%;
      transform:translateY(-50%);
      width:44px;height:44px;border-radius:999px;
      border:1px solid rgba(255,255,255,.75);
      background: rgba(255,255,255,.82);
      cursor:pointer;font-weight:900;
      box-shadow: 0 10px 20px rgba(0,0,0,.10);
      user-select:none;
    }
    .navBtn:active{transform:translateY(-50%) scale(.98)}
    .navPrev{left:12px}
    .navNext{right:12px}

    .thumbs{
      display:flex;gap:10px;overflow:auto;
      padding:12px;
      border-top:1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.75);
    }
    .thumb{
      width:72px;height:54px;border-radius:14px;flex:0 0 auto;
      overflow:hidden;border:2px solid transparent;
      background:#e9eef5;cursor:pointer;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb.active{border-color: rgba(59,130,246,.7)}

    /* Right panel */
    .pad{padding:14px 14px 16px}
    .line{height:1px;background:rgba(15,23,42,.08);margin:12px 0}
    .hRow{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .h1{margin:0;font-weight:1000;font-size:18px}
    .badge{
      padding:8px 12px;border-radius:999px;
      font-weight:1000;font-size:12px;
      border:1px solid rgba(15,23,42,.15);
      color:rgba(15,23,42,.92);
      background: rgba(255,255,255,.8);
      max-width: 60%;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .k{
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(11,19,32,.03);
    }
    .k .t{font-weight:1000;color:rgba(11,19,32,.7);font-size:12px}
    .k .v{margin-top:6px;font-weight:1000;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .btn{
      width:100%;
      border:none;
      border-radius: 18px;
      padding:14px 14px;
      font-size:16px;
      font-weight:1000;
      cursor:pointer;
    }
    .btnPrimary{background:#c6f0d8;color:rgba(11,19,32,.86)}
    .btnGhost{background:rgba(255,255,255,.8);border:1px solid rgba(15,23,42,.10)}
    .btn:active{transform:scale(.99)}

    .desc{
      margin-top:12px;
      font-size:14px;
      line-height:1.6;
      color:rgba(11,19,32,.78);
      font-weight:600;
      white-space:pre-wrap;
    }

    /* Loader overlay */
    .pageLoader{
      position:fixed;inset:0;z-index:9999;
      display:none;align-items:center;justify-content:center;
      background: radial-gradient(1200px 700px at 10% 10%, rgba(255,255,255,.26), transparent 60%),
                  radial-gradient(1100px 700px at 90% 30%, rgba(255,255,255,.18), transparent 60%),
                  linear-gradient(180deg, #8faac8, #a7bdd5 55%, #95b2cf);
    }
    .loaderCard{
      width:min(92vw, 520px);
      padding:28px 18px;
      border-radius:28px;
      border:1px solid rgba(255,255,255,.5);
      background: rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      text-align:center;
    }
    .loaderIcons{
      display:flex;gap:16px;justify-content:center;align-items:center;
      margin-bottom:14px;font-size:42px;
    }
    .wiggle{
      display:inline-block;
      animation: wiggle 1.05s ease-in-out infinite;
      transform-origin: 50% 80%;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.14));
    }
    .wiggle:nth-child(2){ animation-delay:.12s; }
    .wiggle:nth-child(3){ animation-delay:.24s; }
    @keyframes wiggle{
      0%   { transform: translateY(0) rotate(0deg) scale(1); }
      35%  { transform: translateY(-8px) rotate(-5deg) scale(1.02); }
      70%  { transform: translateY(0) rotate(5deg) scale(1); }
      100% { transform: translateY(0) rotate(0deg) scale(1); }
    }
    .loaderText{
      font-weight:1000;letter-spacing:1px;font-size:22px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 10px 18px rgba(0,0,0,.20);
    }
    .loaderSub{
      margin-top:8px;font-weight:800;font-size:14px;
      color: rgba(255,255,255,.85);opacity:.95;
    }
  </style>
</head>

<body>
  <!-- Loader -->
  <div class="pageLoader" id="pageLoader" aria-live="polite">
    <div class="loaderCard">
      <div class="loaderIcons" aria-hidden="true">
        <span class="wiggle">üêö</span>
        <span class="wiggle">üåä</span>
        <span class="wiggle">üå¥</span>
      </div>
      <div class="loaderText">Smart Properties System</div>
      <div class="loaderSub">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <button class="backBtn" id="btnBack">‚Üê</button>
      <div class="titlebox">
        <p class="title" id="title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡πâ‡∏≤‡∏ô</p>
        <div class="subtitle" id="subTitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>
      </div>
      <div class="badge" id="statusBadge">‚Äî</div>
    </div>

    <div class="grid">
      <!-- Left: Gallery -->
      <div class="card">
        <div class="hero">
          <img id="mainImg" class="skeleton" alt="main" />
          <div class="tagCount" id="tagCount">0 / 0</div>
          <button class="navBtn navPrev" id="prevBtn">‚Äπ</button>
          <button class="navBtn navNext" id="nextBtn">‚Ä∫</button>
        </div>
        <div class="thumbs" id="thumbs"></div>
      </div>

      <!-- Right: Info -->
      <div class="card">
        <div class="pad">
          <div class="hRow">
            <h2 class="h1" id="hpIdText">HP_ID : -</h2>
          </div>

          <div class="kv">
            <div class="k"><div class="t">Plot</div><div class="v" id="plot">-</div></div>
            <div class="k"><div class="t">Price</div><div class="v" id="price">-</div></div>
            <div class="k"><div class="t">Bedrooms</div><div class="v" id="bed">-</div></div>
            <div class="k"><div class="t">Bathrooms</div><div class="v" id="bath">-</div></div>
            <div class="k"><div class="t">Land Area</div><div class="v" id="land">-</div></div>
            <div class="k"><div class="t">Living Area</div><div class="v" id="living">-</div></div>
          </div>

          <div class="line"></div>

          <button class="btn btnPrimary" id="btnEdit">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          <div style="height:10px"></div>
          <button class="btn btnGhost" id="btnMap">üìç ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>

          <div class="desc" id="desc"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/** =========================
 * CONFIG
 * ========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvzszMpjb1Dy3nQDhh64oPYu1-CgL-RSdRe52Df_pejfqkhq-g70z96npgaSyNAw2T/exec";
const qs = new URLSearchParams(location.search);
const hpId = qs.get("id") || qs.get("hpId") || "";

// ‚úÖ FIX: default ‡πÄ‡∏õ‡πá‡∏ô project_000 (‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà)
const project = qs.get("project") || "project_000";

/** Loader helpers */
function showLoader(){
  const el = document.getElementById("pageLoader");
  if(el) el.style.display = "flex";
}
function hideLoader(){
  const el = document.getElementById("pageLoader");
  if(el) el.style.display = "none";
}

function esc(s){
  return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function fmtPrice(v){
  const n = Number(String(v||"").replace(/,/g,""));
  if (!isFinite(n) || n<=0) return "‡∏ø0";
  return "‡∏ø" + n.toLocaleString("en-US");
}

function splitImages(str){
  return String(str||"").split(",").map(s=>s.trim()).filter(Boolean);
}

function statusStyle(statusRaw){
  const s = String(statusRaw||"").trim().toLowerCase();
  if (s.includes("available")) return {border:"rgba(16,185,129,.65)", text:"rgba(5,150,105,1)"};
  if (s.includes("under"))     return {border:"rgba(14,165,233,.55)", text:"rgba(2,132,199,1)"};
  if (s.includes("reserved"))  return {border:"rgba(245,158,11,.55)", text:"rgba(180,83,9,1)"};
  if (s.includes("sold"))      return {border:"rgba(244,63,94,.55)",  text:"rgba(190,18,60,1)"};
  return {border:"rgba(15,23,42,.25)", text:"rgba(15,23,42,.92)"};
}

// ‚úÖ FIX: ‡∏õ‡∏∏‡πà‡∏° Back ‡∏ï‡πâ‡∏≠‡∏á fallback ‡πÑ‡∏õ index ‡∏û‡∏£‡πâ‡∏≠‡∏° project
document.getElementById("btnBack").addEventListener("click", () => {
  const fallback = "index.html?project=" + encodeURIComponent(project);
  history.length > 1 ? history.back() : (location.href = fallback);
});

let images = [];
let idx = 0;
let CURRENT_DETAIL = null;

function setMain(i){
  idx = Math.max(0, Math.min(i, images.length-1));
  const mainImg = document.getElementById("mainImg");
  mainImg.classList.remove("skeleton");
  mainImg.src = images[idx] || mainImg.src;

  document.getElementById("tagCount").textContent = `${idx+1} / ${images.length || 0}`;
  document.querySelectorAll(".thumb").forEach((t, k)=>{
    t.classList.toggle("active", k===idx);
  });
}

function renderThumbs(){
  const wrap = document.getElementById("thumbs");
  wrap.innerHTML = "";
  images.forEach((src, i)=>{
    const t = document.createElement("div");
    t.className = "thumb" + (i===idx ? " active" : "");
    t.innerHTML = `<img src="${esc(src)}" referrerpolicy="no-referrer" loading="lazy" alt="thumb">`;
    t.addEventListener("click", ()=>setMain(i));
    wrap.appendChild(t);
  });
}

document.getElementById("prevBtn").addEventListener("click", ()=>{
  if(!images.length) return;
  setMain((idx - 1 + images.length) % images.length);
});
document.getElementById("nextBtn").addEventListener("click", ()=>{
  if(!images.length) return;
  setMain((idx + 1) % images.length);
});

document.getElementById("btnEdit").addEventListener("click", ()=>{
  if(!hpId) return;
  location.href = `edit.html?id=${encodeURIComponent(hpId)}&project=${encodeURIComponent(project)}`;
});

document.getElementById("btnMap").addEventListener("click", ()=>{
  const m = CURRENT_DETAIL?.Map_Link || CURRENT_DETAIL?.Map_link || CURRENT_DETAIL?.map_link || "";
  if(m) window.open(String(m), "_blank");
});

async function loadDetail(){
  if(!hpId){
    document.getElementById("subTitle").textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö id";
    return;
  }

  showLoader();
  try{
    const url = new URL(SCRIPT_URL);
    url.searchParams.set("mode", "getUnitDetail");
    url.searchParams.set("project", project);
    url.searchParams.set("hpId", hpId);
    url.searchParams.set("t", Date.now());

    const res = await fetch(url.toString(), { cache:"no-store" });
    const data = await res.json();

    if(data?.error) throw new Error(data.error);

    CURRENT_DETAIL = data;

    // Head
    document.getElementById("hpIdText").textContent = `HP_ID : ${hpId}`;
    document.getElementById("title").textContent = String(data.Project_Name || data.project_name || "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡πâ‡∏≤‡∏ô").trim();
    document.getElementById("subTitle").textContent = `Project: ${project}`;

    const st = String(data.Status || data.status || "").trim();
    const b = document.getElementById("statusBadge");
    b.textContent = st || "‚Äî";
    const stStyle = statusStyle(st);
    b.style.borderColor = stStyle.border;
    b.style.color = stStyle.text;

    // Fields
    document.getElementById("plot").textContent = String(data.Plot || data.plot || "-");
    document.getElementById("price").textContent = fmtPrice(data.Price || data.price || 0);
    document.getElementById("bed").textContent = String(data.Bedrooms || data.bedrooms || "-");
    document.getElementById("bath").textContent = String(data.Bathrooms || data.bathrooms || "-");

    const landW = data.Land_Area_sq_w || data.land_area_sq_w || "";
    const landM = data.Land_Area_sq_m || data.land_area_sq_m || "";
    document.getElementById("land").textContent = [landW ? `${landW} sq.w` : "", landM ? `${landM} m¬≤` : ""].filter(Boolean).join(" ¬∑ ") || "-";

    const livingM = data.Living_Area_sq_m || data.living_area_sq_m || "";
    document.getElementById("living").textContent = livingM ? `${livingM} m¬≤` : "-";

    const desc = data.Description || data.description || "";
    document.getElementById("desc").textContent = String(desc || "").trim();

    // Images
    const thumb = String(data.Thumbnail_Image || data.thumbnail_image || "").trim();
    const listStr = String(data.Image_List || data.image_list || "").trim();

    images = [];
    if(thumb) images.push(thumb);
    images = images.concat(splitImages(listStr));

    // unique
    const uniq = [];
    const seen = new Set();
    images.forEach(u=>{
      const s = String(u||"").trim();
      if(!s) return;
      if(seen.has(s)) return;
      seen.add(s);
      uniq.push(s);
    });
    images = uniq;

    if(!images.length){
      document.getElementById("mainImg").classList.remove("skeleton");
      document.getElementById("mainImg").src = "";
      document.getElementById("tagCount").textContent = `0 / 0`;
      document.getElementById("thumbs").innerHTML = "";
    }else{
      idx = 0;
      renderThumbs();
      setMain(0);
    }

  }catch(err){
    console.error(err);
    document.getElementById("subTitle").textContent = "‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    document.getElementById("desc").textContent = String(err.message || err);
  }finally{
    hideLoader();
  }
}

loadDetail();
</script>
</body>
</html>
