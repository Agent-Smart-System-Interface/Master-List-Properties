<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PROJECT DASHBOARD</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    body{font-family:Kanit,sans-serif}
  </style>
</head>

<body class="bg-slate-100 min-h-screen">
  <!-- Top bar -->
  <div class="bg-white border-b border-slate-200 sticky top-0 z-20">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a id="homeBtn" href="index.html?project=project_000"
         class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-slate-900 text-white hover:bg-blue-600 active:scale-95 transition"
         title="Home">
        üè†
      </a>

      <div class="flex-1">
        <div class="text-slate-900 font-extrabold text-lg tracking-tight">PROJECT DASHBOARD</div>
        <div class="text-slate-500 text-xs font-semibold">Admin Panel</div>
      </div>

      <div class="text-right">
        <div class="text-slate-900 font-extrabold text-sm" id="projectChip">project_000</div>
        <div class="text-slate-500 text-[11px] font-semibold" id="countChip">0 Units</div>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="max-w-6xl mx-auto px-4 py-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <div class="text-slate-500 text-xs font-bold">Filter</div>
        <select id="plotSelect" class="mt-2 w-full border border-slate-200 rounded-xl px-3 py-2 font-bold">
          <option value="__all__">All Plots</option>
        </select>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <div class="text-slate-500 text-xs font-bold">Sort</div>
        <select id="sortSelect" class="mt-2 w-full border border-slate-200 rounded-xl px-3 py-2 font-bold">
          <option value="updated_desc">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
          <option value="price_desc">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á ‚Üí ‡∏ï‡πà‡∏≥</option>
          <option value="price_asc">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥ ‚Üí ‡∏™‡∏π‡∏á</option>
        </select>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <div class="text-slate-500 text-xs font-bold">Search</div>
        <input id="q" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ HP_ID / Plot / Status"
               class="mt-2 w-full border border-slate-200 rounded-xl px-3 py-2 font-bold outline-none focus:ring-2 focus:ring-blue-200">
      </div>
    </div>

    <div id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

    <div id="empty" class="hidden mt-6 bg-white border border-slate-200 rounded-2xl p-5 text-center text-slate-600 font-bold">
      ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    </div>
  </div>

  <!-- Loader -->
  <div id="loader" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-5 w-[min(92vw,420px)] text-center shadow-xl">
      <div class="text-3xl mb-2">‚è≥</div>
      <div class="font-extrabold text-slate-900">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>
      <div class="text-slate-500 text-sm mt-1">Dashboard</div>
    </div>
  </div>

  <script>
    // ================================
    // CONFIG
    // ================================
    const API_URL = "https://script.google.com/macros/s/AKfycbxvzszMpjb1Dy3nQDhh64oPYu1-CgL-RSdRe52Df_pejfqkhq-g70z96npgaSyNAw2T/exec";
    const urlParams = new URLSearchParams(window.location.search);

    // ‚úÖ FIX: default ‡πÄ‡∏õ‡πá‡∏ô project_000 (‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà)
    const PROJECT_ID = urlParams.get("project") || "project_000";

    // ‚úÖ FIX: ‡∏õ‡∏∏‡πà‡∏° Home ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡πà‡∏ß‡∏á project ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    const HOME_URL = "index.html?project=" + encodeURIComponent(PROJECT_ID);
    document.getElementById("homeBtn").href = HOME_URL;

    // ================================
    // UI Helpers
    // ================================
    const $ = (id) => document.getElementById(id);

    function showLoader(on){
      const el = $("loader");
      if(!el) return;
      el.style.display = on ? "flex" : "none";
    }

    function esc(s){
      return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function fmtPrice(v){
      const n = Number(String(v||"").replace(/,/g,""));
      if(!isFinite(n) || n<=0) return "‡∏ø0";
      return "‡∏ø" + n.toLocaleString("en-US");
    }

    function normalizePlot(p){ return String(p||"").trim(); }

    function statusBadge(status){
      const s = String(status||"").toLowerCase();
      if(s.includes("available")) return "bg-emerald-50 text-emerald-700 border-emerald-200";
      if(s.includes("under"))     return "bg-amber-50 text-amber-700 border-amber-200";
      if(s.includes("reserved"))  return "bg-sky-50 text-sky-700 border-sky-200";
      if(s.includes("sold"))      return "bg-rose-50 text-rose-700 border-rose-200";
      return "bg-slate-50 text-slate-700 border-slate-200";
    }

    // ================================
    // Data
    // ================================
    let all = [];
    let filtered = [];

    // ================================
    // Fetch
    // ================================
    async function fetchUnitList(){
      const res = await fetch(`${API_URL}?mode=getUnitList&project=${encodeURIComponent(PROJECT_ID)}&t=${Date.now()}`, { cache:"no-store" });
      const data = await res.json();
      if(!Array.isArray(data)) throw new Error(data?.error || "API invalid");
      return data;
    }

    // ================================
    // Render
    // ================================
    function buildPlotOptions(list){
      const set = new Set();
      list.forEach(x=>{
        const p = normalizePlot(x.plot);
        if(p) set.add(p);
      });
      const plots = Array.from(set).sort((a,b)=>a.localeCompare(b,"en"));
      $("plotSelect").innerHTML =
        `<option value="__all__">All Plots</option>` +
        plots.map(p=>`<option value="${esc(p)}">${esc(p)}</option>`).join("");
    }

    function applyFilters(){
      const plotVal = $("plotSelect").value;
      const sortVal = $("sortSelect").value;
      const q = String($("q").value||"").trim().toLowerCase();

      filtered = all.filter(x=>{
        if(plotVal !== "__all__" && normalizePlot(x.plot) !== plotVal) return false;
        if(q){
          const hay = `${x.id} ${x.plot} ${x.status}`.toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });

      filtered.sort((a,b)=>{
        const pa = Number(String(a.price||"").replace(/,/g,"")) || 0;
        const pb = Number(String(b.price||"").replace(/,/g,"")) || 0;
        const ua = new Date(a.lastUpdated||0).getTime() || 0;
        const ub = new Date(b.lastUpdated||0).getTime() || 0;

        if(sortVal === "price_asc") return pa - pb;
        if(sortVal === "price_desc") return pb - pa;
        return ub - ua; // updated_desc
      });

      renderGrid();
    }

    function renderGrid(){
      const grid = $("grid");
      grid.innerHTML = "";

      $("countChip").textContent = `${filtered.length} Units`;
      $("projectChip").textContent = PROJECT_ID;

      if(!filtered.length){
        $("empty").classList.remove("hidden");
        return;
      }
      $("empty").classList.add("hidden");

      filtered.forEach(item=>{
        const id = item.id || "";
        const plot = item.plot || "";
        const price = item.price || "";
        const status = item.status || "";
        const thumb = item.thumbnail || "";

        const card = document.createElement("div");
        card.className = "bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden";

        card.innerHTML = `
          <div class="aspect-[16/10] bg-slate-100 relative overflow-hidden">
            ${thumb ? `<img src="${esc(thumb)}" class="w-full h-full object-cover" referrerpolicy="no-referrer" loading="lazy">` : ""}
            <div class="absolute top-3 right-3 px-3 py-1 rounded-full text-xs font-extrabold border ${statusBadge(status)}">
              ${esc(status || "‚Äî")}
            </div>
          </div>
          <div class="p-4">
            <div class="flex items-end justify-between gap-2">
              <div class="font-extrabold text-slate-800">PLOT : ${esc(plot || "-")}</div>
              <div class="font-extrabold text-slate-900">${esc(fmtPrice(price))}</div>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2">
              <button class="w-full py-2 rounded-xl bg-slate-900 text-white font-extrabold hover:bg-blue-600 active:scale-95 transition"
                onclick="window.location.href='edit.html?id=${encodeURIComponent(id)}&project=${encodeURIComponent(PROJECT_ID)}'">
                ‚úèÔ∏è Edit
              </button>

              <button class="w-full py-2 rounded-xl bg-emerald-100 text-emerald-800 font-extrabold hover:bg-emerald-200 active:scale-95 transition"
                onclick="window.location.href='edit.html?id=${encodeURIComponent(id)}&project=${encodeURIComponent(PROJECT_ID)}'">
                üîç View
              </button>
            </div>

            <div class="mt-2 text-[11px] text-slate-500 font-bold">HP_ID : ${esc(id)}</div>
          </div>
        `;

        grid.appendChild(card);
      });
    }

    // ================================
    // Init
    // ================================
    (function init(){
      $("plotSelect").addEventListener("change", applyFilters);
      $("sortSelect").addEventListener("change", applyFilters);
      $("q").addEventListener("input", applyFilters);

      loadAll();
    })();

    async function loadAll(){
      try{
        showLoader(true);
        const data = await fetchUnitList();
        all = data.map(x=>({
          id: x.id || "",
          plot: x.plot || "",
          thumbnail: x.thumbnail || "",
          price: x.price || "",
          status: x.status || "",
          lastUpdated: x.lastUpdated || ""
        }));

        buildPlotOptions(all);
        applyFilters();
      }catch(err){
        console.error(err);
        $("empty").classList.remove("hidden");
        $("empty").textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö project/tab ‡πÅ‡∏•‡∏∞ Apps Script)";
      }finally{
        showLoader(false);
      }
    }
  </script>
</body>
</html>
