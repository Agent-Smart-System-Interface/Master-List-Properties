<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PROJECT DASHBOARD</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body { font-family: 'Kanit', sans-serif; background: #f8fafc; }
  </style>
</head>

<body class="p-4 md:p-10 italic">
  <div class="max-w-6xl mx-auto">

    <div class="bg-slate-900 rounded-[2.2rem] px-6 py-6 md:px-10 md:py-7 text-white mb-6 shadow-2xl flex items-center justify-between">
      <div id="projectTitle" class="text-xl md:text-2xl font-bold tracking-tight italic truncate">
        Loading...
      </div>

      <a id="homeBtn" href="index.html"
         class="w-14 h-14 md:w-14 md:h-14 rounded-2xl bg-white/10 hover:bg-white/20 flex items-center justify-center transition-all active:scale-95"
         aria-label="Home">
        <i class="fa-solid fa-house text-xl"></i>
      </a>
    </div>

    <!-- ‚úÖ NEW: MASTER ADD BAR (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô + Run HP ID ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) -->
    <div id="masterAddBar" class="hidden bg-white rounded-[2rem] shadow-2xl border border-slate-100 p-4 md:p-5 mb-6">
      <div class="flex items-start md:items-center justify-between gap-4 flex-col md:flex-row">
        <div class="min-w-0">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-slate-900 text-white flex items-center justify-center shadow">
              <i class="fa-solid fa-plus"></i>
            </div>
            <div class="min-w-0">
              <div class="text-sm md:text-base font-extrabold text-slate-900 italic truncate">
                Master Add Unit
              </div>
              <div class="text-[11px] md:text-xs font-bold text-slate-400 uppercase tracking-widest">
                Add new house row ‚Ä¢ Auto Run HP ID ‚Ä¢ then go to Edit
              </div>
            </div>
          </div>
        </div>

        <div class="w-full md:w-auto flex flex-col md:flex-row gap-3">
          <!-- Plot -->
          <div class="w-full md:w-44">
            <label class="block text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-1">Plot</label>
            <input id="addPlot" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô Z-06"
              class="w-full rounded-2xl px-4 py-3 bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-slate-200 text-slate-900 font-bold italic">
          </div>

          <!-- Status -->
          <div class="w-full md:w-56">
            <label class="block text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-1">Status</label>
            <select id="addStatus"
              class="w-full rounded-2xl px-4 py-3 bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-slate-200 text-slate-900 font-bold italic">
              <option value="Available">Available</option>
              <option value="Under Construction">Under Construction</option>
              <option value="Reserved">Reserved</option>
              <option value="Sold">Sold</option>
              <option value="-">-</option>
            </select>
          </div>

          <!-- Visibility -->
          <div class="w-full md:w-44">
            <label class="block text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-1">Visibility</label>
            <select id="addVisibility"
              class="w-full rounded-2xl px-4 py-3 bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-slate-200 text-slate-900 font-bold italic">
              <option value="Offline">Offline</option>
              <option value="Pending">Pending</option>
              <option value="Live">Live</option>
              <option value="-">-</option>
            </select>
          </div>

          <!-- Button -->
          <div class="w-full md:w-auto md:self-end">
            <button id="btnCreateUnit" type="button"
              class="w-full md:w-auto px-6 py-3 rounded-2xl bg-slate-900 text-white font-extrabold italic shadow-lg hover:opacity-90 active:scale-95 transition-all flex items-center justify-center gap-2">
              <i class="fa-solid fa-bolt"></i>
              Create & Edit
            </button>
          </div>
        </div>
      </div>

      <div id="addBarMsg" class="mt-3 hidden">
        <div class="rounded-2xl px-4 py-3 bg-slate-50 border border-slate-200 text-slate-700 text-xs font-bold italic"></div>
      </div>

      <div class="mt-3 text-[11px] text-slate-400 font-bold">
        * ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Master (‡∏ñ‡πâ‡∏≤‡∏ù‡∏±‡πà‡∏á API ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò)
      </div>
    </div>
    <!-- /NEW BAR -->

    <div id="loadingBlock" class="bg-white rounded-[2rem] shadow-2xl border border-slate-100 p-8 text-center text-slate-300 font-bold animate-pulse uppercase">
      üîÑ Syncing database...
    </div>

    <div id="mobileList" class="hidden space-y-4"></div>

    <div id="desktopTableWrap" class="hidden bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-100">
      <table class="w-full text-center">
        <thead class="bg-slate-900 text-white text-[10px] uppercase">
          <tr>
            <th class="py-6 pl-8 text-left">Cover</th>
            <th class="text-left">Unit ID</th>
            <th class="text-left">Plot</th>
            <th>Status</th>
            <th>Visibility</th>
            <th>Manage</th>
          </tr>
        </thead>
        <tbody id="unitTableBody" class="text-xs"></tbody>
      </table>
    </div>

  </div>

  <script>
    // ================================
    // CONFIG
    // ================================
    const API_URL = "https://script.google.com/macros/s/AKfycbyNPiuM1Rz70r6E38eRLQoQXIrNUTKsQsqVRLU2tOmwO9K9HfBBnO-7-I9fn6UlTZWk/exec";
    const urlParams = new URLSearchParams(window.location.search);
    const PROJECT_ID = urlParams.get("project") || "HP00";
    const HOME_URL = "index.html";
    document.getElementById("homeBtn").href = HOME_URL;

    // ‚úÖ token ‡∏à‡∏≤‡∏Å localStorage (‡∏°‡∏≤‡∏à‡∏≤‡∏Å gateway)
    const TOKEN = localStorage.getItem("HP_AUTH_TOKEN") || "";

    // ‚úÖ (best-effort) role flag ‡∏à‡∏≤‡∏Å localStorage (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const ROLE =
      (localStorage.getItem("HP_AUTH_ROLE") ||
       localStorage.getItem("HP_AUTH_LEVEL") ||
       localStorage.getItem("HP_ROLE") ||
       "").toString().trim();

    const IS_MASTER =
      ROLE.toLowerCase() === "master" ||
      ROLE.toLowerCase() === "hq" ||
      ROLE.toLowerCase() === "owner";

    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ token ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ gateway
    if (!TOKEN) {
      location.href = `gateway.html?project=${encodeURIComponent(PROJECT_ID)}`;
    }

    // ================================
    // HELPERS
    // ================================
    function statusBadge(status) {
      const raw = (status ?? "").toString().trim();
      const s = raw.toLowerCase();

      if (!raw || raw === "-") {
        return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full font-bold text-[11px] bg-slate-100 text-slate-500">
                  <span class="w-2 h-2 rounded-full bg-slate-300"></span> -
                </span>`;
      }
      if (s.includes("available")) {
        return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full font-bold text-[11px] bg-emerald-50 text-emerald-700">
                  <span class="w-2 h-2 rounded-full bg-emerald-500"></span> Available
                </span>`;
      }
      if (s.includes("under") || s.includes("construct")) {
        return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full font-bold text-[11px] bg-sky-50 text-sky-700">
                  <span class="w-2 h-2 rounded-full bg-sky-500"></span> Under Construction
                </span>`;
      }
      if (s.includes("reserved")) {
        return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full font-bold text-[11px] bg-amber-50 text-amber-700">
                  <span class="w-2 h-2 rounded-full bg-amber-500"></span> Reserved
                </span>`;
      }
      if (s.includes("sold")) {
        return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full font-bold text-[11px] bg-rose-50 text-rose-700">
                  <span class="w-2 h-2 rounded-full bg-rose-500"></span> Sold
                </span>`;
      }
      return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full font-bold text-[11px] bg-slate-50 text-slate-700">
                <span class="w-2 h-2 rounded-full bg-slate-400"></span> ${escapeHtml(raw)}
              </span>`;
    }

    function visibilityBadge(v) {
      const raw = (v ?? "").toString().trim();
      const s = raw.toLowerCase();

      if (!raw || raw === "-") {
        return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full font-bold text-[11px] bg-slate-100 text-slate-500">
                  <span class="w-2 h-2 rounded-full bg-slate-300"></span> -
                </span>`;
      }
      if (s.includes("live") || s.includes("online")) {
        return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full font-bold text-[11px] bg-blue-50 text-blue-700">
                  <span class="w-2 h-2 rounded-full bg-blue-500"></span> Live
                </span>`;
      }
      if (s.includes("pending") || s.includes("review")) {
        return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full font-bold text-[11px] bg-amber-50 text-amber-700">
                  <span class="w-2 h-2 rounded-full bg-amber-500"></span> Pending
                </span>`;
      }
      if (s.includes("off") || s.includes("offline") || s.includes("hide")) {
        return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full font-bold text-[11px] bg-slate-100 text-slate-600">
                  <span class="w-2 h-2 rounded-full bg-slate-400"></span> Offline
                </span>`;
      }
      return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full font-bold text-[11px] bg-slate-50 text-slate-700">
                <span class="w-2 h-2 rounded-full bg-slate-400"></span> ${escapeHtml(raw)}
              </span>`;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function isMobile() {
      return window.matchMedia("(max-width: 768px)").matches;
    }

    function pickThumb(u) {
      return (u.Thumbnail_Image || u.thumbnail || u.thumb || u.thumbUrl || "").toString().trim();
    }

    function thumbTag(url, size = "mobile") {
      const base = (size === "desktop")
        ? "w-10 h-14 rounded-xl"
        : "w-16 h-20 rounded-2xl";

      if (!url) {
        return `<div class="${base} bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-300 font-bold">üè†</div>`;
      }
      return `<img src="${url}" class="${base} object-cover border border-slate-200 shadow-sm" loading="lazy" decoding="async">`;
    }

    // ================================
    // ‚úÖ EDIT NAV (FIX: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏¥‡∏ô‡∏™‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ edit ‡πÑ‡∏î‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå)
    // ================================
    function goEditById(id){
      const hpId = (id || "").toString().trim();
      if (!hpId || hpId === "-") return;

      // ‚úÖ ‡∏™‡πà‡∏á token ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ edit (edit.html ‡∏à‡∏∞‡πÉ‡∏ä‡πâ token ‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å getUnitDetail)
      const url =
        `edit.html?id=${encodeURIComponent(hpId)}&project=${encodeURIComponent(PROJECT_ID)}&token=${encodeURIComponent(TOKEN)}`;

      window.location.href = url;
    }

    // ‡πÉ‡∏ä‡πâ event delegation ‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ onclick ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    document.addEventListener("click", (ev) => {
      const btn = ev.target.closest("[data-edit-id]");
      if (!btn) return;
      ev.preventDefault();
      const id = btn.getAttribute("data-edit-id") || "";
      goEditById(id);
    });

    // ================================
    // ‚úÖ NEW: MASTER CREATE UNIT (Auto Run HP ID by API)
    // ================================
    function showAddMsg(text, type = "info") {
      const wrap = document.getElementById("addBarMsg");
      const box = wrap.querySelector("div");
      wrap.classList.remove("hidden");

      box.className = "rounded-2xl px-4 py-3 border text-xs font-bold italic";
      if (type === "ok") box.classList.add("bg-emerald-50", "border-emerald-200", "text-emerald-800");
      else if (type === "err") box.classList.add("bg-rose-50", "border-rose-200", "text-rose-800");
      else box.classList.add("bg-slate-50", "border-slate-200", "text-slate-700");

      box.textContent = text;
    }

    function setCreateBusy(on) {
      const btn = document.getElementById("btnCreateUnit");
      const plot = document.getElementById("addPlot");
      const st = document.getElementById("addStatus");
      const vis = document.getElementById("addVisibility");

      btn.disabled = !!on;
      plot.disabled = !!on;
      st.disabled = !!on;
      vis.disabled = !!on;

      btn.classList.toggle("opacity-60", !!on);
      btn.classList.toggle("cursor-not-allowed", !!on);

      btn.innerHTML = on
        ? `<i class="fa-solid fa-spinner fa-spin"></i> Creating...`
        : `<i class="fa-solid fa-bolt"></i> Create & Edit`;
    }

    async function createUnitMaster() {
      // (UI-level) master gate ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏≠‡∏∑‡πà‡∏ô ‚Äî ‡∏ù‡∏±‡πà‡∏á API ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏µ‡∏Å‡∏ä‡∏±‡πâ‡∏ô
      if (!TOKEN) {
        showAddMsg("No token. Please login again.", "err");
        return;
      }

      const plot = (document.getElementById("addPlot").value || "").toString().trim();
      const status = (document.getElementById("addStatus").value || "-").toString().trim();
      const visibility = (document.getElementById("addVisibility").value || "Offline").toString().trim();

      if (!plot) {
        showAddMsg("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Plot ‡∏Å‡πà‡∏≠‡∏ô", "err");
        return;
      }

      setCreateBusy(true);
      showAddMsg("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô HP ID ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...", "info");

      try {
        // ‚úÖ IMPORTANT:
        // ‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á Google Apps Script ‡∏ó‡∏µ‡πà "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà + ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ newId"
        // ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: createUnit
        const payload = {
          mode: "createUnit",
          project: PROJECT_ID,
          token: TOKEN,
          plot: plot,
          status: status,
          sysStatus: visibility
        };

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });

        const out = await res.json();

        // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö:
        // { ok:true, id:"HP00-0006" } ‡∏´‡∏£‡∏∑‡∏≠ { success:true, newId:"..." } ‡∏´‡∏£‡∏∑‡∏≠ { id:"..." }
        const ok = !!(out && (out.ok || out.success || out.status === "ok"));
        const newId = (out && (out.id || out.newId || out.hpId || out.HP_ID || "")).toString().trim();

        if (!ok || !newId) {
          const msg = (out && (out.message || out.error || out.reason)) ? String(out.message || out.error || out.reason) : "Create failed (API rejected or no id returned)";
          showAddMsg("‚ùå " + msg, "err");
          setCreateBusy(false);
          return;
        }

        showAddMsg(`‚úÖ Created: ${newId}  ‚Üí ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Edit...`, "ok");

        // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î list ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô ‡πÜ (‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á) ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ edit
        try { await reloadUnitListSilently(); } catch(e) {}

        setTimeout(() => goEditById(newId), 350);

      } catch (e) {
        showAddMsg("‚ö†Ô∏è Network/API error while creating unit", "err");
        setCreateBusy(false);
      }
    }

    document.addEventListener("click", (ev) => {
      const btn = ev.target.closest("#btnCreateUnit");
      if (!btn) return;
      ev.preventDefault();
      createUnitMaster();
    });

    // ================================
    // RENDERERS
    // ================================
    function renderDesktop(units) {
      const tbody = document.getElementById("unitTableBody");

      if (!units || units.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="py-16 text-slate-400 font-bold">No data</td></tr>`;
        return;
      }

      tbody.innerHTML = units.map(u => {
        const id = (u.id || "-").toString();
        const plot = u.plot || "-";
        const unitStatus = u.status || u.unitStatus || "-";
        const sysStatus = u.sysStatus || "-";
        const thumb = pickThumb(u);

        return `
          <tr class="hover:bg-slate-50 border-b">
            <td class="py-4 pl-8 text-left">
              ${thumbTag(thumb, "desktop")}
            </td>
            <td class="text-left font-bold text-slate-900 text-[11px]">${escapeHtml(id)}</td>
            <td class="text-left font-extrabold text-slate-800 text-[15px]">${escapeHtml(plot)}</td>
            <td>${statusBadge(unitStatus)}</td>
            <td>${visibilityBadge(sysStatus)}</td>
            <td>
              <button
                type="button"
                data-edit-id="${escapeHtml(id)}"
                class="p-2 text-orange-500 hover:scale-110 transition-all"
                aria-label="Edit"
                title="Edit"
              >
                <i class="fa-solid fa-pen-to-square"></i>
              </button>
            </td>
          </tr>
        `;
      }).join("");
    }

    function renderMobile(units) {
      const list = document.getElementById("mobileList");

      if (!units || units.length === 0) {
        list.innerHTML = `<div class="bg-white rounded-[2rem] shadow-2xl border border-slate-100 p-8 text-center text-slate-400 font-bold">No data</div>`;
        return;
      }

      list.innerHTML = units.map(u => {
        const id = (u.id || "-").toString();
        const plot = u.plot || "-";
        const unitStatus = u.status || u.unitStatus || "-";
        const sysStatus = u.sysStatus || "-";
        const thumb = pickThumb(u);

        return `
          <div class="bg-white rounded-[2rem] shadow-2xl border border-slate-100 p-4">
            <div class="flex items-start justify-between gap-3">
              <div class="flex gap-4 min-w-0">
                <div class="shrink-0">
                  ${thumbTag(thumb, "mobile")}
                </div>

                <div class="min-w-0">
                  <div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">Unit ID</div>
                  <div class="text-[11px] font-bold text-slate-900 italic truncate">${escapeHtml(id)}</div>

                  <div class="mt-2">
                    <div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">Plot</div>
                    <div class="text-[22px] font-extrabold text-slate-900 italic leading-tight">${escapeHtml(plot)}</div>
                  </div>
                </div>
              </div>

              <button
                type="button"
                data-edit-id="${escapeHtml(id)}"
                class="w-12 h-12 rounded-2xl bg-orange-50 text-orange-500 flex items-center justify-center hover:bg-orange-100 transition-all active:scale-95 shrink-0"
                aria-label="Edit"
                title="Edit"
              >
                <i class="fa-solid fa-pen"></i>
              </button>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-4">
              <div class="bg-slate-50 rounded-2xl p-3">
                <div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">Visibility</div>
                <div class="mt-2">${visibilityBadge(sysStatus)}</div>
              </div>

              <div class="bg-slate-50 rounded-2xl p-3">
                <div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">Status</div>
                <div class="mt-2">${statusBadge(unitStatus)}</div>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    function showLoading(on) {
      const lb = document.getElementById("loadingBlock");
      if (on) {
        lb.classList.remove("hidden");
        lb.classList.add("animate-pulse");
        lb.innerText = "üîÑ Syncing database...";
      } else {
        lb.classList.add("hidden");
      }
    }

    // ================================
    // LOAD + CACHE + SMART RESIZE
    // ================================
    let CACHE_UNITS = [];
    let CURRENT_MOBILE = isMobile();

    function renderByViewport() {
      const nowMobile = isMobile();

      document.getElementById("mobileList").classList.toggle("hidden", !nowMobile);
      document.getElementById("desktopTableWrap").classList.toggle("hidden", nowMobile);

      if (nowMobile) renderMobile(CACHE_UNITS);
      else renderDesktop(CACHE_UNITS);

      CURRENT_MOBILE = nowMobile;
    }

    async function reloadUnitListSilently() {
      const res = await fetch(`${API_URL}?mode=getUnitList&project=${encodeURIComponent(PROJECT_ID)}&t=${Date.now()}`);
      const data = await res.json();
      CACHE_UNITS = Array.isArray(data) ? data : [];
      renderByViewport();
      return CACHE_UNITS;
    }

    async function init() {
      try {
        showLoading(true);

        // ‚úÖ show master add bar (‡∏ñ‡πâ‡∏≤ role ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤ master) ‚Äî ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô
        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡πá‡∏ö role ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô localStorage: ‡∏ù‡∏±‡πà‡∏á API ‡∏à‡∏∞‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
        if (IS_MASTER) {
          document.getElementById("masterAddBar").classList.remove("hidden");
        }

        const res = await fetch(`${API_URL}?mode=getUnitList&project=${encodeURIComponent(PROJECT_ID)}&t=${Date.now()}`);
        const data = await res.json();

        let projectName = "";
        if (Array.isArray(data) && data.length > 0) {
          projectName = (data.find(x => x && x.projectName && String(x.projectName).trim() !== "")?.projectName) || "";
        }
        document.getElementById("projectTitle").innerText = projectName ? projectName : PROJECT_ID;

        CACHE_UNITS = Array.isArray(data) ? data : [];
        showLoading(false);

        renderByViewport();

      } catch (e) {
        document.getElementById("projectTitle").innerText = PROJECT_ID;
        const lb = document.getElementById("loadingBlock");
        lb.classList.remove("animate-pulse");
        lb.innerText = "‚ö†Ô∏è Connection Error";
      }
    }

    window.addEventListener("resize", () => {
      const nowMobile = isMobile();
      if (nowMobile !== CURRENT_MOBILE) {
        renderByViewport();
      }
    });

    window.onload = init;
  </script>
</body>
</html>
