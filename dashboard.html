<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>body { font-family: 'Kanit', sans-serif; background: #f8fafc; }</style>
</head>
<body class="p-4 md:p-10 italic">
  <div class="max-w-6xl mx-auto">
    <div class="bg-slate-900 rounded-[2.2rem] p-6 text-white mb-6 flex items-center justify-between">
      <div id="projectTitle" class="text-xl font-bold italic">Loading Dashboard...</div>
      <a href="index.html" class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center hover:bg-white/20">
        <i class="fa-solid fa-house"></i>
      </a>
    </div>

    <div id="masterAddBar" class="hidden bg-white rounded-[2rem] p-6 mb-6 shadow-xl border border-slate-100">
      <div class="flex flex-col md:flex-row gap-4">
        <input id="addPlot" class="flex-1 p-3 border rounded-xl font-bold italic" placeholder="Plot เช่น Z-15">
        <select id="addVisibility" class="p-3 border rounded-xl font-bold italic">
          <option value="Offline">Offline</option>
          <option value="Pending" selected>Pending</option>
          <option value="Live">Live</option>
        </select>
        <button id="btnCreate" class="px-6 py-3 bg-slate-900 text-white rounded-xl font-bold italic hover:bg-blue-600">Create & Edit</button>
      </div>
    </div>

    <div id="tableWrap" class="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden">
      <table class="w-full text-center">
        <thead class="bg-slate-900 text-white text-xs uppercase">
          <tr>
            <th class="py-6">ID</th>
            <th>Plot</th>
            <th>Status</th>
            <th>Visibility</th>
            <th>Manage</th>
          </tr>
        </thead>
        <tbody id="unitTableBody" class="text-sm"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyNPiuM1Rz70r6E38eRLQoQXIrNUTKsQsqVRLU2tOmwO9K9HfBBnO-7-I9fn6UlTZWk/exec";
    const TOKEN = localStorage.getItem("HP_AUTH_TOKEN");
    const ROLE = localStorage.getItem("HP_AUTH_ROLE");
    const PROJECT = "HP00";

    if(!TOKEN) location.href = "gateway.html";
    if(ROLE === "HQ") document.getElementById("masterAddBar").classList.remove("hidden");

    async function init() {
      try {
        // ✅ แนบ Token เพื่อให้ Admin เห็นรายการ Offline
        const res = await fetch(`${API_URL}?mode=getUnitList&project=${PROJECT}&token=${TOKEN}`);
        const data = await res.json();
        
        document.getElementById("projectTitle").textContent = (data[0]?.projectName || PROJECT) + " Dashboard";
        
        const tbody = document.getElementById("unitTableBody");
        tbody.innerHTML = data.map(u => `
          <tr class="border-b hover:bg-slate-50">
            <td class="py-4 font-bold">${u.id}</td>
            <td class="font-extrabold text-slate-800">${u.plot}</td>
            <td><span class="px-3 py-1 rounded-full bg-slate-100 text-[10px] font-bold">${u.status}</span></td>
            <td><span class="px-3 py-1 rounded-full font-bold text-[10px] ${u.sysStatus==='Offline'?'bg-rose-50 text-rose-600':'bg-blue-50 text-blue-600'}">${u.sysStatus}</span></td>
            <td><button onclick="location.href='edit.html?id=${u.id}'" class="text-orange-500 hover:scale-125 transition-all"><i class="fa-solid fa-pen-to-square"></i></button></td>
          </tr>
        `).join("");
      } catch(e) { alert("Error loading dashboard"); }
    }

    window.onload = init;
  </script>
</body>
</html>
