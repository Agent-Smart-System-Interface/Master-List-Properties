<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxvzszMpjb1Dy3nQDhh64oPYu1-CgL-RSdRe52Df_pejfqkhq-g70z96npgaSyNAw2T/exec";
  const urlParams = new URLSearchParams(location.search);
  const HP_ID = urlParams.get("id");
  const PROJECT = urlParams.get("project") || "HP00";

  let existingGallery = [];
  let removedGallery = [];
  let newGalleryQueue = [];

  let pdfLinks = { sales:"", material:"", floorplan:"" };
  const MAX_PDF_BYTES = 6 * 1024 * 1024;

  const SUBDISTRICTS_BY_DISTRICT = {
    "Hua Hin": ["Hua Hin","Nong Kae","Hin Lek Fai","Thap Tai","Huai Sat Yai","Bueng Nakhon","Nong Phlap"],
    "Cha-am": ["Cha-am","Bang Kao","Na Yang","Khao Yai","Nong Sala","Huai Sai Nuea","Rai Mai Phatthana"],
    "Pranburi": ["Pran Buri","Pak Nam Pran","Wang Phong","Nong Ta Taem","Nong Din Daeng","Khao Noi","Khao Chao"]
  };

  function switchTab(tab) {
    document.getElementById("tab-photo").classList.toggle("hidden", tab !== "photo");
    document.getElementById("tab-info").classList.toggle("hidden", tab !== "info");
    document.getElementById("btn-photo").classList.toggle("tab-active", tab === "photo");
    document.getElementById("btn-info").classList.toggle("tab-active", tab === "info");
  }

  function setSubDistrictOptions(selectedDistrict, selectedSubDistrict = "") {
    const subSel = document.getElementById("SubDistrict");
    const list = SUBDISTRICTS_BY_DISTRICT[selectedDistrict] || [];
    subSel.innerHTML = `<option value="">-- Select Sub-District --</option>`;

    if (!selectedDistrict || list.length === 0) {
      subSel.disabled = true;
      subSel.value = "";
      return;
    }

    list.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      subSel.appendChild(opt);
    });

    subSel.disabled = false;

    if (selectedSubDistrict) {
      subSel.value = selectedSubDistrict;
      if (subSel.value !== selectedSubDistrict) {
        const custom = document.createElement("option");
        custom.value = selectedSubDistrict;
        custom.textContent = selectedSubDistrict + " (custom)";
        subSel.appendChild(custom);
        subSel.value = selectedSubDistrict;
      }
    }
  }

  function bindDistrictChange() {
    const districtSel = document.getElementById("District");
    districtSel.addEventListener("change", () => {
      setSubDistrictOptions(districtSel.value, "");
    });
  }

  function previewFile(input, targetId) {
    const file = input.files && input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => document.getElementById(targetId).innerHTML =
      `<img src="${e.target.result}" class="w-full h-full object-cover">`;
    reader.readAsDataURL(file);
  }

  function renderGallery() {
    const box = document.getElementById("galleryPreview");
    const keptExisting = existingGallery.filter(u => !removedGallery.includes(u));
    const tiles = [];

    keptExisting.forEach((url) => {
      tiles.push(`
        <div class="img-tile">
          <div class="img-x" onclick="removeExistingImage('${encodeURIComponent(url)}')" title="Remove">‚úï</div>
          <img src="${url}" class="w-full h-12 object-cover rounded-lg">
        </div>
      `);
    });

    newGalleryQueue.forEach((it, idx) => {
      tiles.push(`
        <div class="img-tile">
          <div class="img-x" onclick="removeNewQueuedImage(${idx})" title="Remove">‚úï</div>
          <img src="${it.previewUrl}" class="w-full h-12 object-cover rounded-lg">
        </div>
      `);
    });

    box.innerHTML = tiles.length
      ? tiles.join("")
      : `<span class="text-4xl text-slate-200 col-span-4 self-center justify-self-center">üóÇÔ∏è</span>`;
  }

  window.removeExistingImage = function(encodedUrl) {
    const url = decodeURIComponent(encodedUrl);
    if (!removedGallery.includes(url)) removedGallery.push(url);
    renderGallery();
  }

  window.removeNewQueuedImage = function(index) {
    if (index < 0 || index >= newGalleryQueue.length) return;
    try { URL.revokeObjectURL(newGalleryQueue[index].previewUrl); } catch(e){}
    newGalleryQueue.splice(index, 1);
    renderGallery();
  }

  window.onPickGalleryFiles = function(input) {
    const files = Array.from(input.files || []);
    if (!files.length) return;
    files.forEach(f => {
      const url = URL.createObjectURL(f);
      newGalleryQueue.push({ file: f, previewUrl: url });
    });
    input.value = "";
    renderGallery();
  }

  function setPdfText(key, text) {
    const map = { sales: "salesPdfText", material: "materialPdfText", floorplan: "floorplanPdfText" };
    const el = document.getElementById(map[key]);
    if (el) el.textContent = text || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå";
  }

  window.openPdf = function(key) {
    const link = (pdfLinks && pdfLinks[key]) ? String(pdfLinks[key]).trim() : "";
    if (!link) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå PDF");
    window.open(link, "_blank", "noopener");
  }

  window.onPickPdf = function(input, key) {
    const f = input.files && input.files[0];
    if (!f) return;

    if (String(f.type).toLowerCase() !== "application/pdf") {
      input.value = "";
      return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
    }

    if (f.size > MAX_PDF_BYTES) {
      input.value = "";
      return alert(`‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (${(f.size/1024/1024).toFixed(1)}MB)\n‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 6MB`);
    }

    setPdfText(key, "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà: " + f.name);
  }

  // ‚úÖ‚úÖ FIX NEW: normalize keys ‡∏Å‡πà‡∏≠‡∏ô map ‡πÄ‡∏Ç‡πâ‡∏≤ input (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö key ‡πÄ‡∏Å‡πà‡∏≤)
  function normalizeData_(data){
    data = data || {};
    if (data.FB_Link === undefined || String(data.FB_Link).trim() === "") {
      if (data.FBLink !== undefined) data.FB_Link = data.FBLink;
      if (data.FB_LINK !== undefined) data.FB_Link = data.FB_LINK;
    }
    return data;
  }

  async function loadData() {
    document.getElementById("displayId").innerText = HP_ID || "HP-XXXX";
    if (!HP_ID || !PROJECT) return alert("Missing id/project in URL");

    try {
      const res = await fetch(`${API_URL}?mode=getUnitDetail&hpId=${encodeURIComponent(HP_ID)}&project=${encodeURIComponent(PROJECT)}&t=${Date.now()}`);
      let data = await res.json();
      if (data && data.error) throw new Error(data.error);

      data = normalizeData_(data);

      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏° id ‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö key ‡∏à‡∏≤‡∏Å GAS (normKey)
      Object.keys(data || {}).forEach(k => {
        const el = document.getElementById(k);
        if (el) el.value = (data[k] ?? "");
      });

      // ‚úÖ ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏™‡πà FB_Link ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      if (document.getElementById("FB_Link") && data.FB_Link !== undefined) {
        document.getElementById("FB_Link").value = data.FB_Link ?? "";
      }

      const districtVal = (data.District ?? "").toString().trim();
      const subDistrictVal = (data.SubDistrict ?? "").toString().trim();
      if (districtVal) {
        document.getElementById("District").value = districtVal;
        setSubDistrictOptions(districtVal, subDistrictVal);
      } else {
        setSubDistrictOptions("", "");
      }

      const rawSys = (data.System_Status ?? "").toString().trim();
      const mapSys = { "Live":"Online", "Online (Live)":"Online", "Online":"Online", "Pending":"Pending", "Offline":"Offline" };
      const normalized = mapSys[rawSys] || (rawSys ? rawSys : "Pending");
      document.getElementById("System_Status").value = normalized;

      if (data.Thumbnail_Image) {
        document.getElementById("thumbPreview").innerHTML = `<img src="${data.Thumbnail_Image}" class="w-full h-full object-cover">`;
      }

      existingGallery = [];
      removedGallery = [];
      newGalleryQueue = [];

      if (data.Image_List) {
        existingGallery = String(data.Image_List).split(",").map(s => s.trim()).filter(Boolean);
      }
      renderGallery();

      pdfLinks = {
        sales: (data.Sales_Gallery || "").toString().trim(),
        material: (data.Material_PDF || "").toString().trim(),
        floorplan: (data.FloorPlan_PDF || "").toString().trim()
      };
      setPdfText("sales", pdfLinks.sales || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå");
      setPdfText("material", pdfLinks.material || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå");
      setPdfText("floorplan", pdfLinks.floorplan || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå");

    } catch (e) {
      alert("Error loading data: " + e.message);
    }
  }

  const toBase64 = file => new Promise((resolve, reject) => {
    try {
      const reader = new FileReader();
      reader.onload = () => resolve({ data: reader.result.split(",")[1], type: file.type });
      reader.onerror = () => reject(new Error("File read error"));
      reader.readAsDataURL(file);
    } catch (e) { reject(e); }
  });

  async function updateData() {
    const btn = document.getElementById("saveBtn");
    btn.disabled = true;
    const oldText = btn.innerText;
    btn.innerText = "UPDATING DATABASE...";

    const keepGallery = existingGallery.filter(u => !removedGallery.includes(u));
    const removeGallery = removedGallery.slice();

    const payload = {
      mode: "updateUnit",
      project: PROJECT,
      hpId: HP_ID,

      Plot: document.getElementById("Plot").value,
      Type: document.getElementById("Type").value,
      Address: document.getElementById("Address").value,
      Project_Name: document.getElementById("Project_Name").value,
      Bedrooms: document.getElementById("Bedrooms").value,
      Bathrooms: document.getElementById("Bathrooms").value,

      Parking: document.getElementById("Parking").value,
      Extras: document.getElementById("Extras").value,
      Electricity: document.getElementById("Electricity").value,

      Land_Area_sq_w: document.getElementById("Land_Area_sq_w").value,
      Land_Area_sq_m: document.getElementById("Land_Area_sq_m").value,
      Living_Area_sq_m: document.getElementById("Living_Area_sq_m").value,
      Pool_Size: document.getElementById("Pool_Size").value,
      Pool_Depth: document.getElementById("Pool_Depth").value,
      Furnishing: document.getElementById("Furnishing").value,

      Status: document.getElementById("Status").value,
      District: document.getElementById("District").value,
      SubDistrict: document.getElementById("SubDistrict").value,
      Zone: document.getElementById("Zone").value,

      Price: document.getElementById("Price").value,
      Price_SQM: document.getElementById("Price_SQM").value,
      Badge: document.getElementById("Badge").value,
      Description: document.getElementById("Description").value,

      // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô FB_Link ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      FB_Link: document.getElementById("FB_Link").value,

      Map_Link: document.getElementById("Map_Link").value,
      Virtual_Tour: document.getElementById("Virtual_Tour").value,
      Commission: document.getElementById("Commission").value,

      keepGallery,
      removeGallery,

      file_thumb: null,
      files_gallery: [],

      file_sales_pdf: null,
      file_material_pdf: null,
      file_floorplan_pdf: null
    };

    // ‚úÖ debug (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏£‡∏∞‡∏ö‡∏ö)
    console.log("SENDING FB_Link:", payload.FB_Link);

    try {
      const thumb = document.getElementById("file_thumb").files[0];
      if (thumb) payload.file_thumb = await toBase64(thumb);

      for (const it of (newGalleryQueue || [])) {
        payload.files_gallery.push(await toBase64(it.file));
      }

      const salesPdf = document.getElementById("file_sales_pdf").files[0];
      if (salesPdf) payload.file_sales_pdf = await toBase64(salesPdf);

      const materialPdf = document.getElementById("file_material_pdf").files[0];
      if (materialPdf) payload.file_material_pdf = await toBase64(materialPdf);

      const floorPdf = document.getElementById("file_floorplan_pdf").files[0];
      if (floorPdf) payload.file_floorplan_pdf = await toBase64(floorPdf);

      const res = await fetch(API_URL, { method:"POST", body: JSON.stringify(payload) });
      const out = await res.json().catch(() => ({}));
      if (!res.ok || out.error) throw new Error(out.error || "Save failed");

      // ‚úÖ debug ‡∏à‡∏≤‡∏Å server
      console.log("SERVER DEBUG:", out.debug || out);

      if (out.pdfLinks) {
        pdfLinks = {
          sales: out.pdfLinks.sales || "",
          material: out.pdfLinks.material || "",
          floorplan: out.pdfLinks.floorplan || ""
        };
        setPdfText("sales", pdfLinks.sales || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå");
        setPdfText("material", pdfLinks.material || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå");
        setPdfText("floorplan", pdfLinks.floorplan || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå");
      }

      document.getElementById("successPopup").classList.remove("hidden");
    } catch (e) {
      alert("Save Failed: " + e.message);
      btn.disabled = false;
      btn.innerText = oldText;
    }
  }

  window.onload = () => {
    bindDistrictChange();
    loadData();
  };
</script>
