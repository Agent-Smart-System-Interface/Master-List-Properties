<!-- edit.html (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô) -->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>smart properties system ¬∑ edit</title>

  <link rel="preconnect" href="https://script.google.com">
  <link rel="preconnect" href="https://lh3.googleusercontent.com">

  <style>
    :root{
      --bg:#a8bdd6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7c93;
      --radius:22px;
      --shadow: 0 12px 30px rgba(0,0,0,.12);
      --soft:#f3f6fb;
      --line:rgba(255,255,255,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Thai", sans-serif;
      background: radial-gradient(ellipse at top, rgba(255,255,255,.25), rgba(255,255,255,0) 55%) , var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:16px 14px 30px;}

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.18);
      backdrop-filter: blur(10px);
      border: 1px solid var(--line);
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:44px; height:44px; border-radius:999px; background:rgba(255,255,255,.55);
      display:grid; place-items:center; font-weight:800;
      flex:0 0 auto;
    }
    .titles{min-width:0}
    .titles h1{
      margin:0;
      font-size:18px;
      line-height:1.15;
      font-weight:1100;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      letter-spacing:.2px;
    }
    .titles .sub{
      margin-top:3px;
      font-size:12px;
      color: rgba(15,23,42,.6);
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .backBtn{
      width:44px; height:44px; border-radius:999px;
      border:0; background: rgba(255,255,255,.55);
      cursor:pointer; font-size:18px; font-weight:900;
      flex:0 0 auto;
    }

    .card{
      margin-top:14px;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(255,255,255,.65);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .content{padding:14px;}

    .errorBox{
      margin-top:14px;
      padding:14px;
      border-radius: 18px;
      background: rgba(255,255,255,.7);
      border:1px solid rgba(255,255,255,.65);
      font-weight:1100;
      color:#8b1d1d;
      display:none;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:14px;
    }
    @media(min-width:900px){
      .grid{grid-template-columns: 1fr 1fr;}
    }

    .box{
      background: rgba(15,23,42,.05);
      border:1px solid rgba(15,23,42,.06);
      border-radius: 18px;
      padding:12px 12px;
    }
    .box h3{
      margin:0 0 10px 0;
      font-size:14px;
      font-weight:1100;
      color: rgba(15,23,42,.9);
    }

    label{
      display:block;
      font-weight:900;
      font-size:12px;
      color: rgba(15,23,42,.65);
      margin:10px 0 6px;
    }
    input, textarea, select{
      width:100%;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.9);
      font-weight:900;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:110px; resize:vertical;}
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .actions{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      border:0;
      cursor:pointer;
      padding:10px 14px;
      border-radius: 14px;
      font-weight:1100;
      background: rgba(255,255,255,.85);
      border:1px solid rgba(255,255,255,.65);
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
    }
    .btnPrimary{
      background: rgba(14,165,233,.12);
      border:1px solid rgba(14,165,233,.35);
    }

    .thumbPreview{
      width:100%;
      aspect-ratio: 16/10;
      object-fit:cover;
      border-radius: 16px;
      border:1px solid rgba(15,23,42,.10);
      background:#e8f0fb;
      display:block;
    }
    .galleryGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
    }
    @media(max-width:420px){
      .galleryGrid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    .gItem{
      position:relative;
      border-radius: 16px;
      overflow:hidden;
      border:1px solid rgba(15,23,42,.10);
      background:#e8f0fb;
    }
    .gItem img{
      width:100%;
      aspect-ratio: 1/1;
      object-fit:cover;
      display:block;
    }
    .gDel{
      position:absolute;
      top:8px; right:8px;
      width:34px; height:34px;
      border-radius:999px;
      border:0;
      background: rgba(255,255,255,.9);
      font-weight:1100;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.16);
    }
    .hint{
      margin-top:8px;
      font-size:12px;
      font-weight:900;
      color: rgba(15,23,42,.55);
      line-height:1.4;
    }

    /* Loading overlay */
    .pageLoader{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(ellipse at top, rgba(255,255,255,.25), rgba(255,255,255,0) 55%) , var(--bg);
      z-index:99999;
    }
    .loaderPanel{
      text-align:center;
      padding:18px 22px;
      border-radius: 26px;
      background: rgba(255,255,255,.18);
      border: 1px solid var(--line);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 40px rgba(0,0,0,.16);
      max-width: 92vw;
    }
    .loaderEmojis{
      display:flex;
      gap:18px;
      justify-content:center;
      align-items:center;
      font-size:52px;
      line-height:1;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.18));
    }
    .loaderEmojis span{
      display:inline-block;
      animation: bounce 0.9s ease-in-out infinite;
    }
    .loaderEmojis span:nth-child(2){ animation-delay: .12s; }
    .loaderEmojis span:nth-child(3){ animation-delay: .24s; }
    @keyframes bounce{
      0%,100%{ transform: translateY(0); opacity:.95; }
      50%{ transform: translateY(-12px); opacity:1; }
    }
    .loaderText{
      margin-top:12px;
      font-weight:1100;
      letter-spacing:.6px;
      color: rgba(15,23,42,.92);
      text-shadow: 0 10px 22px rgba(0,0,0,.10);
      font-size:22px;
      white-space:nowrap;
    }
    @media (max-width:420px){
      .loaderEmojis{font-size:44px}
      .loaderText{font-size:18px}
    }
  </style>
</head>
<body>

  <div class="pageLoader" id="pageLoader" aria-label="loading">
    <div class="loaderPanel">
      <div class="loaderEmojis" aria-hidden="true">
        <span>üè†</span><span>üõ†Ô∏è</span><span>‚ú®</span>
      </div>
      <div class="loaderText">Smart Properties System</div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">SP</div>
        <div class="titles">
          <h1 id="pageTitle">Edit Unit</h1>
          <div class="sub" id="subTitle">Project: - ¬∑ HP_ID: -</div>
        </div>
      </div>
      <button class="backBtn" id="btnBack">‚Üê</button>
    </div>

    <div class="errorBox" id="errBox"></div>

    <div class="card">
      <div class="content">
        <div class="grid">
          <div class="box">
            <h3>Basic Info</h3>

            <label>Plot</label>
            <input id="Plot" placeholder="Z-1" />

            <label>Type</label>
            <input id="Type" placeholder="A" />

            <label>Address</label>
            <input id="Address" placeholder="100/23" />

            <label>Project Name</label>
            <input id="Project_Name" placeholder="Master Vill" />

            <div class="row2">
              <div>
                <label>Bedrooms</label>
                <input id="Bedrooms" type="number" min="0" placeholder="3" />
              </div>
              <div>
                <label>Bathrooms</label>
                <input id="Bathrooms" type="number" min="0" placeholder="4" />
              </div>
            </div>

            <label>Parking</label>
            <input id="Parking" placeholder="2" />

            <div class="row2">
              <div>
                <label>Land Area (sq.w)</label>
                <input id="Land_Area_sq_w" placeholder="120" />
              </div>
              <div>
                <label>Land Area (sq.m)</label>
                <input id="Land_Area_sq_m" placeholder="480" />
              </div>
            </div>

            <label>Living Area (sq.m)</label>
            <input id="Living_Area_sq_m" placeholder="300" />
          </div>

          <div class="box">
            <h3>Pool / Price / Status</h3>

            <div class="row2">
              <div>
                <label>Pool Size</label>
                <input id="Pool_Size" placeholder="5x10m" />
              </div>
              <div>
                <label>Pool Depth</label>
                <input id="Pool_Depth" placeholder="1.5m" />
              </div>
            </div>

            <label>Furnishing</label>
            <input id="Furnishing" placeholder="Fully Furnished" />

            <div class="row2">
              <div>
                <label>Price</label>
                <input id="Price" placeholder="5000000" />
              </div>
              <div>
                <label>Price / SQM</label>
                <input id="Price_SQM" placeholder="16666" />
              </div>
            </div>

            <div class="row2">
              <div>
                <label>Status</label>
                <select id="Status">
                  <option>Available</option>
                  <option>Under Con</option>
                  <option>Reserved</option>
                  <option>Sold</option>
                </select>
              </div>
              <div>
                <label>Badge</label>
                <input id="Badge" placeholder="-" />
              </div>
            </div>

            <label>Description</label>
            <textarea id="Description" placeholder="Description..."></textarea>

            <div class="row2">
              <div>
                <label>District</label>
                <input id="District" placeholder="Hua Hin" />
              </div>
              <div>
                <label>SubDistrict</label>
                <input id="SubDistrict" placeholder="-" />
              </div>
            </div>

            <label>FBLink</label>
            <input id="FBLink" placeholder="https://facebook.com/..." />

            <label>Map Link</label>
            <input id="Map_Link" placeholder="https://maps.google.com/..." />

            <label>Virtual Tour</label>
            <input id="Virtual_Tour" placeholder="https://..." />

            <label>Commission</label>
            <input id="Commission" placeholder="-" />
          </div>
        </div>

        <div class="grid">
          <div class="box">
            <h3>Thumbnail</h3>
            <img class="thumbPreview" id="thumbPreview" alt="thumb preview" />
            <label>Upload Thumbnail (Replace)</label>
            <input type="file" id="file_thumb" accept="image/*" />
            <div class="hint">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞ ‚Äú‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‚Äù ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏° (‡∏£‡∏∞‡∏ö‡∏ö GS ‡∏à‡∏∞‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Thumb ‡∏Ç‡∏≠‡∏á HP_ID ‡∏Å‡πà‡∏≠‡∏ô)</div>
          </div>

          <div class="box">
            <h3>Gallery</h3>
            <div class="galleryGrid" id="galleryGrid"></div>

            <label>Add New Gallery Images</label>
            <input type="file" id="files_gallery" accept="image/*" multiple />
            <div class="hint">‡∏Å‡∏î ‚ùå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Gallery ‡∏Ç‡∏≠‡∏á HP_ID) ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î Save</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btnOpenDetails">Open Details</button>
          <button class="btn" id="btnOpenList">Open List</button>
          <button class="btn btnPrimary" id="btnSave">Save</button>
        </div>
      </div>
    </div>
  </div>

<script>
/** =========================
 * CONFIG
 * ========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvzszMpjb1Dy3nQDhh64oPYu1-CgL-RSdRe52Df_pejfqkhq-g70z96npgaSyNAw2T/exec";

const qs = new URLSearchParams(location.search);

/** =====================================================
 * ‚úÖ Project Tab Mapping (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà + ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
 * ‡πÉ‡∏´‡∏°‡πà:
 *  - project_000 ... project_004
 * ‡πÄ‡∏î‡∏¥‡∏° (‡∏¢‡∏±‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Å‡πà‡∏≤):
 *  - Project_0, Project_A, Project_B, Project_C, Project_D
 * ===================================================== */
function normalizeProject(p){
  const raw = String(p || "").trim();
  if(!raw) return "project_000";

  const map = {
    "project_0": "project_000",
    "project_a": "project_001",
    "project_b": "project_002",
    "project_c": "project_003",
    "project_d": "project_004",
    "project_000": "project_000",
    "project_001": "project_001",
    "project_002": "project_002",
    "project_003": "project_003",
    "project_004": "project_004",
  };

  const key = raw.replace(/-/g,"_").toLowerCase();
  return map[key] || raw;
}

const HP_ID = (qs.get("id") || qs.get("hpId") || "").trim();
const PROJECT = normalizeProject(qs.get("project") || "project_000");

/** Loader helpers */
function showLoader(){
  const el = document.getElementById("pageLoader");
  if(el) el.style.display = "flex";
}
function hideLoader(){
  const el = document.getElementById("pageLoader");
  if(el) el.style.display = "none";
}

/** JSONP */
function jsonp(url, timeoutMs = 20000){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const script = document.createElement("script");
    const timer = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, timeoutMs);

    function cleanup(){
      clearTimeout(timer);
      if (script.parentNode) script.parentNode.removeChild(script);
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
    }
    window[cb] = (data) => { cleanup(); resolve(data); };

    const sep = url.includes("?") ? "&" : "?";
    script.src = url + sep + "callback=" + encodeURIComponent(cb);
    script.onerror = () => { cleanup(); reject(new Error("jsonp_error")); };
    document.body.appendChild(script);
  });
}

function showError(msg){
  const box = document.getElementById("errBox");
  box.style.display = "block";
  box.textContent = msg;
}
function hideError(){
  const box = document.getElementById("errBox");
  box.style.display = "none";
  box.textContent = "";
}

function cleanDriveImage(url){
  const u = String(url || "").trim();
  if(!u) return "";
  if (u.includes("lh3.googleusercontent.com/d/")) return u;

  let id = "";
  const m1 = u.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if (m1) id = m1[1];
  const m2 = u.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if (!id && m2) id = m2[1];
  const m3 = u.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
  if (!id && m3) id = m3[1];

  if (id) return "https://lh3.googleusercontent.com/d/" + id;
  return u;
}

function setVal(id, v){
  const el = document.getElementById(id);
  if(!el) return;
  if(el.tagName === "SELECT"){
    el.value = String(v ?? el.value ?? "").trim() || el.value;
  }else{
    el.value = (v === undefined || v === null) ? "" : String(v);
  }
}
function getVal(id){
  const el = document.getElementById(id);
  if(!el) return "";
  return String(el.value ?? "").trim();
}

/** Base64 helper */
function fileToBase64(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = ()=> {
      const result = String(reader.result || "");
      const m = result.match(/^data:(.+?);base64,(.*)$/);
      if(!m) return reject(new Error("Invalid base64"));
      resolve({ type: m[1], data: m[2] });
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/** Back buttons */
document.getElementById("btnBack").addEventListener("click", ()=>{
  history.length > 1 ? history.back() : (location.href = `index.html?project=${encodeURIComponent(PROJECT)}`);
});
document.getElementById("btnOpenDetails").addEventListener("click", ()=>{
  location.href = `details.html?id=${encodeURIComponent(HP_ID)}&project=${encodeURIComponent(PROJECT)}`;
});
document.getElementById("btnOpenList").addEventListener("click", ()=>{
  location.href = `index.html?project=${encodeURIComponent(PROJECT)}`;
});

/** Gallery state */
let CURRENT_DETAIL = null;
let KEEP_GALLERY = [];     // URLs ‡∏ó‡∏µ‡πà‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ
let REMOVE_GALLERY = [];   // URLs ‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏•‡∏ö (‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ GS ‡πÑ‡∏õ trash)

/** Render gallery grid */
function renderGallery(){
  const grid = document.getElementById("galleryGrid");
  grid.innerHTML = "";

  if(!KEEP_GALLERY.length){
    grid.innerHTML = `<div class="hint">No gallery images</div>`;
    return;
  }

  KEEP_GALLERY.forEach((url, i)=>{
    const card = document.createElement("div");
    card.className = "gItem";
    card.innerHTML = `
      <img src="${cleanDriveImage(url)}" alt="g${i}">
      <button class="gDel" title="Remove">‚úï</button>
    `;
    card.querySelector(".gDel").addEventListener("click", ()=>{
      const removed = KEEP_GALLERY.splice(i,1)[0];
      if(removed) REMOVE_GALLERY.push(removed);
      renderGallery();
    });
    grid.appendChild(card);
  });
}

/** Load detail */
async function loadDetail(){
  hideError();
  showLoader();

  if (!HP_ID) {
    alert("Missing HP_ID in URL");
    location.href = "index.html";
  }


  document.getElementById("subTitle").textContent = `Project: ${PROJECT} ¬∑ HP_ID: ${HP_ID}`;
  document.getElementById("pageTitle").textContent = `Edit Unit: ${HP_ID}`;

  const url = `${SCRIPT_URL}?mode=getUnitDetail&project=${encodeURIComponent(PROJECT)}&hpId=${encodeURIComponent(HP_ID)}`;
  let detail;
  try{
    detail = await jsonp(url);
  }catch(err){
    showError("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à Deploy Apps Script ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Anyone ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ /exec)");
    hideLoader();
    return;
  }

  if(detail && detail.error){
    showError("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + detail.error);
    hideLoader();
    return;
  }

  CURRENT_DETAIL = detail;

  // Fill fields
  setVal("Plot", detail.Plot);
  setVal("Type", detail.Type);
  setVal("Address", detail.Address);
  setVal("Project_Name", detail.Project_Name);
  setVal("Bedrooms", detail.Bedrooms);
  setVal("Bathrooms", detail.Bathrooms);
  setVal("Parking", detail.Parking);

  setVal("Land_Area_sq_w", detail.Land_Area_sq_w);
  setVal("Land_Area_sq_m", detail.Land_Area_sq_m);
  setVal("Living_Area_sq_m", detail.Living_Area_sq_m);

  setVal("Pool_Size", detail.Pool_Size);
  setVal("Pool_Depth", detail.Pool_Depth);
  setVal("Furnishing", detail.Furnishing);
  setVal("Price", detail.Price);
  setVal("Price_SQM", detail.Price_SQM);

  setVal("Status", detail.Status || "Available");
  setVal("Badge", detail.Badge);

  setVal("Description", detail.Description);
  setVal("District", detail.District);
  setVal("SubDistrict", detail.SubDistrict);
  setVal("FBLink", detail.FBLink);
  setVal("Map_Link", detail.Map_Link);
  setVal("Virtual_Tour", detail.Virtual_Tour);
  setVal("Commission", detail.Commission);

  // Thumb preview
  const thumb = cleanDriveImage(detail.Thumbnail_Image || "");
  document.getElementById("thumbPreview").src =
    thumb || "data:image/svg+xml;charset=utf-8," + encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='800'><rect width='100%' height='100%' fill='#e6edf6'/><text x='50%' y='50%' text-anchor='middle' fill='#8aa0bb' font-size='40' font-family='Arial'>no thumb</text></svg>");

  // Gallery keep list
  KEEP_GALLERY = String(detail.Image_List || "")
    .split(",").map(s=>s.trim())
    .filter(Boolean);

  REMOVE_GALLERY = [];
  renderGallery();

  hideLoader();
}

/** Thumb change preview */
document.getElementById("file_thumb").addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  document.getElementById("thumbPreview").src = url;
});

/** Add new gallery preview (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ keep ‡∏à‡∏ô‡∏Å‡∏î save) */
let NEW_GALLERY_FILES = [];
document.getElementById("files_gallery").addEventListener("change", (e)=>{
  const files = Array.from(e.target.files || []);
  NEW_GALLERY_FILES = files;
});

/** Save */
async function save(){
  hideError();
  showLoader();

  try{
    const payload = {
      mode: "updateUnit",
      project: PROJECT,
      hpId: HP_ID,

      Plot: getVal("Plot"),
      Type: getVal("Type"),
      Address: getVal("Address"),
      Project_Name: getVal("Project_Name"),
      Bedrooms: getVal("Bedrooms"),
      Bathrooms: getVal("Bathrooms"),
      Parking: getVal("Parking"),

      Land_Area_sq_w: getVal("Land_Area_sq_w"),
      Land_Area_sq_m: getVal("Land_Area_sq_m"),
      Living_Area_sq_m: getVal("Living_Area_sq_m"),

      Pool_Size: getVal("Pool_Size"),
      Pool_Depth: getVal("Pool_Depth"),
      Furnishing: getVal("Furnishing"),
      Price: getVal("Price"),
      Price_SQM: getVal("Price_SQM"),

      Status: getVal("Status"),
      Badge: getVal("Badge"),

      Description: getVal("Description"),
      District: getVal("District"),
      SubDistrict: getVal("SubDistrict"),
      FBLink: getVal("FBLink"),
      Map_Link: getVal("Map_Link"),
      Virtual_Tour: getVal("Virtual_Tour"),
      Commission: getVal("Commission"),

      // ‚úÖ gallery control
      keepGallery: KEEP_GALLERY.slice(),
      removeGallery: REMOVE_GALLERY.slice(),
    };

    // thumb file
    const thumbFile = document.getElementById("file_thumb").files?.[0];
    if(thumbFile){
      payload.file_thumb = await fileToBase64(thumbFile);
    }

    // new gallery files
    if(NEW_GALLERY_FILES.length){
      payload.files_gallery = [];
      for(const f of NEW_GALLERY_FILES){
        payload.files_gallery.push(await fileToBase64(f));
      }
    }

    // POST to Apps Script
    const res = await fetch(SCRIPT_URL, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload),
    });

    const data = await res.json();
    if(data && data.error){
      showError("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + data.error);
      hideLoader();
      return;
    }

    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    // reload detail to refresh gallery list
    await loadDetail();

  }catch(err){
    showError("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
  }finally{
    hideLoader();
  }
}

document.getElementById("btnSave").addEventListener("click", save);

/** Init */
loadDetail();
</script>
</body>
</html>
