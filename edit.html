<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>EDIT UNIT</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body { font-family: 'Kanit', sans-serif; background:#f8fafc; }
  </style>
</head>

<body class="p-4 md:p-10 italic">
  <div class="max-w-6xl mx-auto">

    <div class="bg-slate-900 rounded-[2.2rem] px-6 py-6 md:px-10 md:py-7 text-white mb-6 shadow-2xl flex items-center justify-between">
      <div class="min-w-0">
        <div class="text-[11px] uppercase tracking-[0.35em] text-white/60 font-bold">Edit Unit</div>
        <div id="title" class="text-xl md:text-2xl font-extrabold tracking-tight italic truncate">Loading...</div>
      </div>

      <div class="flex items-center gap-3">
        <a id="backBtn" href="dashboard.html"
           class="w-14 h-14 rounded-2xl bg-white/10 hover:bg-white/20 flex items-center justify-center transition-all active:scale-95"
           aria-label="Back">
          <i class="fa-solid fa-arrow-left text-xl"></i>
        </a>

        <a id="homeBtn" href="index.html"
           class="w-14 h-14 rounded-2xl bg-white/10 hover:bg-white/20 flex items-center justify-center transition-all active:scale-95"
           aria-label="Home">
          <i class="fa-solid fa-house text-xl"></i>
        </a>
      </div>
    </div>

    <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-100 overflow-hidden">
      <div class="p-6 md:p-10">

        <div id="loading" class="bg-slate-50 border border-slate-100 rounded-[2rem] p-6 text-center text-slate-400 font-bold animate-pulse uppercase">
          üîÑ Loading unit detail...
        </div>

        <div id="errorBox" class="hidden bg-rose-50 border border-rose-100 rounded-[2rem] p-6 text-rose-700 font-bold">
          ‚ö†Ô∏è <span id="errorText">Error</span>
        </div>

        <div id="formWrap" class="hidden">

          <div class="grid md:grid-cols-3 gap-4 md:gap-6">
            <div class="md:col-span-2">
              <div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-2">UNIT ID</div>
              <input id="HP_ID" readonly
                     class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 outline-none font-extrabold text-slate-900"
                     value="">
            </div>

            <div>
              <div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-2">PROJECT</div>
              <input id="_project" readonly
                     class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 outline-none font-extrabold text-slate-900"
                     value="">
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-4 md:gap-6 mt-6">
            <div>
              <div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-2">PLOT</div>
              <input id="Plot"
                     class="w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 outline-none font-bold text-slate-900"
                     placeholder="‡πÄ‡∏ä‡πà‡∏ô Z-01">
            </div>

            <div>
              <div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-2">STATUS</div>
              <select id="Status"
                      class="w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 outline-none font-bold text-slate-900">
                <option value="">-</option>
                <option value="Available">Available</option>
                <option value="Under Construction">Under Construction</option>
                <option value="Reserved">Reserved</option>
                <option value="Sold">Sold</option>
              </select>
            </div>
          </div>

          <div class="mt-10 border-t pt-8">
            <div class="text-[12px] font-extrabold text-slate-500 uppercase tracking-widest mb-5">Location</div>

            <div class="grid md:grid-cols-3 gap-4 md:gap-6">
              <div>
                <div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-2">DISTRICT</div>
                <input id="District"
                       class="w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 outline-none font-bold text-slate-900"
                       placeholder="‡πÄ‡∏ä‡πà‡∏ô Cha-am / Hua Hin">
              </div>

              <div>
                <div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-2">SUB-DISTRICT</div>
                <input id="SubDistrict"
                       class="w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 outline-none font-bold text-slate-900"
                       placeholder="‡πÄ‡∏ä‡πà‡∏ô Cha-am">
              </div>

              <div>
                <div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-2">ZONE</div>
                <input id="Zone"
                       class="w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 outline-none font-bold text-slate-900"
                       placeholder="‡πÄ‡∏ä‡πà‡∏ô Cha-am">
              </div>
            </div>

            <div class="mt-6">
              <div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-2">COMMISSION</div>
              <input id="Commission"
                     class="w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 outline-none font-bold text-slate-900"
                     placeholder="‡πÄ‡∏ä‡πà‡∏ô 3% / 100,000">
            </div>
          </div>

          <div class="mt-10 border-t pt-8">
            <div class="text-[12px] font-extrabold text-slate-500 uppercase tracking-widest mb-5">External Links</div>

            <div class="grid md:grid-cols-3 gap-4 md:gap-6">
              <div>
                <div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-2">FB LINK</div>
                <input id="FB_Link"
                       class="w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 outline-none font-bold text-slate-900"
                       placeholder="https://facebook.com/...">
              </div>

              <div>
                <div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-2">MAP LINK</div>
                <input id="Map_Link"
                       class="w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 outline-none font-bold text-slate-900"
                       placeholder="https://maps.app.goo.gl/...">
              </div>

              <div>
                <div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-2">VIRTUAL TOUR</div>
                <input id="Virtual_Tour"
                       class="w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 outline-none font-bold text-slate-900"
                       placeholder="https://...">
              </div>
            </div>

            <div class="mt-6">
              <div class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-2">
                SYSTEM STATUS <span id="sysHint" class="text-slate-300">(HQ ONLY)</span>
              </div>

              <select id="System_Status"
                      class="w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 outline-none font-extrabold text-slate-900">
                <option value="Offline">Offline</option>
                <option value="Pending">Pending</option>
                <option value="Live">Live</option>
              </select>

              <div class="text-[11px] text-slate-400 mt-2">
                Offline = ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå | Pending = ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏ï‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ | Live = ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
              </div>
            </div>
          </div>

          <div class="mt-10">
            <button id="saveBtn"
              class="w-full py-10 bg-slate-900 text-white rounded-[2.2rem] font-extrabold uppercase text-[12px] tracking-[0.35em]
                     hover:bg-blue-600 transition-all shadow-2xl active:scale-95">
              UPDATE MASTER DATABASE
            </button>

            <div id="msg" class="mt-4 text-center text-[12px] font-bold hidden"></div>
          </div>

        </div>
      </div>
    </div>

  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxc76n6YKLUCCHZZR12c5K4_0k40gHa2ZzDMVZn29BElQlSO3X6O8B7dFIFi0bEukqJ/exec";

    const qs = new URLSearchParams(location.search);
    const HP_ID_PARAM = (qs.get("id") || "").trim();
    const PROJECT_ID = (qs.get("project") || "HP00").trim();

    const TOKEN = (qs.get("token") || localStorage.getItem("HP_AUTH_TOKEN") || "").trim();
    const ROLE  = (localStorage.getItem("HP_AUTH_ROLE") || "").trim(); // "HQ" | "PROJECT"

    document.getElementById("backBtn").href = `dashboard.html?project=${encodeURIComponent(PROJECT_ID)}`;
    document.getElementById("homeBtn").href = "index.html";

    if (!TOKEN) location.href = `gateway.html?project=${encodeURIComponent(PROJECT_ID)}`;

    function showLoading(on){
      const loading = document.getElementById("loading");
      const formWrap = document.getElementById("formWrap");
      const errorBox = document.getElementById("errorBox");
      if (on){
        loading.classList.remove("hidden");
        formWrap.classList.add("hidden");
        errorBox.classList.add("hidden");
      } else {
        loading.classList.add("hidden");
      }
    }

    function showError(msg){
      const errorBox = document.getElementById("errorBox");
      document.getElementById("errorText").textContent = msg || "Unknown error";
      errorBox.classList.remove("hidden");
      document.getElementById("formWrap").classList.add("hidden");
    }

    function showMsg(text, ok=true){
      const m = document.getElementById("msg");
      m.textContent = text;
      m.classList.remove("hidden");
      m.classList.toggle("text-emerald-700", !!ok);
      m.classList.toggle("text-rose-600", !ok);
    }

    function setVal(id, v){
      const el = document.getElementById(id);
      if (el) el.value = (v ?? "").toString();
    }

    function applyRoleLock_(){
      const sys = document.getElementById("System_Status");
      const hint = document.getElementById("sysHint");
      const isHQ = (ROLE === "HQ");
      if (!isHQ){
        sys.disabled = true;
        sys.classList.add("bg-slate-50");
        hint.textContent = "(READ ONLY)";
        hint.classList.remove("text-slate-300");
        hint.classList.add("text-slate-400");
      } else {
        sys.disabled = false;
        sys.classList.remove("bg-slate-50");
        hint.textContent = "(HQ ONLY)";
        hint.classList.remove("text-slate-400");
        hint.classList.add("text-slate-300");
      }
    }

    async function loadDetail(){
      if (!HP_ID_PARAM) return showError("Missing id in URL");
      showLoading(true);

      try{
        const url =
          `${API_URL}?mode=getUnitDetail` +
          `&project=${encodeURIComponent(PROJECT_ID)}` +
          `&hpId=${encodeURIComponent(HP_ID_PARAM)}` +
          `&token=${encodeURIComponent(TOKEN)}` +
          `&t=${Date.now()}`;

        const res = await fetch(url);
        const data = await res.json();

        if (!res.ok || !data || data.error) throw new Error(data.error || "Cannot load detail");

        document.getElementById("title").textContent = `${HP_ID_PARAM} ¬∑ ${PROJECT_ID}`;

        setVal("HP_ID", data.HP_ID || HP_ID_PARAM);
        setVal("_project", data._project || PROJECT_ID);

        setVal("Plot", data.Plot);
        setVal("Status", data.Status);

        setVal("District", data.District);
        setVal("SubDistrict", data.SubDistrict);
        setVal("Zone", data.Zone);
        setVal("Commission", data.Commission);

        setVal("FB_Link", data.FB_Link);
        setVal("Map_Link", data.Map_Link);
        setVal("Virtual_Tour", data.Virtual_Tour);

        setVal("System_Status", (data.System_Status || "Offline"));

        applyRoleLock_();

        document.getElementById("formWrap").classList.remove("hidden");
        showLoading(false);

      }catch(err){
        showLoading(false);
        showError(err.message || "Load error");
      }
    }

    // ‚úÖ FIX CORS: ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà headers Content-Type application/json
    async function save(){
      const btn = document.getElementById("saveBtn");
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = "UPDATING...";

      try{
        const payload = {
          mode: "updateUnit",
          project: PROJECT_ID,
          hpId: HP_ID_PARAM,
          token: TOKEN,

          Plot: document.getElementById("Plot").value.trim(),
          Status: document.getElementById("Status").value.trim(),

          District: document.getElementById("District").value.trim(),
          SubDistrict: document.getElementById("SubDistrict").value.trim(),
          Zone: document.getElementById("Zone").value.trim(),
          Commission: document.getElementById("Commission").value.trim(),

          FB_Link: document.getElementById("FB_Link").value.trim(),
          Map_Link: document.getElementById("Map_Link").value.trim(),
          Virtual_Tour: document.getElementById("Virtual_Tour").value.trim(),

          System_Status: document.getElementById("System_Status").value.trim()
        };

        // ‚úÖ no headers (avoid preflight)
        const res = await fetch(API_URL + `?t=${Date.now()}`, {
          method: "POST",
          body: JSON.stringify(payload)
        });

        const out = await res.json().catch(()=> ({}));
        if (!res.ok || !out.ok) throw new Error(out.error || "Update failed");

        showMsg("‚úÖ Updated successfully", true);

      }catch(err){
        showMsg("‚ùå " + (err.message || "Update error"), false);
      }finally{
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    document.getElementById("saveBtn").addEventListener("click", save);

    loadDetail();
  </script>
</body>
</html>
