<script>
  /**********************************************************
   * CONFIG
   **********************************************************/
  const API_URL = "https://script.google.com/macros/s/AKfycbxvzszMpjb1Dy3nQDhh64oPYu1-CgL-RSdRe52Df_pejfqkhq-g70z96npgaSyNAw2T/exec";

  // ‚úÖ NEW: ‡∏≠‡πà‡∏≤‡∏ô project ‡∏à‡∏≤‡∏Å URL ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô project_000
  const qs = new URLSearchParams(location.search);
  const PROJECT = qs.get("project") || "project_000";

  // ‚úÖ ‡∏™‡πà‡∏á project ‡πÑ‡∏õ gateway ‡πÅ‡∏ö‡∏ö‡∏û‡πà‡∏ß‡∏á‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå
  const GATEWAY_URL = "https://agent-smart-system-interface.github.io/Master-List-Properties/gateway.html?project=" + encodeURIComponent(PROJECT);

  // ‚úÖ details ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡πà‡∏ß‡∏á project ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏°‡∏≠
  function goDetails(hpId){
    location.href = "details.html?id=" + encodeURIComponent(hpId) + "&project=" + encodeURIComponent(PROJECT);
  }

  /**********************************************************
   * HELPERS
   **********************************************************/
  const $ = (id)=>document.getElementById(id);

  function showLoader(on){
    const el = $("loader");
    if(!el) return;
    if(on) el.classList.remove("hide");
    else el.classList.add("hide");
  }

  function toast(msg){
    const el = $("toast");
    el.textContent = msg;
    el.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>el.classList.remove("show"), 2200);
  }

  function fmtPrice(v){
    const n = Number(String(v||"").replace(/,/g,""));
    if (!isFinite(n) || n<=0) return "‡∏ø0";
    return "‡∏ø" + n.toLocaleString("en-US");
  }

  function statusStyle(statusRaw){
    const s = String(statusRaw||"").trim().toLowerCase();
    if (s.includes("available")) return {bg:"rgba(192,255,222,.92)", fg:"rgba(0,90,55,1)"};
    if (s.includes("under"))     return {bg:"rgba(255,240,195,.92)", fg:"rgba(120,70,0,1)"};
    if (s.includes("reserved"))  return {bg:"rgba(213,232,255,.92)", fg:"rgba(0,60,120,1)"};
    if (s.includes("sold"))      return {bg:"rgba(255,208,208,.92)", fg:"rgba(130,0,0,1)"};
    return {bg:"rgba(255,255,255,.75)", fg:"rgba(11,19,32,.80)"};
  }

  function normalizePlot(p){
    return String(p||"").trim();
  }

  // ‚úÖ cache key ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö project ‡πÉ‡∏´‡∏°‡πà (‡∏Å‡∏±‡∏ô‡∏ä‡∏ô‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå)
  const CACHE_KEY = "SP_UNITLIST_" + PROJECT + "_v1";

  function readCache(){
    try{
      const raw = sessionStorage.getItem(CACHE_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !Array.isArray(obj.data)) return null;
      if(Date.now() - obj.ts > 3*60*1000) return null;
      return obj.data;
    }catch(_){ return null; }
  }
  function writeCache(data){
    try{
      sessionStorage.setItem(CACHE_KEY, JSON.stringify({ts:Date.now(), data}));
    }catch(_){}
  }

  async function fetchUnitList(){
    const cached = readCache();
    if (cached) return cached;

    const url = new URL(API_URL);
    url.searchParams.set("mode", "getUnitList");
    url.searchParams.set("project", PROJECT);

    const res = await fetch(url.toString(), { cache: "no-store" });
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error(data?.error || "API invalid");
    writeCache(data);
    return data;
  }

  /**********************************************************
   * RENDER
   **********************************************************/
  let all = [];
  let filtered = [];

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function buildPlotOptions(list){
    const set = new Set();
    list.forEach(x=>{
      const p = normalizePlot(x.plot);
      if(p) set.add(p);
    });
    const plots = Array.from(set).sort((a,b)=>a.localeCompare(b, "en"));
    const sel = $("plotSelect");
    sel.innerHTML =
      `<option value="__all__">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Plot</option>` +
      plots.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
  }

  function applyFilters(){
    const plotVal = $("plotSelect").value;
    const sortVal = $("sortSelect").value;

    filtered = all.filter(x=>{
      if(plotVal === "__all__") return true;
      return normalizePlot(x.plot) === plotVal;
    });

    filtered.sort((a,b)=>{
      const pa = Number(String(a.price||"").replace(/,/g,"")) || 0;
      const pb = Number(String(b.price||"").replace(/,/g,"")) || 0;
      if(sortVal === "price_asc") return pa - pb;
      return pb - pa;
    });

    renderGrid();
  }

  function renderGrid(){
    const grid = $("grid");
    grid.innerHTML = "";
    $("empty").style.display = filtered.length ? "none" : "block";
    $("countChip").textContent = `${filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

    filtered.forEach(item=>{
      const card = document.createElement("div");
      card.className = "card";

      const cover = document.createElement("div");
      cover.className = "cover";

      const sk = document.createElement("div");
      sk.className = "skeleton";
      cover.appendChild(sk);

      const img = document.createElement("img");
      img.alt = "image";
      img.loading = "lazy";
      img.decoding = "async";
      img.referrerPolicy = "no-referrer";

      const src = String(item.thumbnail||"").trim();
      img.dataset.src = src || "";
      cover.appendChild(img);

      const st = document.createElement("div");
      st.className = "badgeStatus";
      const style = statusStyle(item.status);
      st.style.background = style.bg;
      st.style.color = style.fg;
      st.textContent = String(item.status||"").trim() || "‚Äî";
      cover.appendChild(st);

      const body = document.createElement("div");
      body.className = "body";

      const row1 = document.createElement("div");
      row1.className = "row1";

      const plotLine = document.createElement("div");
      plotLine.className = "plotLine";
      plotLine.textContent = normalizePlot(item.plot) ? `PLOT : ${normalizePlot(item.plot)}` : "PLOT : -";

      const price = document.createElement("div");
      price.className = "price";
      price.textContent = fmtPrice(item.price);

      row1.appendChild(plotLine);
      row1.appendChild(price);

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.appendChild(pillIcon("bed", item.bedrooms || "-", "Beds"));
      meta.appendChild(pillIcon("bath", item.bathrooms || "-", "Baths"));
      meta.appendChild(pillIcon("area", item.livingSqm || "-", "m¬≤"));

      const btn = document.createElement("button");
      btn.className = "btn";
      btn.textContent = "‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î";
      btn.addEventListener("click", ()=>{
        if(!item.id) return;
        goDetails(item.id); // ‚úÖ NEW
      });

      body.appendChild(row1);
      body.appendChild(meta);
      body.appendChild(btn);

      card.appendChild(cover);
      card.appendChild(body);
      grid.appendChild(card);
    });

    setupLazyImages();
  }

  function pillIcon(type, val, unitLabel){
    const el = document.createElement("div");
    el.className = "pill";
    let ico = "üìê";
    let label = unitLabel || "";
    if(type==="bed"){ ico = "üõèÔ∏è"; }
    if(type==="bath"){ ico = "üöø"; }
    el.innerHTML = `<span class="ico">${ico}</span><span class="lbl">${escapeHtml(val)}${label ? " " + escapeHtml(label) : ""}</span>`;
    return el;
  }

  function setupLazyImages(){
    const imgs = Array.from(document.querySelectorAll("img[data-src]"));
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(ent=>{
        if(!ent.isIntersecting) return;
        const img = ent.target;
        io.unobserve(img);

        const src = img.dataset.src;
        const sk = img.parentElement?.querySelector(".skeleton");

        if(!src){
          if(sk) sk.remove();
          img.style.display = "none";
          return;
        }

        img.onload = ()=>{ if(sk) sk.remove(); };
        img.onerror = ()=>{ if(sk) sk.remove(); };
        img.src = src;
      });
    }, { rootMargin: "220px 0px" });

    imgs.forEach(img=>io.observe(img));
  }

  /**********************************************************
   * INIT
   **********************************************************/
  (function init(){
    $("gatewayBtn").href = GATEWAY_URL;

    showLoader(true);
    loadAll();

    $("plotSelect").addEventListener("change", applyFilters);
    $("sortSelect").addEventListener("change", applyFilters);
  })();

  async function loadAll(){
    try{
      const data = await fetchUnitList();
      all = data.map(x=>({
        id: x.id || "",
        plot: x.plot || "",
        projectName: x.projectName || x.project_name || "",
        thumbnail: x.thumbnail || "",
        bedrooms: x.bedrooms || "",
        bathrooms: x.bathrooms || "",
        livingSqm: x.livingSqm || x.living_area_sq_m || "",
        price: x.price || "",
        status: x.status || ""
      }));

      $("masterVill").textContent = pickMasterVillName(all) || "Master Vill";

      buildPlotOptions(all);
      applyFilters();
      showLoader(false);
    }catch(err){
      console.error(err);
      $("countChip").textContent = "‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      toast("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      $("empty").style.display = "block";
      showLoader(false);
    }
  }

  function pickMasterVillName(list){
    const freq = new Map();
    list.forEach(x=>{
      const n = String(x.projectName||"").trim();
      if(!n) return;
      freq.set(n, (freq.get(n)||0)+1);
    });
    let best = "", bestN = 0;
    for(const [k,v] of freq.entries()){
      if(v>bestN){ best=k; bestN=v; }
    }
    return best;
  }
</script>
