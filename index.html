<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>smart properties system</title>
  <meta name="theme-color" content="#6f86a6" />
  <style>
    :root{
      --bg1:#9fb6d6; --bg2:#8aa5c7; --cloud:rgba(255,255,255,.28);
      --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --lineGreen:#06c755;
      --shadow:0 16px 40px rgba(15,23,42,.12);
      --radius:22px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--ink);
      background:
        radial-gradient(120px 60px at 20% 30%, var(--cloud) 0 60%, transparent 62%),
        radial-gradient(180px 90px at 78% 36%, var(--cloud) 0 60%, transparent 62%),
        radial-gradient(220px 100px at 30% 72%, rgba(255,255,255,.22) 0 60%, transparent 62%),
        radial-gradient(200px 90px at 78% 78%, rgba(255,255,255,.20) 0 60%, transparent 62%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      min-height:100%;
      padding:16px;
    }
    .wrap{max-width:1200px;margin:0 auto}
    .topbar{
      display:flex;align-items:center;gap:12px;
      padding:10px 6px 18px;
    }
    .avatar{
      width:46px;height:46px;border-radius:50%;
      display:grid;place-items:center;
      background:rgba(255,255,255,.7);
      box-shadow:0 10px 22px rgba(15,23,42,.10);
      font-weight:800;letter-spacing:.5px;
    }
    .titleblock{flex:1;min-width:0}
    .title{margin:0;font-size:26px;font-weight:900;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .subtitle{margin:2px 0 0;color:rgba(15,23,42,.6);font-size:14px;font-weight:600}
    .iconBtn{
      width:46px;height:46px;border-radius:18px;
      border:0;cursor:pointer;
      background:rgba(255,255,255,.75);
      box-shadow:0 10px 22px rgba(15,23,42,.10);
      display:grid;place-items:center;
    }
    .iconBtn:active{transform:scale(.98)}
    .toolbar{
      display:flex;gap:10px;align-items:center;
      margin:0 0 14px;
      flex-wrap:wrap;
    }
    .pill{flex:1;display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 16px;border-radius:18px;background:rgba(255,255,255,.55);
      box-shadow:0 10px 22px rgba(15,23,42,.08);
      backdrop-filter: blur(6px);
      border:1px solid rgba(255,255,255,.55);
      min-height:54px;
      min-width:240px;
    }
    .pill strong{font-size:16px}
    .reload{
      border:0;border-radius:18px;
      padding:14px 16px;min-height:54px;
      background:rgba(6,199,85,.90);
      color:white;font-weight:900;font-size:16px;
      box-shadow:0 14px 30px rgba(6,199,85,.25);
      cursor:pointer;
      white-space:nowrap;
    }
    .reload:active{transform:scale(.99)}
    .sort{
      border:0;border-radius:18px;
      padding:14px 16px;min-height:54px;
      background:rgba(255,255,255,.55);
      box-shadow:0 10px 22px rgba(15,23,42,.08);
      font-weight:800;
      min-width:160px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      padding-bottom:24px;
    }
    @media (min-width: 980px){
      body{padding:22px}
      .grid{grid-template-columns: repeat(3, minmax(0, 1fr));gap:18px}
      .title{font-size:30px}
    }
    .card{
      background:rgba(255,255,255,.90);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.65);
      backdrop-filter: blur(6px);
    }
    .thumb{width:100%;aspect-ratio: 16/10;background:#e5e7eb;display:block;object-fit:cover}
    .cardBody{padding:14px 14px 12px}
    .row{display:flex;align-items:baseline;justify-content:space-between;gap:10px}
    .hp{font-size:20px;font-weight:900;letter-spacing:.2px}
    .price{font-size:20px;font-weight:1000}
    .meta{margin:10px 0 12px;display:flex;gap:10px;flex-wrap:wrap}
    .chip{padding:10px 12px;border-radius:999px;background:rgba(15,23,42,.06);font-weight:900}
    .btnDetail{width:100%;border:0;border-radius:18px;padding:14px 16px;
      background:rgba(6,199,85,.20);font-weight:1000;font-size:18px;cursor:pointer}
    .btnDetail:active{transform:scale(.99)}
    .muted{color:var(--muted);font-weight:700}
    .error{margin:14px 6px;color:#b91c1c;font-weight:900}
    .skeleton{animation:pulse 1.2s ease-in-out infinite;}
    @keyframes pulse{0%,100%{opacity:.55}50%{opacity:1}}
    /* modal */
    .modalBack{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:flex-end;justify-content:center;padding:18px;z-index:50}
    .modal{width:min(520px, 100%);background:white;border-radius:22px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
    .modalHead{padding:16px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .modalHead h3{margin:0;font-size:18px;font-weight:1000}
    .modalHead button{border:0;background:rgba(15,23,42,.08);border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer}
    .modalBody{padding:0 18px 18px}
    .modalBody a{display:block;text-decoration:none;color:var(--ink);background:rgba(15,23,42,.06);padding:14px 14px;border-radius:16px;font-weight:1000;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="avatar">SP</div>
      <div class="titleblock">
        <h1 class="title">smart properties system</h1>
        <div class="subtitle">Catalog ¬∑ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö feel LINE</div>
      </div>

      <!-- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡πÜ -->
      <button class="iconBtn" id="btnUser" aria-label="Admin menu" title="Admin menu">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M20 21a8 8 0 0 0-16 0" stroke="rgba(15,23,42,.75)" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 13a5 5 0 1 0 0-10 5 5 0 0 0 0 10Z" stroke="rgba(15,23,42,.75)" stroke-width="2"/>
        </svg>
      </button>
    </div>

    <div class="toolbar">
      <div class="pill">
        <strong>Project_0</strong>
        <span class="muted" id="countText">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
      </div>
      <button class="reload" id="btnReload">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      <select class="sort" id="priceSort" aria-label="Sort">
        <option value="new">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
        <option value="low">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‚Üí‡∏™‡∏π‡∏á</option>
        <option value="high">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‚Üí‡∏ï‡πà‡∏≥</option>
      </select>
    </div>

    <div id="error" class="error" style="display:none"></div>
    <div id="grid" class="grid" aria-live="polite"></div>
  </div>

  <!-- Admin modal -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <h3>Admin</h3>
        <button id="modalClose">‡∏õ‡∏¥‡∏î</button>
      </div>
      <div class="modalBody">
        <a href="gateway.html">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Gateway</a>
        <a href="edit.html">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Edit</a>
        <a href="dashboard.html">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Dashboard</a>
      </div>
    </div>
  </div>

<script>
(() => {
  const API_URL = "https://script.google.com/macros/s/AKfycbwvCiaEKxvRI9rQCXMR_F4SHqmkJT4CnAuoVgEr6RYACmfgKerp7r06m-ltBMu4GFD4/exec";
  const PROJECT = "Project_0";

  const elGrid = document.getElementById("grid");
  const elError = document.getElementById("error");
  const elCount = document.getElementById("countText");
  const elSort = document.getElementById("priceSort");
  const btnReload = document.getElementById("btnReload");

  // modal
  const modalBack = document.getElementById("modalBack");
  const btnUser = document.getElementById("btnUser");
  const modalClose = document.getElementById("modalClose");
  const openModal = () => (modalBack.style.display = "flex");
  const closeModal = () => (modalBack.style.display = "none");
  btnUser.addEventListener("click", openModal);
  modalClose.addEventListener("click", closeModal);
  modalBack.addEventListener("click", (e) => { if(e.target === modalBack) closeModal(); });

  const cacheKey = `unitList::${PROJECT}`;
  const cacheTtlMs = 3 * 60 * 1000;

  function parsePrice(v){
    if (v == null) return 0;
    const n = String(v).replace(/[^\d.]/g, "");
    return Number(n || 0);
  }

  function pickThumb(row){
    return row.Thumbnail_Image || row.Cover || row.Cover_Image || row.Image || row.image || "";
  }

  function renderSkeleton(n){
    elGrid.innerHTML = "";
    for(let i=0;i<n;i++){
      const d = document.createElement("div");
      d.className = "card skeleton";
      d.innerHTML = `
        <div style="width:100%;aspect-ratio:16/10;background:#e5e7eb"></div>
        <div class="cardBody">
          <div class="row"><div style="height:22px;width:45%;background:#e5e7eb;border-radius:10px"></div>
          <div style="height:22px;width:35%;background:#e5e7eb;border-radius:10px"></div></div>
          <div class="meta">
            <div style="height:38px;width:70px;background:#e5e7eb;border-radius:999px"></div>
            <div style="height:38px;width:70px;background:#e5e7eb;border-radius:999px"></div>
            <div style="height:38px;width:90px;background:#e5e7eb;border-radius:999px"></div>
          </div>
          <div style="height:48px;background:#e5e7eb;border-radius:18px"></div>
        </div>`;
      elGrid.appendChild(d);
    }
  }

  function render(list){
    elGrid.innerHTML = "";
    elCount.textContent = `${list.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

    if(!list.length){
      elGrid.innerHTML = `<div class="card"><div class="cardBody"><div class="hp">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div><div class="muted">‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î ‚Äú‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‚Äù ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div></div></div>`;
      return;
    }

    list.forEach(row => {
      const hpId = row.HP_ID || row.hpId || row.id || "";
      const plot = row.Plot || row.Plot_No || row.PlotName || row.Unit || "";
      const beds = row.Bed || row.Bedrooms || row.Bedroom || row.bed || "";
      const baths = row.Bath || row.Bathrooms || row.Bathroom || row.bath || "";
      const land = row.Land_sq_w || row.Land || row.LandSize || row.land || "";
      const price = row.Price || row.Sale_Price || row.price || 0;

      const thumb = pickThumb(row);
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <img class="thumb" src="${thumb || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='500'%3E%3Crect width='100%25' height='100%25' fill='%23e5e7eb'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' font-family='Arial' font-size='32' fill='%2394a3b8'%3Eno image%3C/text%3E%3C/svg%3E"}"
             alt="${hpId}" loading="lazy" decoding="async" />
        <div class="cardBody">
          <div class="row">
            <div class="hp">${hpId}${plot ? ` ¬∑ ${plot}` : ""}</div>
            <div class="price">‡∏ø${parsePrice(price).toLocaleString('en-US')}</div>
          </div>
          <div class="meta">
            <div class="chip">üõèÔ∏è ${beds || "-"}</div>
            <div class="chip">üõÅ ${baths || "-"}</div>
            <div class="chip">üìê ${land || "-"}</div>
          </div>
          <button class="btnDetail" data-id="${encodeURIComponent(hpId)}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
        </div>
      `;
      card.querySelector(".btnDetail").addEventListener("click", () => {
        if(!hpId) return;
        location.href = `details.html?id=${encodeURIComponent(hpId)}`;
      });
      elGrid.appendChild(card);
    });
  }

  function sortList(list){
    const mode = elSort.value;
    const arr = [...list];
    if(mode === "low") arr.sort((a,b) => parsePrice(a.Price||a.Sale_Price||0) - parsePrice(b.Price||b.Sale_Price||0));
    else if(mode === "high") arr.sort((a,b) => parsePrice(b.Price||b.Sale_Price||0) - parsePrice(a.Price||a.Sale_Price||0));
    else arr.sort((a,b) => String(b.Updated||b.updated||"").localeCompare(String(a.Updated||a.updated||"")));
    return arr;
  }

  function saveCache(list){
    try{
      sessionStorage.setItem(cacheKey, JSON.stringify({ts:Date.now(), data:list}));
    }catch(_e){}
  }

  function loadCache(){
    try{
      const raw = sessionStorage.getItem(cacheKey);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj?.ts || !Array.isArray(obj.data)) return null;
      if(Date.now() - obj.ts > cacheTtlMs) return null;
      return obj.data;
    }catch(_e){ return null; }
  }

  async function fetchJson(url, timeoutMs=15000){
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), timeoutMs);
    try{
      const res = await fetch(url, {signal: ctrl.signal, cache:"no-store"});
      const txt = await res.text();
      try { return JSON.parse(txt); } catch(_e) {
        const cleaned = txt.replace(/^\)\]\}'\n?/, "");
        return JSON.parse(cleaned);
      }
    } finally {
      clearTimeout(timer);
    }
  }

  async function load(forceNetwork=false){
    elError.style.display = "none";
    renderSkeleton(6);

    const cached = !forceNetwork ? loadCache() : null;
    if(cached){
      render(sortList(cached));
      return;
    }

    // ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ Project_0 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    const urls = [
      `${API_URL}?mode=getUnitList&project=${encodeURIComponent(PROJECT)}`,
      `${API_URL}?action=getUnitList&project=${encodeURIComponent(PROJECT)}`,
      `${API_URL}?mode=list&project=${encodeURIComponent(PROJECT)}`,
      `${API_URL}?project=${encodeURIComponent(PROJECT)}&mode=getUnitList`
    ];

    let data=null, lastErr=null;
    for(const u of urls){
      try{
        const out = await fetchJson(u);
        if(Array.isArray(out)){ data=out; break; }
        if(out?.data && Array.isArray(out.data)){ data=out.data; break; }
        if(out?.items && Array.isArray(out.items)){ data=out.items; break; }
        if(out?.error) lastErr = new Error(out.error);
      }catch(e){ lastErr=e; }
    }

    if(!data){
      elGrid.innerHTML = "";
      elError.textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Web App / ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå / ‡πÇ‡∏´‡∏°‡∏î API)";
      elError.style.display = "block";
      console.error(lastErr);
      return;
    }

    saveCache(data);
    render(sortList(data));
  }

  elSort.addEventListener("change", () => {
    const cached = loadCache();
    if(cached) render(sortList(cached));
  });
  btnReload.addEventListener("click", () => load(true));

  load(false);
})();
</script>
</body>
</html>
