<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>smart properties system</title>

  <link rel="preconnect" href="https://script.google.com">
  <link rel="preconnect" href="https://lh3.googleusercontent.com">

  <style>
    :root{
      --bg:#a8bdd6;
      --text:#0f172a;
      --muted:#6b7c93;
      --green:#19b45b;
      --softGreen:#c9f3dd;
      --radius:22px;
      --shadow: 0 12px 30px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Thai", sans-serif;
      background: radial-gradient(ellipse at top, rgba(255,255,255,.25), rgba(255,255,255,0) 55%) , var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:12px 12px 28px;}

    /* ‚úÖ (1) ‡∏ó‡∏≥‡∏´‡∏±‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á + ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 10px;
      border-radius: 18px;
      background: rgba(255,255,255,.18);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:10px; align-items:center;}
    .logo{
      width:40px; height:40px; border-radius:999px; background:rgba(255,255,255,.55);
      display:grid; place-items:center; font-weight:900;
      letter-spacing:.5px;
      flex:0 0 auto;
    }
    .titles{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
    }
    .titles .projectName{
      margin:0;
      font-size:18px;      /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
      line-height:1.1;
      font-weight:1000;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .titles .hint{
      margin:0;
      font-size:12px;
      font-weight:900;
      color:rgba(15,23,42,.62);
    }

    /* ‚úÖ (2) ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ñ‡∏ô ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏õ Gateway */
    .avatarBtn{
      width:40px; height:40px; border-radius:999px;
      border:0;
      background: rgba(255,255,255,.55);
      display:grid; place-items:center;
      cursor:pointer;
      font-size:18px;
      flex:0 0 auto;
    }

    /* ‚úÖ (3) ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 2 ‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß + Pop-up */
    .controls{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:stretch;
    }
    .pill{
      background: rgba(255,255,255,.38);
      border:1px solid rgba(255,255,255,.52);
      border-radius: 18px;
      padding:12px 12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      cursor:pointer;
      min-height:48px;
    }
    .pill .left{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .pill .title{
      font-size:15px;
      font-weight:1000;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill .sub{
      font-size:12px;
      font-weight:900;
      color:rgba(15,23,42,.62);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill .caret{
      font-weight:1000;
      color:rgba(15,23,42,.65);
    }

    /* ‚úÖ (4) ‡πÄ‡∏≠‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */

    /* Grid */
    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 900px){
      .grid{grid-template-columns: repeat(3, 1fr);}
    }

    .card{
      background: rgba(255,255,255,.86);
      border:1px solid rgba(255,255,255,.65);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 10px 25px rgba(0,0,0,.10);
    }

    /* ‚úÖ (5) ‡∏†‡∏≤‡∏û: placeholder ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏£‡∏¥‡∏á */
    .thumbWrap{
      width:100%;
      aspect-ratio: 16 / 9;
      background: #e6edf6;
      display:block;
      position:relative;
      overflow:hidden;
    }
    .thumb{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      transform: scale(1.02);
    }
    .thumbBlur{
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(255,255,255,.55), rgba(255,255,255,.25), rgba(255,255,255,.55));
      background-size: 200% 100%;
      animation: shimmer 1.1s infinite linear;
    }
    .thumbLoaded .thumbBlur{display:none;}

    @keyframes shimmer{
      0%{background-position: 200% 0;}
      100%{background-position: -200% 0;}
    }

    .cardBody{padding:14px 14px 12px;}
    .row1{display:flex; align-items:flex-end; justify-content:space-between; gap:10px;}
    .hp{font-size:20px; font-weight:1000; letter-spacing:.4px;}
    .price{font-size:18px; font-weight:1000;}
    .iconsRow{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;}
    .miniPill{
      background: rgba(15,23,42,.06);
      border:1px solid rgba(15,23,42,.06);
      padding:9px 11px;
      border-radius: 999px;
      display:flex; align-items:center; gap:8px;
      font-weight:1000;
      min-width: 84px;
      justify-content:center;
    }
    .btnDetail{
      width:100%;
      margin-top:12px;
      background: var(--softGreen);
      border:0;
      border-radius: 16px;
      padding:14px 14px;
      font-weight:1100;
      cursor:pointer;
    }

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.35);
      z-index:9999;
    }
    .modalBackdrop.show{display:flex;}
    .modal{
      width:min(680px, 100%);
      max-height: min(80vh, 720px);
      overflow:auto;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.65);
      border-radius: 24px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:6px 6px 10px;
      position:sticky; top:0;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      z-index:2;
    }
    .modalHeader h2{margin:0; font-size:18px; font-weight:1100;}
    .closeBtn{
      border:0; border-radius: 999px;
      padding:10px 14px;
      font-weight:1100;
      background:#f04a3a; color:#fff;
      cursor:pointer;
    }
    .list{display:flex; flex-direction:column; gap:10px; padding:8px 6px 12px;}
    .item{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:12px;
      border-radius: 18px;
      background: rgba(15,23,42,.04);
      border:1px solid rgba(15,23,42,.06);
      cursor:pointer;
    }
    .item .left .title{font-size:18px; font-weight:1100;}
    .item .left .sub{font-size:12px; font-weight:900; color:rgba(15,23,42,.62); margin-top:4px;}
    .tag{
      padding:8px 12px;
      border-radius: 999px;
      font-weight:1100;
      background: rgba(25,180,91,.12);
      color: rgba(25,120,70,1);
      white-space:nowrap;
    }
    .tag.gray{background: rgba(15,23,42,.08); color: rgba(15,23,42,.7);}
    .errorBox{
      margin-top:10px;
      padding:12px;
      border-radius: 18px;
      background: rgba(255,255,255,.7);
      border:1px solid rgba(255,255,255,.65);
      font-weight:1000;
      color:#8b1d1d;
      display:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">SP</div>
        <div class="titles">
          <!-- ‚úÖ (1) ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå -->
          <p class="projectName" id="projectName">Project_0</p>
          <p class="hint" id="countText">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
        </div>
      </div>

      <!-- ‚úÖ (2) ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏õ Gateway -->
      <button class="avatarBtn" id="btnGateway" title="Gateway">üë§</button>
    </div>

    <div class="controls">
      <!-- ‚úÖ (3) ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PLOT -->
      <div class="pill" id="plotPill" role="button" tabindex="0">
        <div class="left">
          <div class="title" id="plotTitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PLOT</div>
          <div class="sub" id="plotSub">Project_0</div>
        </div>
        <div class="caret">‚ñº</div>
      </div>

      <!-- ‚úÖ (3) ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sort -->
      <div class="pill" id="sortPill" role="button" tabindex="0">
        <div class="left">
          <div class="title" id="sortTitle">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö</div>
          <div class="sub" id="sortSub">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
        </div>
        <div class="caret">‚ñº</div>
      </div>
    </div>

    <div class="errorBox" id="errBox"></div>

    <div class="grid" id="grid"></div>
  </div>

  <!-- Plot Modal -->
  <div class="modalBackdrop" id="plotModal">
    <div class="modal">
      <div class="modalHeader">
        <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PLOT (Project_0)</h2>
        <button class="closeBtn" id="closePlot">CLOSE</button>
      </div>
      <div class="list" id="plotList"></div>
    </div>
  </div>

  <!-- Sort Modal -->
  <div class="modalBackdrop" id="sortModal">
    <div class="modal">
      <div class="modalHeader">
        <h2>‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö</h2>
        <button class="closeBtn" id="closeSort">CLOSE</button>
      </div>
      <div class="list" id="sortList"></div>
    </div>
  </div>

<script>
/** =========================
 * CONFIG
 * ========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwvCiaEKxvRI9rQCXMR_F4SHqmkJT4CnAuoVgEr6RYACmfgKerp7r06m-ltBMu4GFD4/exec";
const PROJECT = "Project_0";

/** ‚úÖ ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Gateway ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏£‡∏¥‡∏á */
const GATEWAY_URL = "https://agent-smart-system-interface.github.io/Master-List-Properties/";

/** =========================
 * JSONP (‡∏Å‡∏±‡∏ô CORS)
 * ========================= */
function jsonp(url, timeoutMs = 20000){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const script = document.createElement("script");
    const timer = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, timeoutMs);

    function cleanup(){
      clearTimeout(timer);
      if (script.parentNode) script.parentNode.removeChild(script);
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
    }
    window[cb] = (data) => { cleanup(); resolve(data); };

    const sep = url.includes("?") ? "&" : "?";
    script.src = url + sep + "callback=" + encodeURIComponent(cb);
    script.onerror = () => { cleanup(); reject(new Error("jsonp_error")); };
    document.body.appendChild(script);
  });
}

/** =========================
 * Utils
 * ========================= */
function toNumber(x){
  const s = String(x ?? "").replace(/,/g,"").trim();
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function moneyTHB(x){
  const n = toNumber(x);
  return "‡∏ø" + n.toLocaleString("en-US");
}
function cleanDriveImage(url){
  const u = String(url || "").trim();
  if(!u) return "";
  if (u.includes("lh3.googleusercontent.com/d/")) return u;

  let id = "";
  const m1 = u.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if (m1) id = m1[1];
  const m2 = u.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if (!id && m2) id = m2[1];
  const m3 = u.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
  if (!id && m3) id = m3[1];
  if (id) return "https://lh3.googleusercontent.com/d/" + id;

  return u;
}
function firstImageFromList(imageList){
  const arr = String(imageList||"").split(",").map(s=>s.trim()).filter(Boolean);
  return arr.length ? cleanDriveImage(arr[0]) : "";
}
const NO_IMAGE = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
  `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='450'>
    <rect width='100%' height='100%' fill='#e6edf6'/>
    <text x='50%' y='50%' text-anchor='middle' fill='#8aa0bb' font-size='32' font-family='Arial'>no image</text>
  </svg>`
);

/** =========================
 * State
 * ========================= */
let ALL = [];
let FILTER_PLOT = "ALL";
let SORT_MODE = "latest";

/** =========================
 * DOM
 * ========================= */
const grid = document.getElementById("grid");
const errBox = document.getElementById("errBox");
const countText = document.getElementById("countText");

const plotPill = document.getElementById("plotPill");
const plotModal = document.getElementById("plotModal");
const plotList = document.getElementById("plotList");

const sortPill = document.getElementById("sortPill");
const sortModal = document.getElementById("sortModal");
const sortList = document.getElementById("sortList");

const plotTitle = document.getElementById("plotTitle");
const sortSub = document.getElementById("sortSub");

/** =========================
 * Error
 * ========================= */
function showError(msg){
  errBox.style.display = "block";
  errBox.textContent = msg;
}
function hideError(){
  errBox.style.display = "none";
  errBox.textContent = "";
}

/** =========================
 * Gateway (2)
 * ========================= */
document.getElementById("btnGateway").addEventListener("click", () => {
  window.location.href = GATEWAY_URL;
});

/** =========================
 * Modal Controls
 * ========================= */
function openModal(el){
  el.classList.add("show");
  document.body.style.overflow = "hidden";
}
function closeModal(el){
  el.classList.remove("show");
  document.body.style.overflow = "";
}

document.getElementById("closePlot").addEventListener("click", ()=>closeModal(plotModal));
plotModal.addEventListener("click", (e)=>{ if(e.target===plotModal) closeModal(plotModal); });

document.getElementById("closeSort").addEventListener("click", ()=>closeModal(sortModal));
sortModal.addEventListener("click", (e)=>{ if(e.target===sortModal) closeModal(sortModal); });

plotPill.addEventListener("click", ()=>openModal(plotModal));
plotPill.addEventListener("keydown", (e)=>{ if(e.key==="Enter") openModal(plotModal); });

sortPill.addEventListener("click", ()=>openModal(sortModal));
sortPill.addEventListener("keydown", (e)=>{ if(e.key==="Enter") openModal(sortModal); });

/** =========================
 * Sort
 * ========================= */
function sortLabel(mode){
  if(mode==="latest") return "‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î";
  if(mode==="price_desc") return "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á ‚Üí ‡∏ï‡πà‡∏≥";
  if(mode==="price_asc") return "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥ ‚Üí ‡∏™‡∏π‡∏á";
  if(mode==="plot_asc") return "Plot A ‚Üí Z";
  return "‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î";
}
function sortUnits(arr){
  const a = [...arr];
  if(SORT_MODE==="latest"){
    a.sort((x,y)=> String(y.lastUpdated||"").localeCompare(String(x.lastUpdated||"")));
  }else if(SORT_MODE==="price_desc"){
    a.sort((x,y)=> toNumber(y.price)-toNumber(x.price));
  }else if(SORT_MODE==="price_asc"){
    a.sort((x,y)=> toNumber(x.price)-toNumber(y.price));
  }else if(SORT_MODE==="plot_asc"){
    a.sort((x,y)=> String(x.plot||"").localeCompare(String(y.plot||"")));
  }
  return a;
}

/** =========================
 * (5) Lazy image loader
 * ========================= */
let io = null;
function setupObserver(){
  if(io) return;
  io = new IntersectionObserver((entries)=>{
    for(const e of entries){
      if(!e.isIntersecting) continue;
      const img = e.target;
      const src = img.getAttribute("data-src");
      if(src){
        img.src = src;
        img.removeAttribute("data-src");
        img.decode?.().catch(()=>{});
        img.addEventListener("load", ()=>{
          const wrap = img.closest(".thumbWrap");
          if(wrap) wrap.classList.add("thumbLoaded");
        }, {once:true});
      }
      io.unobserve(img);
    }
  }, {rootMargin:"250px 0px"});
}

function renderGrid(){
  const list = (FILTER_PLOT==="ALL")
    ? ALL
    : ALL.filter(u => String(u.plot||"").trim() === FILTER_PLOT);

  countText.textContent = `${list.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  plotTitle.textContent = (FILTER_PLOT==="ALL") ? "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PLOT (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)" : `PLOT: ${FILTER_PLOT}`;
  sortSub.textContent = sortLabel(SORT_MODE);

  const sorted = sortUnits(list);

  grid.innerHTML = "";
  if(!sorted.length){
    grid.innerHTML = `<div class="card" style="padding:16px; border-radius:18px;">
      <b>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b><div style="color:rgba(15,23,42,.62); font-weight:900; margin-top:6px;">‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PLOT ‡∏≠‡∏∑‡πà‡∏ô</div>
    </div>`;
    return;
  }

  setupObserver();
  const frag = document.createDocumentFragment();

  for(const u of sorted){
    const imgReal = cleanDriveImage(u.thumbnail) || firstImageFromList(u.imageList) || "";

    const card = document.createElement("div");
    card.className = "card";

    const wrap = document.createElement("div");
    wrap.className = "thumbWrap";

    const img = document.createElement("img");
    img.className = "thumb";
    img.alt = u.id || "no image";
    img.loading = "lazy";
    img.decoding = "async";
    img.src = NO_IMAGE;                 // placeholder
    img.setAttribute("data-src", imgReal || NO_IMAGE);

    const shimmer = document.createElement("div");
    shimmer.className = "thumbBlur";

    wrap.appendChild(img);
    wrap.appendChild(shimmer);

    const body = document.createElement("div");
    body.className = "cardBody";
    body.innerHTML = `
      <div class="row1">
        <div class="hp">${u.id||""}</div>
        <div class="price">${moneyTHB(u.price||0)}</div>
      </div>
      <div class="iconsRow">
        <div class="miniPill">üõèÔ∏è ${u.bedrooms||"-"}</div>
        <div class="miniPill">üöø ${u.bathrooms||"-"}</div>
        <div class="miniPill">üìê ${u.livingSqm||"-"} m¬≤</div>
      </div>
      <button class="btnDetail">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
    `;
    body.querySelector(".btnDetail").addEventListener("click", () => {
      window.location.href = `details.html?id=${encodeURIComponent(u.id)}&project=${encodeURIComponent(PROJECT)}`;
    });

    card.appendChild(wrap);
    card.appendChild(body);
    frag.appendChild(card);

    if(io) io.observe(img);
  }

  grid.appendChild(frag);
}

/** =========================
 * Plot Modal (3)
 * ========================= */
function renderPlotModal(){
  const plots = new Map();
  for(const u of ALL){
    const plot = String(u.plot||"").trim() || "-";
    if(!plots.has(plot)) plots.set(plot, u);
  }
  const keys = [...plots.keys()].sort((a,b)=>a.localeCompare(b));

  plotList.innerHTML = "";

  // ALL
  {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="left">
        <div class="title">ALL</div>
        <div class="sub">${ALL.length} units ¬∑ Project_0</div>
      </div>
      <div class="tag gray">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
    `;
    div.addEventListener("click", ()=>{
      FILTER_PLOT = "ALL";
      closeModal(plotModal);
      renderGrid();
    });
    plotList.appendChild(div);
  }

  for(const p of keys){
    const u = plots.get(p) || {};
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="left">
        <div class="title">${p}</div>
        <div class="sub">üõèÔ∏è ${u.bedrooms||"-"} ¬∑ üöø ${u.bathrooms||"-"} ¬∑ üè† ${u.livingSqm||"-"} m¬≤</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:1100">${moneyTHB(u.price||0)}</div>
        <div class="tag">${u.status ? String(u.status) : "Available"}</div>
      </div>
    `;
    div.addEventListener("click", ()=>{
      FILTER_PLOT = p;
      closeModal(plotModal);
      renderGrid();
    });
    plotList.appendChild(div);
  }
}

/** =========================
 * Sort Modal (3)
 * ========================= */
function renderSortModal(){
  const options = [
    {key:"latest", label:"‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î"},
    {key:"price_desc", label:"‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á ‚Üí ‡∏ï‡πà‡∏≥"},
    {key:"price_asc", label:"‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥ ‚Üí ‡∏™‡∏π‡∏á"},
    {key:"plot_asc", label:"Plot A ‚Üí Z"},
  ];
  sortList.innerHTML = "";
  for(const o of options){
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="left">
        <div class="title">${o.label}</div>
        <div class="sub">${o.key}</div>
      </div>
      <div class="tag gray">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
    `;
    div.addEventListener("click", ()=>{
      SORT_MODE = o.key;
      closeModal(sortModal);
      renderGrid();
    });
    sortList.appendChild(div);
  }
}

/** =========================
 * Load data (auto) (4)
 * ========================= */
let _cache = null;
let _cacheTime = 0;

async function loadUnits(){
  hideError();

  const now = Date.now();
  if(_cache && (now - _cacheTime) < 60_000){
    ALL = _cache;
    renderPlotModal();
    renderSortModal();
    renderGrid();
    return;
  }

  const url = `${SCRIPT_URL}?mode=getUnitList&project=${encodeURIComponent(PROJECT)}`;

  let data;
  try{
    data = await jsonp(url);
  }catch(err){
    showError("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏ï‡∏£‡∏ß‡∏à Deploy Apps Script (Anyone) ‡πÅ‡∏•‡∏∞ URL /exec");
    return;
  }

  if(data && data.error){
    showError("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + data.error);
    return;
  }
  if(!Array.isArray(data)){
    showError("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà array)");
    return;
  }

  ALL = data.map(u => ({
    ...u,
    thumbnail: cleanDriveImage(u.thumbnail),
    imageList: String(u.imageList||"")
  }));

  _cache = ALL;
  _cacheTime = now;

  renderPlotModal();
  renderSortModal();

  // render ‡πÄ‡∏ö‡∏≤ ‡πÜ ‡∏•‡∏î‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å
  if("requestIdleCallback" in window){
    requestIdleCallback(()=>renderGrid(), {timeout:800});
  }else{
    setTimeout(renderGrid, 0);
  }
}

loadUnits();
</script>
</body>
</html>
