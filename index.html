<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>smart properties system · index</title>
  <style>
    :root{
      --bg:#a8bdd6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7c93;
      --radius:22px;
      --shadow: 0 12px 30px rgba(0,0,0,.12);
      --soft:#f3f6fb;
      --line:rgba(255,255,255,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Thai", sans-serif;
      background: radial-gradient(ellipse at top, rgba(255,255,255,.25), rgba(255,255,255,0) 55%) , var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:16px 14px 30px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.18);
      backdrop-filter: blur(10px);
      border: 1px solid var(--line);
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:44px; height:44px; border-radius:999px; background:rgba(255,255,255,.55);
      display:grid; place-items:center; font-weight:800;
      flex:0 0 auto;
    }
    .titles{min-width:0}
    .titles h1{
      margin:0;
      font-size:20px;
      line-height:1.15;
      font-weight:1100;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      letter-spacing:.2px;
    }
    .card{
      margin-top:14px;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(255,255,255,.65);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .content{padding:14px;}
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
    }
    @media(max-width:420px){
      .grid{grid-template-columns: 1fr;}
    }
    .unit{
      border-radius: 18px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(15,23,42,.06);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease;
    }
    .unit:active{ transform: scale(.985); }
    .img{
      width:100%;
      aspect-ratio: 16/10;
      object-fit:cover;
      display:block;
      background:#e8f0fb;
    }
    .body{
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .topRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .plot{
      font-weight:1100;
      font-size:13px;
      color: rgba(15,23,42,.95);
      flex:1 1 auto;
      min-width:0;
    }
    .status{
      padding:5px 8px;
      border-radius: 999px;
      font-weight:1100;
      font-size:11px;
      background: rgba(255,255,255,.92);
      border: 2px solid rgba(15,23,42,.15);
      color: rgba(15,23,42,.88);
      white-space:nowrap;
      flex:0 0 auto;
    }
    .price{
      font-weight:1100;
      font-size:16px;
      color: rgba(15,23,42,.92);
      white-space:nowrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">SP</div>
        <div class="titles">
          <h1>Smart Properties System</h1>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="content">
        <div class="grid" id="grid"></div>
      </div>
    </div>
  </div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvzszMpjb1Dy3nQDhh64oPYu1-CgL-RSdRe52Df_pejfqkhq-g70z96npgaSyNAw2T/exec";

  function normalizeProjectName(p){
    const s = String(p || "").trim();
    const map = {
      "Project_0": "project_000",
      "Project_A": "project_001",
      "Project_B": "project_002",
      "Project_C": "project_003",
      "Project_D": "project_004",
      "project_0": "project_000",
      "project_A": "project_001",
      "project_B": "project_002",
      "project_C": "project_003",
      "project_D": "project_004",
    };
    return map[s] || s || "project_000";
  }

  const qs = new URLSearchParams(location.search);
  const PROJECT = normalizeProjectName(qs.get("project"));

  function jsonp(url, timeoutMs = 20000){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const script = document.createElement("script");
      const timer = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, timeoutMs);

      function cleanup(){
        clearTimeout(timer);
        if (script.parentNode) script.parentNode.removeChild(script);
        try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
      }
      window[cb] = (data) => { cleanup(); resolve(data); };

      const sep = url.includes("?") ? "&" : "?";
      script.src = url + sep + "callback=" + encodeURIComponent(cb);
      script.onerror = () => { cleanup(); reject(new Error("jsonp_error")); };
      document.body.appendChild(script);
    });
  }

  function toNumber(x){
    const s = String(x ?? "").replace(/,/g,"").trim();
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }
  function moneyTHB(x){
    const n = toNumber(x);
    return "฿" + n.toLocaleString("en-US");
  }
  function cleanDriveImage(url){
    const u = String(url || "").trim();
    if(!u) return "";
    if (u.includes("lh3.googleusercontent.com/d/")) return u;

    let id = "";
    const m1 = u.match(/\/d\/([a-zA-Z0-9_-]+)/);
    if (m1) id = m1[1];
    const m2 = u.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    if (!id && m2) id = m2[1];
    const m3 = u.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
    if (!id && m3) id = m3[1];

    if (id) return "https://lh3.googleusercontent.com/d/" + id;
    return u;
  }

  function statusStyle(statusRaw){
    const s = String(statusRaw||"").trim().toLowerCase();
    if (s.includes("available")) return {border:"rgba(16,185,129,.65)", text:"rgba(5,150,105,1)"};
    if (s.includes("under"))     return {border:"rgba(14,165,233,.55)", text:"rgba(2,132,199,1)"};
    if (s.includes("reserved"))  return {border:"rgba(245,158,11,.55)", text:"rgba(180,83,9,1)"};
    if (s.includes("sold"))      return {border:"rgba(244,63,94,.55)",  text:"rgba(190,18,60,1)"};
    return {border:"rgba(15,23,42,.25)", text:"rgba(15,23,42,.92)"};
  }

  function render(units){
    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    for(const u of units){
      const id = String(u?.id || u?.HP_ID || "").trim();
      const plot = String(u?.plot || u?.Plot || id || "-").trim();
      const thumb = cleanDriveImage(u?.thumbnail || u?.Thumbnail_Image || "");
      const st = String(u?.status || u?.Status || "-").trim() || "-";
      const price = moneyTHB(u?.price || u?.Price || 0);

      const pill = statusStyle(st);

      const card = document.createElement("div");
      card.className = "unit";
      card.innerHTML = `
        <img class="img" src="${thumb || "data:image/svg+xml;charset=utf-8," + encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='800'><rect width='100%' height='100%' fill='#e6edf6'/><text x='50%' y='50%' text-anchor='middle' fill='#8aa0bb' font-size='40' font-family='Arial'>no image</text></svg>")}" alt="thumb" loading="lazy" decoding="async">
        <div class="body">
          <div class="topRow">
            <div class="plot">${plot}</div>
            <div class="status" style="border-color:${pill.border}; color:${pill.text};">${st}</div>
          </div>
          <div class="price">${price}</div>
        </div>
      `;

      card.addEventListener("click", ()=>{
        location.href = `details.html?id=${encodeURIComponent(id)}&project=${encodeURIComponent(PROJECT)}`;
      });

      grid.appendChild(card);
    }
  }

  (async function init(){
    const url = `${SCRIPT_URL}?mode=getUnitList&project=${encodeURIComponent(PROJECT)}`;
    const data = await jsonp(url);
    if(Array.isArray(data)) render(data);
  })();
</script>
</body>
</html>
