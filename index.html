<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>smart properties system ¬∑ Catalog</title>

  <!-- LINE-like font (best effort) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LINESeed/seed-font@main/css/LINESeedSansTH.css" />

  <style>
    :root{
      --bg1:#89A6C7;
      --bg2:#BFD0E6;
      --card:#ffffffee;
      --ink:#0b1320;
      --muted:#617086;
      --lineGreen:#06C755;
      --chip:#eef2f7;
      --shadow: 0 16px 40px rgba(0,0,0,.12);
      --r24: 24px;
      --r28: 28px;
      --r32: 32px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "LINE Seed Sans TH","LINE Seed Sans","Kanit",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
      overflow-x:hidden;
    }

    /* LINE cloud background (light, not too many) */
    body:before, body:after{
      content:"";
      position:fixed;
      inset:-20% -10%;
      pointer-events:none;
      z-index:-1;
      background:
        radial-gradient(ellipse at 18% 28%, rgba(255,255,255,.26) 0 22%, transparent 23%),
        radial-gradient(ellipse at 72% 32%, rgba(255,255,255,.22) 0 24%, transparent 25%),
        radial-gradient(ellipse at 28% 78%, rgba(255,255,255,.18) 0 20%, transparent 21%),
        radial-gradient(ellipse at 78% 82%, rgba(255,255,255,.16) 0 19%, transparent 20%);
      filter: blur(.2px);
      opacity:.95;
    }
    body:after{
      inset:-30% -20%;
      opacity:.35;
      filter: blur(1.2px);
    }

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:18px 16px 28px;
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 10px 14px;
    }
    .avatar{
      width:44px;height:44px;border-radius:18px;
      background:#dbe7f6;
      display:grid;place-items:center;
      font-weight:800;
      letter-spacing:.3px;
      box-shadow: 0 6px 16px rgba(0,0,0,.10);
      flex:0 0 auto;
    }
    .brand{
      flex:1 1 auto;
      min-width:0;
    }
    .brand h1{
      margin:0;
      font-size:22px;
      line-height:1.1;
      font-weight:800;
      letter-spacing:-.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .sub{
      margin-top:2px;
      color:rgba(0,0,0,.55);
      font-size:13px;
      font-weight:500;
    }
    .iconBtn{
      width:44px;height:44px;border-radius:18px;
      background:rgba(255,255,255,.80);
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.55);
      box-shadow: 0 10px 24px rgba(0,0,0,.10);
      cursor:pointer;
      user-select:none;
      flex:0 0 auto;
    }
    .iconBtn:active{transform:scale(.98)}
    .iconBtn svg{width:22px;height:22px;opacity:.86}

    /* Controls */
    .controls{
      margin-top:6px;
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap:10px;
      align-items:center;
    }
    .pill{
      border-radius:20px;
      background:rgba(255,255,255,.55);
      border:1px solid rgba(255,255,255,.55);
      padding:12px 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
      display:flex;
      gap:10px;
      align-items:center;
      min-height:48px;
    }
    .pill .left{
      font-weight:700;
      color:rgba(0,0,0,.82);
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .pill .right{
      margin-left:auto;
      color:rgba(0,0,0,.55);
      font-weight:700;
      font-size:13px;
      white-space:nowrap;
    }
    .pill .chev{
      width:18px;height:18px; opacity:.65; flex:0 0 auto;
    }

    .btnGreen{
      border:0;
      border-radius:18px;
      background: var(--lineGreen);
      color:#fff;
      font-weight:800;
      padding:12px 16px;
      min-height:48px;
      box-shadow: 0 14px 26px rgba(6,199,85,.28);
      cursor:pointer;
    }
    .btnGreen:active{transform:scale(.99)}
    select.sort{
      border:0;
      border-radius:18px;
      background:rgba(255,255,255,.72);
      color:rgba(0,0,0,.75);
      font-weight:800;
      padding:12px 14px;
      min-height:48px;
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
      outline:none;
      cursor:pointer;
    }

    /* Grid cards */
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 720px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width: 1100px){
      .grid{ grid-template-columns: repeat(3, 1fr); }
      .wrap{max-width:1200px}
    }

    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.55);
      border-radius: var(--r32);
      overflow:hidden;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }
    .thumb{
      height:210px;
      background:#e9eef6;
      position:relative;
      overflow:hidden;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb .noimg{
      position:absolute; inset:0;
      display:grid; place-items:center;
      color:#7c8aa0;
      font-weight:800;
      letter-spacing:.2px;
      font-size:14px;
    }
    .row{
      padding:14px 14px 12px;
    }
    .titleRow{
      display:flex; gap:10px; align-items:baseline;
    }
    .unit{
      font-size:20px;
      font-weight:900;
      letter-spacing:-.4px;
    }
    .price{
      margin-left:auto;
      font-size:18px;
      font-weight:900;
      letter-spacing:-.2px;
    }
    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
    .chip{
      background:rgba(255,255,255,.62);
      border:1px solid rgba(0,0,0,.05);
      border-radius:999px;
      padding:8px 10px;
      font-weight:800;
      font-size:13px;
      color:rgba(0,0,0,.70);
      display:flex;
      gap:6px;
      align-items:center;
      min-height:34px;
    }
    .chip .mini{
      opacity:.80;
      font-weight:900;
    }
    .status{
      margin-left:auto;
      border-radius:999px;
      padding:8px 12px;
      font-size:13px;
      font-weight:900;
      border:1px solid rgba(0,0,0,.05);
      background:#e8eef7;
      color:#2e3a4c;
      white-space:nowrap;
    }
    .st-available{ background:#dff7ea; color:#0d7a43; }
    .st-under{ background:#d9eefc; color:#116aa0; }
    .st-reserved{ background:#fff2d7; color:#9a6a12; }
    .st-sold{ background:#ffe1e1; color:#a01818; }

    .btnDetail{
      margin-top:12px;
      width:100%;
      border:0;
      border-radius: 22px;
      background:#c9f2d9;
      color:#0c2b1a;
      font-weight:900;
      padding:14px 14px;
      cursor:pointer;
      font-size:16px;
      letter-spacing:.2px;
      box-shadow: 0 12px 22px rgba(0,0,0,.08);
    }
    .btnDetail:active{transform:scale(.995)}

    /* Loading */
    .loading{
      margin:22px 0 6px;
      color:rgba(0,0,0,.55);
      font-weight:800;
      text-align:center;
    }
    .skeleton{
      border-radius: var(--r32);
      overflow:hidden;
      background:rgba(255,255,255,.35);
      border:1px solid rgba(255,255,255,.45);
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      height:320px;
      position:relative;
    }
    .skeleton:before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
      transform: translateX(-100%);
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer{
      0%{transform:translateX(-100%)}
      100%{transform:translateX(100%)}
    }

    /* Plot modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.26);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }
    .modal{
      width:min(720px, 96vw);
      background: rgba(255,255,255,.92);
      border-radius: 28px;
      border:1px solid rgba(255,255,255,.70);
      box-shadow: 0 26px 60px rgba(0,0,0,.22);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .modalHead{
      display:flex;
      align-items:center;
      gap:12px;
      padding:16px 18px;
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .modalHead .ttl{
      font-size:18px;
      font-weight:900;
      letter-spacing:-.2px;
    }
    .modalHead .closeBtn{
      margin-left:auto;
      border:0;
      border-radius: 999px;
      padding:10px 16px;
      font-weight:900;
      cursor:pointer;
      background:#ff5a5a;
      color:#fff;
    }
    .modalList{
      max-height: 70vh;
      overflow:auto;
      padding:8px 10px 12px;
    }
    .plotRow{
      padding:12px 12px;
      border-radius: 18px;
      display:flex;
      gap:12px;
      align-items:center;
      cursor:pointer;
    }
    .plotRow:hover{ background: rgba(0,0,0,.04); }
    .plotRow .name{
      font-weight:900;
      font-size:18px;
      color:#1a3550;
      width:88px;
      flex:0 0 auto;
    }
    .plotRow .mid{
      flex:1 1 auto;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      color:rgba(0,0,0,.68);
      font-weight:800;
      font-size:13px;
    }
    .plotRow .price{
      font-size:18px;
      font-weight:900;
      color:#152032;
      flex:0 0 auto;
      min-width:130px;
      text-align:right;
    }

    .tiny{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:7px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.04);
      border:1px solid rgba(0,0,0,.05);
      white-space:nowrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="avatar">SP</div>
      <div class="brand">
        <h1>smart properties system</h1>
        <div class="sub">Catalog ¬∑ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö feel LINE</div>
      </div>

      <!-- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ñ‡∏ô ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Gateway -->
      <div class="iconBtn" id="btnGateway" title="Gateway">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 12c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5Z" stroke="currentColor" stroke-width="2"/>
          <path d="M4 22c0-4.42 3.58-8 8-8s8 3.58 8 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
    </div>

    <div class="controls">
      <!-- Project_0 only (fixed) -->
      <div class="pill" id="pillPlot" role="button" tabindex="0" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Plot">
        <div class="left" id="plotLabel">Project_0 ¬∑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PLOT</div>
        <div class="right" id="countLabel">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <button class="btnGreen" id="btnReload">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>

      <select class="sort" id="sortSel" title="‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö">
        <option value="latest">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
        <option value="price_desc">‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏°‡∏≤‡∏Å ‚Üí ‡∏ô‡πâ‡∏≠‡∏¢</option>
        <option value="price_asc">‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ô‡πâ‡∏≠‡∏¢ ‚Üí ‡∏°‡∏≤‡∏Å</option>
        <option value="plot_asc">PLOT: A ‚Üí Z</option>
      </select>
    </div>

    <div id="loading" class="loading" style="display:none;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

    <div class="grid" id="grid">
      <!-- skeletons -->
    </div>
  </div>

  <!-- Plot Modal -->
  <div class="modalBack" id="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="ttl">Project Plots (Project_0)</div>
        <button class="closeBtn" id="btnCloseModal">CLOSE</button>
      </div>
      <div class="modalList" id="modalList"></div>
    </div>
  </div>

<script>
/* ===================== CONFIG ===================== */
const API_URL = "https://script.google.com/macros/s/AKfycbwvCiaEKxvRI9rQCXMR_F4SHqmkJT4CnAuoVgEr6RYACmfgKerp7r06m-ltBMu4GFD4/exec";
const PROJECT = "Project_0";                 // ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Project_0 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
const CACHE_KEY = "MLS_CACHE_UNITLIST_P0_V1";
const CACHE_TTL_MS = 60 * 1000;            // 60s
const DETAILS_URL = "details.html";         // same folder
const GATEWAY_URL = "gateway.html";

/* ===================== HELPERS ===================== */
const qs = new URLSearchParams(location.search);
let selectedPlot = (qs.get("plot") || "").trim();

function money(v){
  const n = Number(v);
  if (!n) return "‡∏ø0";
  return "‡∏ø" + n.toLocaleString("en-US");
}
function normStr(v){ return (v==null? "" : String(v)).trim(); }
function statusClass(s){
  s = normStr(s).toLowerCase();
  if (s.includes("avail")) return "st-available";
  if (s.includes("under")) return "st-under";
  if (s.includes("reser")) return "st-reserved";
  if (s.includes("sold")) return "st-sold";
  return "";
}
function safeImg(url){
  url = normStr(url);
  if (!url) return "";
  return url;
}

function setUrlPlot(plot){
  const u = new URL(location.href);
  if (plot) u.searchParams.set("plot", plot);
  else u.searchParams.delete("plot");
  history.replaceState({}, "", u.toString());
}

/* ===================== CACHE (fast load) ===================== */
function readCache(){
  try{
    const raw = localStorage.getItem(CACHE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || !obj.data || !obj.ts) return null;
    return obj;
  }catch(e){ return null; }
}
function writeCache(data){
  try{
    localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), data }));
  }catch(e){}
}

/* ===================== API (robust) ===================== */
/**
 * ‡πÄ‡∏£‡∏≤‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏¢ mode ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ù‡∏±‡πà‡∏á Apps Script ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
 * - getUnitList
 * - list
 * - units
 */
async function fetchUnitList(){
  const urlCandidates = [
    `${API_URL}?mode=getUnitList&project=${encodeURIComponent(PROJECT)}&t=${Date.now()}`,
    `${API_URL}?mode=list&project=${encodeURIComponent(PROJECT)}&t=${Date.now()}`,
    `${API_URL}?mode=units&project=${encodeURIComponent(PROJECT)}&t=${Date.now()}`
  ];

  let lastErr = null;
  for (const u of urlCandidates){
    try{
      const res = await fetch(u, { cache: "no-store" });
      const data = await res.json();
      const arr = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : (Array.isArray(data?.items) ? data.items : null));
      if (arr && arr.length >= 0) return arr;
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error("Cannot load unit list");
}

/* ===================== UI ===================== */
const grid = document.getElementById("grid");
const loading = document.getElementById("loading");
const plotLabel = document.getElementById("plotLabel");
const countLabel = document.getElementById("countLabel");
const sortSel = document.getElementById("sortSel");

const modalBack = document.getElementById("modalBack");
const modalList = document.getElementById("modalList");
const pillPlot = document.getElementById("pillPlot");

document.getElementById("btnGateway").addEventListener("click", () => {
  location.href = `${GATEWAY_URL}?project=${encodeURIComponent(PROJECT)}`;
});
document.getElementById("btnReload").addEventListener("click", () => hardReload());

pillPlot.addEventListener("click", () => openModal());
pillPlot.addEventListener("keydown", (e) => { if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openModal(); }});
document.getElementById("btnCloseModal").addEventListener("click", closeModal);
modalBack.addEventListener("click", (e) => { if(e.target === modalBack) closeModal(); });

sortSel.addEventListener("change", () => renderAll(window.__UNITS__ || []));

function skeletons(){
  grid.innerHTML = "";
  for(let i=0;i<6;i++){
    const d = document.createElement("div");
    d.className = "skeleton";
    grid.appendChild(d);
  }
}

function openModal(){
  modalBack.style.display = "flex";
  modalBack.setAttribute("aria-hidden","false");
}
function closeModal(){
  modalBack.style.display = "none";
  modalBack.setAttribute("aria-hidden","true");
}

function renderPlotModal(units){
  // group by plot
  const map = new Map();
  for(const u of units){
    const plot = normStr(u.plot || u.Plot || u.plotNo || u.PLOT);
    if(!plot) continue;
    if(!map.has(plot)) map.set(plot, []);
    map.get(plot).push(u);
  }
  const plots = Array.from(map.keys()).sort((a,b)=>a.localeCompare(b));

  // "ALL"
  const allRow = `
    <div class="plotRow" data-plot="">
      <div class="name">ALL</div>
      <div class="mid">
        <span class="tiny">üì¶ ${units.length} units</span>
        <span class="tiny">Project_0</span>
      </div>
      <div class="price"> </div>
    </div>
  `;

  const rows = plots.map(p=>{
    const list = map.get(p);
    // best effort summary like ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 2 (beds baths sqm status)
    // pick min price as display
    let minPrice = Infinity;
    let bed = "", bath = "", sqm = "", st = "";
    for(const it of list){
      const pr = Number(it.price || it.Price || it.PRICE || 0);
      if(pr && pr < minPrice) minPrice = pr;
      bed = bed || normStr(it.bedrooms || it.bed || it.Bed || it.Bedrooms);
      bath = bath || normStr(it.bathrooms || it.bath || it.Bath || it.Bathrooms);
      sqm = sqm || normStr(it.livingSqm || it.sqm || it.LivingSqm || it.AreaSqm);
      st = st || normStr(it.status || it.Status);
    }
    const stCls = statusClass(st);
    const stShow = st ? `<span class="tiny ${stCls ? "" : ""}" style="${stCls ? "" : ""}">${st}</span>` : "";
    return `
      <div class="plotRow" data-plot="${encodeURIComponent(p)}">
        <div class="name">${p}</div>
        <div class="mid">
          ${bed ? `<span class="tiny">üõè ${bed} Bed</span>` : ""}
          ${bath ? `<span class="tiny">üöø ${bath} Bath</span>` : ""}
          ${sqm ? `<span class="tiny">üè† ${sqm} m¬≤</span>` : ""}
          ${stShow}
          <span class="tiny">üì¶ ${list.length} units</span>
        </div>
        <div class="price">${minPrice !== Infinity ? money(minPrice) : ""}</div>
      </div>
    `;
  }).join("");

  modalList.innerHTML = allRow + rows;

  modalList.querySelectorAll(".plotRow").forEach(el=>{
    el.addEventListener("click", ()=>{
      const p = decodeURIComponent(el.getAttribute("data-plot") || "");
      selectedPlot = p;
      setUrlPlot(selectedPlot);
      closeModal();
      renderAll(window.__UNITS__ || []);
    });
  });
}

function normalizeUnit(u){
  const id = normStr(u.id || u.hp_id || u.HP_ID || u.unitId || u.Unit || u.unit || u.HP || u.hpId);
  const plot = normStr(u.plot || u.Plot || u.plotNo || u.PLOT || u.PlotNo);
  const price = Number(u.price || u.Price || u.PRICE || 0) || 0;
  const status = normStr(u.status || u.Status || u.SaleStatus || u.saleStatus);
  const bedrooms = normStr(u.bedrooms || u.Bedrooms || u.bed || u.Bed);
  const bathrooms = normStr(u.bathrooms || u.Bathrooms || u.bath || u.Bath);
  const landSqw = normStr(u.landSqw || u.LandSqw || u.land || u.Land);
  const livingSqm = normStr(u.livingSqm || u.LivingSqm || u.sqm || u.AreaSqm || u.areaSqm);
  const thumb = safeImg(u.thumbnail || u.thumb || u.cover || u.Cover || u.coverUrl || u.thumbnailUrl);
  const updated = normStr(u.updated || u.updatedAt || u.Updated || u.LastUpdate || u.lastUpdate);
  return { id, plot, price, status, bedrooms, bathrooms, landSqw, livingSqm, thumb, updated, raw:u };
}

function sortUnits(units){
  const mode = sortSel.value;
  const arr = [...units];
  if(mode === "price_desc") arr.sort((a,b)=> (b.price||0)-(a.price||0));
  else if(mode === "price_asc") arr.sort((a,b)=> (a.price||0)-(b.price||0));
  else if(mode === "plot_asc") arr.sort((a,b)=> (a.plot||"").localeCompare(b.plot||""));
  else { // latest
    arr.sort((a,b)=> (normStr(b.updated)).localeCompare(normStr(a.updated)));
  }
  return arr;
}

function renderAll(unitsRaw){
  const units = unitsRaw.map(normalizeUnit).filter(x=>x.id);
  window.__UNITS_NORM__ = units;

  // modal plot list
  renderPlotModal(unitsRaw);

  // filter
  let shown = units;
  if(selectedPlot){
    shown = units.filter(u=>u.plot === selectedPlot);
    plotLabel.textContent = `Project_0 ¬∑ PLOT ${selectedPlot}`;
  }else{
    plotLabel.textContent = `Project_0 ¬∑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PLOT`;
  }
  countLabel.textContent = `${shown.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

  // sort
  shown = sortUnits(shown);

  // render cards
  if(!shown.length){
    grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:24px 12px;font-weight:900;color:rgba(0,0,0,.55)">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
    return;
  }

  grid.innerHTML = shown.map(u=>{
    const stCls = statusClass(u.status);
    const thumb = u.thumb;
    const imgHtml = thumb
      ? `<img src="${thumb}" alt="${u.id}" loading="lazy" decoding="async" fetchpriority="low"
            onerror="this.style.display='none'; this.parentElement.querySelector('.noimg').style.display='grid';">`
      : ``;

    return `
      <div class="card">
        <div class="thumb">
          ${imgHtml}
          <div class="noimg" style="display:${thumb?'none':'grid'}">no image</div>
        </div>

        <div class="row">
          <div class="titleRow">
            <div class="unit">${u.id}</div>
            <div class="price">${money(u.price)}</div>
          </div>

          <div class="chips">
            <div class="chip"><span class="mini">üõè</span>${u.bedrooms || "-"}</div>
            <div class="chip"><span class="mini">üõÅ</span>${u.bathrooms || "-"}</div>
            <div class="chip"><span class="mini">üìê</span>${u.landSqw ? `${u.landSqw} sq.w` : "-"}</div>
            <div class="status ${stCls}">${u.status || "‚Äî"}</div>
          </div>

          <button class="btnDetail" onclick="location.href='${DETAILS_URL}?id=${encodeURIComponent(u.id)}'">
            ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
          </button>
        </div>
      </div>
    `;
  }).join("");
}

async function softLoadFromCache(){
  const cached = readCache();
  if(cached?.data){
    window.__UNITS__ = cached.data;
    renderAll(cached.data);
    // stale-while-revalidate
    const isFresh = (Date.now() - cached.ts) < CACHE_TTL_MS;
    if(!isFresh){
      try{ await refreshInBackground(); }catch(e){}
    }
    return true;
  }
  return false;
}

async function refreshInBackground(){
  const data = await fetchUnitList();
  window.__UNITS__ = data;
  writeCache(data);
  renderAll(data);
}

async function hardReload(){
  skeletons();
  loading.style.display = "block";
  try{
    const data = await fetchUnitList();
    window.__UNITS__ = data;
    writeCache(data);
    renderAll(data);
  }catch(e){
    grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:24px 12px;font-weight:900;color:#8b1a1a;background:rgba(255,255,255,.75);border-radius:24px;border:1px solid rgba(0,0,0,.06)">
      ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br><span style="font-weight:700;color:rgba(0,0,0,.55)">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Apps Script ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô Web App ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Public ‡πÅ‡∏•‡πâ‡∏ß</span>
    </div>`;
  }finally{
    loading.style.display = "none";
  }
}

(async function init(){
  skeletons();
  loading.style.display = "block";

  // 1) show cache instantly if possible
  const hadCache = await softLoadFromCache();
  loading.style.display = hadCache ? "none" : "block";

  // 2) always try update quickly (but not block UI if cache exists)
  try{
    await refreshInBackground();
  }catch(e){
    if(!hadCache){
      grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:24px 12px;font-weight:900;color:#8b1a1a;background:rgba(255,255,255,.75);border-radius:24px;border:1px solid rgba(0,0,0,.06)">
        ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br><span style="font-weight:700;color:rgba(0,0,0,.55)">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏Å‡∏î ‚Äú‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‚Äù ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
      </div>`;
    }
  }finally{
    loading.style.display = "none";
  }
})();
</script>
</body>
</html>
