<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>smart properties system</title>

  <link rel="preconnect" href="https://script.google.com">
  <link rel="preconnect" href="https://lh3.googleusercontent.com">
  <style>
    :root{
      --bg:#a8bdd6;
      --card:#ffffff;
      --muted:#6b7c93;
      --text:#0f172a;
      --pill:#eef2f7;
      --green:#19b45b;
      --softGreen:#c9f3dd;
      --radius:22px;
      --shadow: 0 12px 30px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Thai", sans-serif;
      background: radial-gradient(ellipse at top, rgba(255,255,255,.25), rgba(255,255,255,0) 55%) , var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:16px 14px 28px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.18);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:44px; height:44px; border-radius:999px; background:rgba(255,255,255,.55);
      display:grid; place-items:center; font-weight:800;
      letter-spacing:.5px;
    }
    .titles h1{margin:0; font-size:28px; line-height:1.1; font-weight:900;}
    .titles .sub{color:rgba(15,23,42,.7); font-weight:600; margin-top:2px;}
    .avatarBtn{
      width:44px; height:44px; border-radius:999px;
      border:0;
      background: rgba(255,255,255,.55);
      display:grid; place-items:center;
      cursor:pointer;
    }

    .controls{
      margin-top:14px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      flex:1;
      min-width:260px;
      background: rgba(255,255,255,.35);
      border:1px solid rgba(255,255,255,.45);
      border-radius: 18px;
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .pill strong{font-size:22px}
    .pill .meta{color:rgba(15,23,42,.6); font-weight:700}
    .btn{
      border:0;
      border-radius: 18px;
      padding:14px 18px;
      font-weight:900;
      cursor:pointer;
    }
    .btn.green{background: var(--green); color:#fff; box-shadow: var(--shadow);}
    .select{
      border:0;
      border-radius: 18px;
      padding:14px 14px;
      font-weight:900;
      background: rgba(255,255,255,.55);
      cursor:pointer;
      min-width:140px;
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 900px){
      .grid{grid-template-columns: repeat(3, 1fr);}
    }

    .card{
      background: rgba(255,255,255,.82);
      border:1px solid rgba(255,255,255,.65);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 10px 25px rgba(0,0,0,.10);
    }
    .thumb{
      width:100%;
      aspect-ratio: 16 / 9;
      background: #e6edf6;
      display:block;
      object-fit:cover;
    }
    .cardBody{padding:14px 14px 12px;}
    .row1{display:flex; align-items:flex-end; justify-content:space-between; gap:10px;}
    .hp{font-size:22px; font-weight:1000; letter-spacing:.4px;}
    .price{font-size:20px; font-weight:1000;}
    .iconsRow{display:flex; gap:10px; margin-top:10px;}
    .miniPill{
      background: rgba(15,23,42,.06);
      border:1px solid rgba(15,23,42,.06);
      padding:10px 12px;
      border-radius: 999px;
      display:flex; align-items:center; gap:8px;
      font-weight:900;
      min-width: 84px;
      justify-content:center;
    }
    .btnDetail{
      width:100%;
      margin-top:12px;
      background: var(--softGreen);
      border:0;
      border-radius: 16px;
      padding:14px 14px;
      font-weight:1000;
      cursor:pointer;
    }

    /* loader */
    .skeleton{
      background: linear-gradient(90deg, rgba(255,255,255,.55), rgba(255,255,255,.25), rgba(255,255,255,.55));
      background-size: 200% 100%;
      animation: shimmer 1.2s infinite linear;
    }
    @keyframes shimmer{
      0%{background-position: 200% 0;}
      100%{background-position: -200% 0;}
    }

    /* Modal (‡πÅ‡∏Å‡πâ pop up ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥) */
    .modalBackdrop{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.35);
      z-index:9999;
    }
    .modalBackdrop.show{display:flex;}
    .modal{
      width:min(680px, 100%);
      max-height: min(80vh, 720px);
      overflow:auto;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.65);
      border-radius: 24px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:6px 6px 10px;
      position:sticky; top:0;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      z-index:2;
    }
    .modalHeader h2{margin:0; font-size:22px; font-weight:1000;}
    .closeBtn{
      border:0; border-radius: 999px;
      padding:10px 14px;
      font-weight:1000;
      background:#f04a3a; color:#fff;
      cursor:pointer;
    }
    .plotList{display:flex; flex-direction:column; gap:10px; padding:8px 6px 12px;}
    .plotItem{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:12px;
      border-radius: 18px;
      background: rgba(15,23,42,.04);
      border:1px solid rgba(15,23,42,.06);
      cursor:pointer;
    }
    .plotLeft .plot{font-size:22px; font-weight:1000;}
    .plotLeft .mini{display:flex; gap:10px; margin-top:6px; color:rgba(15,23,42,.75); font-weight:800; flex-wrap:wrap;}
    .badge{
      padding:8px 12px;
      border-radius: 999px;
      font-weight:1000;
      background: rgba(25,180,91,.12);
      color: rgba(25,120,70,1);
      white-space:nowrap;
    }
    .badge.sold{background: rgba(240,74,58,.12); color: rgba(180,45,35,1);}
    .muted{color:rgba(15,23,42,.55); font-weight:800;}

    .errorBox{
      margin-top:14px;
      padding:14px;
      border-radius: 18px;
      background: rgba(255,255,255,.7);
      border:1px solid rgba(255,255,255,.65);
      font-weight:900;
      color:#8b1d1d;
      display:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">SP</div>
        <div class="titles">
          <h1>smart properties system</h1>
          <div class="sub">Catalog ¬∑ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö feel LINE</div>
        </div>
      </div>
      <!-- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ñ‡∏ô (‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Gateway/Edit) -->
      <button class="avatarBtn" id="btnGateway" title="Gateway / Edit">
        üë§
      </button>
    </div>

    <div class="controls">
      <div class="pill" id="plotPill" role="button" tabindex="0">
        <div>
          <strong id="projectName">Project_0</strong>
          <span class="muted">¬∑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PLOT</span>
          <span class="muted" id="countText">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </div>
        <div class="meta">‚ñº</div>
      </div>

      <button class="btn green" id="btnLoad">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>

      <select class="select" id="sortSelect">
        <option value="latest">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
        <option value="price_desc">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‚Üí‡∏ï‡πà‡∏≥</option>
        <option value="price_asc">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‚Üí‡∏™‡∏π‡∏á</option>
        <option value="plot_asc">Plot A‚ÜíZ</option>
      </select>
    </div>

    <div class="errorBox" id="errBox"></div>

    <div class="grid" id="grid">
      <!-- cards -->
    </div>
  </div>

  <!-- Plot Modal -->
  <div class="modalBackdrop" id="plotModal">
    <div class="modal">
      <div class="modalHeader">
        <h2>Project Plots (Project_0)</h2>
        <button class="closeBtn" id="closePlot">CLOSE</button>
      </div>
      <div class="plotList" id="plotList"></div>
    </div>
  </div>

<script>
/** =========================
 * CONFIG
 * ========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvzszMpjb1Dy3nQDhh64oPYu1-CgL-RSdRe52Df_pejfqkhq-g70z96npgaSyNAw2T/exec";
const PROJECT = "Project_0";

// ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏ì
const GATEWAY_URL = "https://agent-smart-system-interface.github.io/Master-List-Properties/"; // ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤ gateway ‡∏à‡∏£‡∏¥‡∏á

/** =========================
 * JSONP Helper (‡πÅ‡∏Å‡πâ CORS)
 * ========================= */
function jsonp(url, timeoutMs = 20000){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const script = document.createElement("script");
    const timer = setTimeout(() => {
      cleanup();
      reject(new Error("timeout"));
    }, timeoutMs);

    function cleanup(){
      clearTimeout(timer);
      if (script.parentNode) script.parentNode.removeChild(script);
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
    }

    window[cb] = (data) => { cleanup(); resolve(data); };

    const sep = url.includes("?") ? "&" : "?";
    script.src = url + sep + "callback=" + encodeURIComponent(cb);
    script.onerror = () => { cleanup(); reject(new Error("jsonp_error")); };
    document.body.appendChild(script);
  });
}

/** =========================
 * Utilities
 * ========================= */
function toNumber(x){
  const s = String(x ?? "").replace(/,/g,"").trim();
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function moneyTHB(x){
  const n = toNumber(x);
  return "‡∏ø" + n.toLocaleString("en-US");
}
function cleanDriveImage(url){
  const u = String(url || "").trim();
  if(!u) return "";
  // already googleusercontent direct
  if (u.includes("lh3.googleusercontent.com/d/")) return u;

  // drive file id patterns
  let id = "";
  const m1 = u.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if (m1) id = m1[1];
  const m2 = u.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if (!id && m2) id = m2[1];
  const m3 = u.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
  if (!id && m3) id = m3[1];

  if (id) return "https://lh3.googleusercontent.com/d/" + id;
  return u;
}
function firstImageFromList(imageList){
  const arr = String(imageList||"").split(",").map(s=>s.trim()).filter(Boolean);
  return arr.length ? cleanDriveImage(arr[0]) : "";
}

/** =========================
 * State
 * ========================= */
let ALL = [];
let FILTER_PLOT = "ALL";

/** =========================
 * DOM
 * ========================= */
const grid = document.getElementById("grid");
const errBox = document.getElementById("errBox");
const countText = document.getElementById("countText");
const plotPill = document.getElementById("plotPill");
const plotModal = document.getElementById("plotModal");
const plotList = document.getElementById("plotList");
const sortSelect = document.getElementById("sortSelect");

document.getElementById("btnGateway").addEventListener("click", () => {
  // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Gateway/Edit
  window.location.href = GATEWAY_URL;
});

/** ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î modal */
function openPlotModal(){
  plotModal.classList.add("show");
  document.body.style.overflow = "hidden";
}
function closePlotModal(){
  plotModal.classList.remove("show");
  document.body.style.overflow = "";
}
document.getElementById("closePlot").addEventListener("click", closePlotModal);
plotModal.addEventListener("click", (e) => {
  if(e.target === plotModal) closePlotModal();
});
plotPill.addEventListener("click", openPlotModal);
plotPill.addEventListener("keydown", (e)=>{ if(e.key==="Enter") openPlotModal(); });

/** =========================
 * Render
 * ========================= */
function showError(msg){
  errBox.style.display = "block";
  errBox.textContent = msg;
}
function hideError(){
  errBox.style.display = "none";
  errBox.textContent = "";
}

function sortUnits(arr){
  const mode = sortSelect.value;
  const a = [...arr];
  if(mode==="latest"){
    a.sort((x,y)=> String(y.lastUpdated||"").localeCompare(String(x.lastUpdated||"")));
  }else if(mode==="price_desc"){
    a.sort((x,y)=> toNumber(y.price)-toNumber(x.price));
  }else if(mode==="price_asc"){
    a.sort((x,y)=> toNumber(x.price)-toNumber(y.price));
  }else if(mode==="plot_asc"){
    a.sort((x,y)=> String(x.plot||"").localeCompare(String(y.plot||"")));
  }
  return a;
}

function renderGrid(){
  const list = (FILTER_PLOT==="ALL")
    ? ALL
    : ALL.filter(u => String(u.plot||"").trim() === FILTER_PLOT);

  countText.textContent = `${list.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

  const sorted = sortUnits(list);

  grid.innerHTML = "";
  if(!sorted.length){
    grid.innerHTML = `<div class="card" style="padding:18px; border-radius:18px;">
      <b>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b><div class="muted">‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Plot ‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
    </div>`;
    return;
  }

  const frag = document.createDocumentFragment();
  for(const u of sorted){
    const img = cleanDriveImage(u.thumbnail) || firstImageFromList(u.imageList) || "";
    const card = document.createElement("div");
    card.className = "card";

    const imgEl = document.createElement("img");
    imgEl.className = "thumb";
    imgEl.loading = "lazy";
    imgEl.decoding = "async";
    imgEl.alt = u.id || "no image";
    imgEl.src = img || "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='450'><rect width='100%' height='100%' fill='#e6edf6'/><text x='50%' y='50%' text-anchor='middle' fill='#8aa0bb' font-size='32' font-family='Arial'>no image</text></svg>`);

    const body = document.createElement("div");
    body.className = "cardBody";
    body.innerHTML = `
      <div class="row1">
        <div class="hp">${u.id||""}</div>
        <div class="price">${moneyTHB(u.price||0)}</div>
      </div>
      <div class="iconsRow">
        <div class="miniPill">üõèÔ∏è ${u.bedrooms||"-"}</div>
        <div class="miniPill">üöø ${u.bathrooms||"-"}</div>
        <div class="miniPill">üìê ${u.livingSqm||"-"} m¬≤</div>
      </div>
      <button class="btnDetail">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
    `;

    body.querySelector(".btnDetail").addEventListener("click", () => {
      window.location.href = `details.html?id=${encodeURIComponent(u.id)}&project=${encodeURIComponent(PROJECT)}`;
    });

    card.appendChild(imgEl);
    card.appendChild(body);
    frag.appendChild(card);
  }
  grid.appendChild(frag);
}

/** Plot List Modal */
function renderPlotModal(){
  const items = [];

  // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° Plot ‡∏à‡∏≤‡∏Å Project_0 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  const plots = new Map();
  for(const u of ALL){
    const plot = String(u.plot||"").trim() || "-";
    if(!plots.has(plot)) plots.set(plot, u);
  }

  // ALL item
  items.push({
    plot:"ALL",
    unit:null
  });

  const sortedPlots = [...plots.keys()].sort((a,b)=>a.localeCompare(b));
  for(const p of sortedPlots){
    items.push({ plot:p, unit: plots.get(p) });
  }

  plotList.innerHTML = "";
  for(const it of items){
    const div = document.createElement("div");
    div.className = "plotItem";
    if(it.plot==="ALL"){
      div.innerHTML = `
        <div class="plotLeft">
          <div class="plot">ALL</div>
          <div class="mini"><span class="muted">${ALL.length} units</span> <span class="muted">Project_0</span></div>
        </div>
        <div class="badge">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
      `;
    }else{
      const u = it.unit || {};
      const status = String(u.status||"").toLowerCase().includes("sold") ? "sold" : "";
      const badgeText = u.status ? String(u.status) : "Available";
      div.innerHTML = `
        <div class="plotLeft">
          <div class="plot">${it.plot}</div>
          <div class="mini">
            <span>üõèÔ∏è ${u.bedrooms||"-"} Bed</span>
            <span>üöø ${u.bathrooms||"-"} Bath</span>
            <span>üè† ${u.livingSqm||"-"} m¬≤</span>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:1000; font-size:18px;">${moneyTHB(u.price||0)}</div>
          <div class="badge ${status}">${badgeText}</div>
        </div>
      `;
    }

    div.addEventListener("click", ()=>{
      FILTER_PLOT = it.plot;
      closePlotModal();
      renderGrid();
    });

    plotList.appendChild(div);
  }
}

/** Skeleton */
function renderSkeleton(){
  grid.innerHTML = "";
  for(let i=0;i<6;i++){
    const s = document.createElement("div");
    s.className = "card";
    s.innerHTML = `
      <div class="thumb skeleton"></div>
      <div class="cardBody">
        <div class="row1"><div class="hp skeleton" style="width:120px;height:22px;border-radius:10px;"></div>
        <div class="price skeleton" style="width:120px;height:22px;border-radius:10px;"></div></div>
        <div class="iconsRow">
          <div class="miniPill skeleton" style="height:40px;"></div>
          <div class="miniPill skeleton" style="height:40px;"></div>
          <div class="miniPill skeleton" style="height:40px;"></div>
        </div>
        <div class="btnDetail skeleton" style="height:46px;"></div>
      </div>
    `;
    grid.appendChild(s);
  }
}

/** =========================
 * Data Load (‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô + cache)
 * ========================= */
let _cache = null;
let _cacheTime = 0;

async function loadUnits(force=false){
  hideError();
  renderSkeleton();

  const now = Date.now();
  if(!force && _cache && (now - _cacheTime) < 60_000){
    ALL = _cache;
    renderGrid();
    renderPlotModal();
    return;
  }

  const url = `${SCRIPT_URL}?mode=getUnitList&project=${encodeURIComponent(PROJECT)}`;
  const data = await jsonp(url).catch(err=>{
    throw new Error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à Deploy Apps Script ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Anyone ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ /exec) : " + err.message);
  });

  if(data && data.error){
    throw new Error(String(data.error));
  }
  if(!Array.isArray(data)) throw new Error("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

  // normalize
  ALL = data.map(u => ({
    ...u,
    thumbnail: cleanDriveImage(u.thumbnail),
    imageList: String(u.imageList||"")
  }));

  _cache = ALL;
  _cacheTime = now;

  renderGrid();
  renderPlotModal();
}

document.getElementById("btnLoad").addEventListener("click", ()=>loadUnits(true));
sortSelect.addEventListener("change", renderGrid);

/** Auto load on start */
loadUnits(false).catch(err=>showError(err.message));
</script>
</body>
</html>
